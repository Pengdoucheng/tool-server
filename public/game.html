<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>時間感知小測驗 · 自律控肉飯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --accent-red: #ef4444;
      --accent-red-dark: #b91c1c;
      --bg-main: #f3f4f6;
      --bg-panel: #ffffff;
      --bg-panel-soft: #f9fafb;
      --border-soft: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --card-radius: 18px;
      --shadow-strong: 0 18px 40px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans TC",
        "PingFang TC", "Microsoft JhengHei", sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px 12px;
    }

    .page {
      width: 100%;
      max-width: 1040px;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 18px;
      align-items: stretch;
    }

    @media (max-width: 880px) {
      .page {
        grid-template-columns: minmax(0, 1fr);
      }
      body {
        align-items: flex-start;
      }
    }

    /* 左側：測驗主卡片（白底簡約） */
    .card-main {
      background: var(--bg-panel);
      border-radius: var(--card-radius);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-strong);
      border: 1px solid var(--border-soft);
      position: relative;
      overflow: hidden;
    }

    .card-main::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(239, 68, 68, 0.09), transparent 55%);
      pointer-events: none;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      position: relative;
      z-index: 1;
      margin-bottom: 8px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, #fee2e2, #ef4444);
      position: relative;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.6);
    }

    .logo-mark::after {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 8px;
      border: 1px solid rgba(248, 250, 252, 0.8);
      background: #ffffff;
    }

    .logo-text-main {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-main);
    }

    .logo-text-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(239, 68, 68, 0.35);
      background: #fff;
      font-size: 11px;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-red);
    }

    .hero {
      position: relative;
      z-index: 1;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .hero-kicker {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent-red-dark);
      margin-bottom: 4px;
    }

    .hero-title {
      font-size: 22px;
      font-weight: 700;
      margin: 0 0 6px;
      color: var(--text-main);
    }

    .hero-sub {
      font-size: 13px;
      color: var(--text-sub);
      margin: 0;
      max-width: 480px;
      line-height: 1.7;
    }

    .hero-sub strong {
      color: var(--accent-red-dark);
      font-weight: 600;
    }

    .main-layout {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 10px;
      margin-top: 10px;
      align-items: center;
    }

    @media (max-width: 640px) {
      .main-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* 圓形區：開始前完全沒有圈圈，只有文字；開始後才有紅圈＋白底 */
    .time-circle-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 6px 0 4px;
    }

    .time-circle {
      --progress: 0deg;
      width: 220px;
      height: 220px;
      border-radius: 999px;
      /* 預設：沒有圈圈、沒有底色、不明顯的容器 */
      background: transparent;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .time-circle::after {
      content: "";
      position: absolute;
      inset: 14px;
      border-radius: 999px;
      background: transparent;
    }

    /* 開始後才啟用的紅色進度圈 + 卡片感 */
    .time-circle.active {
      background:
        conic-gradient(from 270deg, var(--accent-red) var(--progress), #e5e7eb var(--progress));
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
    }

    .time-circle.active::after {
      background: radial-gradient(circle at 30% 20%, #fef2f2, #ffffff);
    }

    .time-circle.active.blind {
      background: #e5e7eb;
    }

    .time-circle.active.blind::after {
      background: #ffffff;
    }

    .time-circle-inner {
      position: relative;
      width: 172px;
      height: 172px;
      border-radius: 999px;
      /* 預設：只有文字，沒有邊線、沒有底色 */
      background: transparent;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px;
    }

    .time-circle-inner.active {
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }

    .target-label {
      font-size: 11px;
      color: var(--text-sub);
    }

    .target-value {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 0.14em;
      color: var(--text-main);
    }

    .elapsed-label {
      font-size: 10px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .elapsed-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-main);
      min-height: 1.4em;
    }

    .state-label {
      font-size: 11px;
      color: var(--accent-red-dark);
      margin-top: 2px;
    }

    .hint-text {
      font-size: 10px;
      color: var(--text-sub);
      text-align: center;
      max-width: 180px;
      line-height: 1.7;
      margin-top: 2px;
    }

    /* 操作區 */
    .control-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field {
      margin-bottom: 2px;
    }

    .field label {
      font-size: 11px;
      color: var(--text-sub);
      display: block;
      margin-bottom: 4px;
    }

    .mode-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border-soft);
      background: var(--bg-panel-soft);
      font-size: 11px;
      color: var(--text-sub);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: border-color 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease, color 0.12s ease, transform 0.04s ease;
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-red);
      opacity: 0;
    }

    .chip.active {
      border-color: rgba(239, 68, 68, 0.9);
      color: var(--text-main);
      background: #ffffff;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
      transform: translateY(-1px);
    }

    .chip.active .chip-dot {
      opacity: 1;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease,
        border-color 0.08s ease, color 0.08s ease, opacity 0.12s ease;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-main {
      background: var(--accent-red);
      color: #ffffff;
      box-shadow: 0 10px 24px rgba(239, 68, 68, 0.35);
      border: 1px solid rgba(248, 113, 113, 0.9);
    }

    .btn-main-dot {
      width: 13px;
      height: 13px;
      border-radius: 999px;
      background: #fee2e2;
    }

    .btn-ghost {
      background: #ffffff;
      color: var(--text-sub);
      border: 1px solid var(--border-soft);
    }

    .btn-ghost.danger {
      color: var(--accent-red-dark);
      border-color: rgba(239, 68, 68, 0.7);
      background: #fff;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .tips {
      font-size: 10px;
      color: var(--text-sub);
      margin-top: 4px;
      line-height: 1.7;
    }

    .tips strong {
      color: var(--accent-red-dark);
      font-weight: 600;
    }

    .result-box {
      margin-top: 4px;
      font-size: 12px;
      line-height: 1.7;
    }

    .result-main {
      font-weight: 600;
      color: var(--text-main);
    }

    .result-detail {
      font-size: 11px;
      color: var(--text-sub);
    }

    .result-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(239, 68, 68, 0.06);
      border: 1px solid rgba(239, 68, 68, 0.7);
      color: var(--accent-red-dark);
      font-size: 10px;
      margin-left: 4px;
    }

    /* 右側：歷史與統計（白底） */
    .side-card {
      background: var(--bg-panel);
      border-radius: var(--card-radius);
      padding: 14px 14px 10px;
      box-shadow: var(--shadow-strong);
      border: 1px solid var(--border-soft);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .side-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--text-main);
    }

    .side-title {
      font-weight: 600;
    }

    .badge-soft {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 10px;
      color: var(--text-main);
      background: var(--bg-panel-soft);
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      font-size: 11px;
      color: var(--text-main);
      margin-top: 4px;
    }

    .stat-label {
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
    }

    .stat-sub {
      font-size: 10px;
      color: #9ca3af;
    }

    .history-list {
      margin: 4px 0 0;
      padding: 0;
      list-style: none;
      max-height: 180px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      border-bottom: 1px dashed #e5e7eb;
      font-size: 11px;
      color: var(--text-main);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-line {
      font-size: 11px;
    }

    .history-meta {
      font-size: 10px;
      color: var(--text-sub);
    }

    .history-error {
      font-size: 11px;
      color: var(--accent-red-dark);
      white-space: nowrap;
    }

    .history-empty {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .side-footer {
      margin-top: 2px;
      font-size: 10px;
      color: #9ca3af;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- 左側：測驗主卡片 -->
    <section class="card-main" aria-label="時間感知小測驗">
      <header class="topbar">
        <div class="logo">
          <div class="logo-mark"></div>
          <div>
            <div class="logo-text-main">ZILV · TIME SENSE</div>
            <div class="logo-text-sub">自律控肉飯 · 時間感知小測驗</div>
          </div>
        </div>
        <div class="pill">
          <span class="pill-dot"></span>
          <span>紅 · 白 · 簡約專注</span>
        </div>
      </header>

      <div class="hero">
        <div class="hero-kicker">TIME PERCEPTION TEST</div>
        <h1 class="hero-title">你覺得 10 秒，其實是多久？</h1>
        <p class="hero-sub">
          自律不只是在行程表上排滿，而是<strong>大腦對時間有沒有概念</strong>。
          這個小測驗會先讓你看 3 秒讀秒，之後關掉讀條，只靠感覺按下按鈕。
        </p>
      </div>

      <div class="main-layout">
        <!-- 圓形顯示區（開始前只有文字） -->
        <div class="time-circle-wrap">
          <div class="time-circle" id="timeCircle" style="--progress: 0deg;">
            <div class="time-circle-inner" id="timeCircleInner">
              <div class="target-label">目標秒數</div>
              <div class="target-value" id="targetValue">10s</div>
              <div class="elapsed-label" id="elapsedLabel">經過時間（前 3 秒可見）</div>
              <div class="elapsed-value" id="elapsedValue">0.0s</div>
              <div class="state-label" id="stateLabel">尚未開始</div>
              <p class="hint-text" id="hintText">
                按下「開始測驗」後，前 3 秒會顯示讀秒。3 秒之後讀條會消失，只能靠感覺，在你覺得時間到了時按「我覺得到了」。
              </p>
            </div>
          </div>
        </div>

        <!-- 右側操作區 -->
        <div class="control-panel">
          <div class="field">
            <label>選擇這一輪要測試的秒數</label>
            <div class="mode-row">
              <button class="chip active" data-seconds="10">
                <span class="chip-dot"></span> 10 秒 · 日常專注
              </button>
              <button class="chip" data-seconds="20">
                <span class="chip-dot"></span> 20 秒 · 任務啟動
              </button>
              <button class="chip" data-seconds="30">
                <span class="chip-dot"></span> 30 秒 · 深呼吸暖身
              </button>
            </div>
          </div>

          <div class="field">
            <label>操作</label>
            <div class="btn-row">
              <button class="btn btn-main" id="btnStart">
                <span class="btn-main-dot"></span>
                開始測驗
              </button>
              <button class="btn btn-ghost" id="btnStop" disabled>
                我覺得到了
              </button>
              <button class="btn btn-ghost danger" id="btnReset">
                重置這一輪
              </button>
            </div>
          </div>

          <p class="tips">
            建議：開始後可以搭配<strong>吸氣 4 秒、吐氣 6 秒</strong>，
            前 3 秒看著時間，之後閉上眼睛或看遠方，感覺一下「體感 10 秒」長什麼樣子。
          </p>

          <div class="result-box" id="resultBox" style="display:none;">
            <div class="result-main" id="resultMain"></div>
            <div class="result-detail" id="resultDetail"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 右側：歷史與統計 -->
    <aside class="side-card" aria-label="時間感知歷史與統計">
      <div class="side-header">
        <div>
          <div class="side-title">你的時間感知紀錄</div>
          <div style="font-size:11px;color:#6b7280;">僅儲存在本機，不會上傳伺服器。</div>
        </div>
        <button id="btnClearHistory" class="btn btn-ghost danger" style="font-size:10px;padding:4px 8px;">
          清空紀錄
        </button>
      </div>

      <div class="stat-grid">
        <div>
          <div class="stat-label">已完成測驗次數</div>
          <div class="stat-value" id="statCount">0</div>
          <div class="stat-sub">至少做 5 次，再看趨勢比較準。</div>
        </div>
        <div>
          <div class="stat-label">平均誤差（絕對值）</div>
          <div class="stat-value" id="statAvgError">0.0s</div>
          <div class="stat-sub">越接近 0 代表時間感越穩定</div>
        </div>
      </div>

      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
          <span style="font-size:12px;color:#111827;">最近測驗紀錄</span>
          <span class="badge-soft" id="badgeTrend">趨勢：尚未形成</span>
        </div>
        <ul class="history-list" id="historyList">
          <li class="history-empty">還沒有任何紀錄，先玩一輪看看你的時間感。</li>
        </ul>
      </div>

      <div class="side-footer">
        小遊戲：把「感覺時間」從模糊，變成你可以觀察和訓練的東西。
      </div>
    </aside>
  </div>

  <script>
    const STORAGE_KEY = "zilv_time_sense_v2";
    const CALIBRATION_SECONDS = 3;

    let targetSeconds = 10;
    let startTime = null;
    let running = false;
    let passedCalibration = false;

    const targetValueEl = document.getElementById("targetValue");
    const stateLabelEl = document.getElementById("stateLabel");
    const hintTextEl = document.getElementById("hintText");
    const timeCircleEl = document.getElementById("timeCircle");
    const timeCircleInnerEl = document.getElementById("timeCircleInner");
    const elapsedValueEl = document.getElementById("elapsedValue");
    const elapsedLabelEl = document.getElementById("elapsedLabel");

    const resultBoxEl = document.getElementById("resultBox");
    const resultMainEl = document.getElementById("resultMain");
    const resultDetailEl = document.getElementById("resultDetail");

    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const btnReset = document.getElementById("btnReset");
    const btnClearHistory = document.getElementById("btnClearHistory");

    const statCountEl = document.getElementById("statCount");
    const statAvgErrorEl = document.getElementById("statAvgError");
    const historyListEl = document.getElementById("historyList");
    const badgeTrendEl = document.getElementById("badgeTrend");

    function loadHistory() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { entries: [] };
        return JSON.parse(raw);
      } catch (e) {
        console.error("loadHistory error", e);
        return { entries: [] };
      }
    }

    function saveHistory(history) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }

    function addHistoryEntry(entry) {
      const history = loadHistory();
      history.entries.unshift(entry);
      if (history.entries.length > 20) {
        history.entries = history.entries.slice(0, 20);
      }
      saveHistory(history);
      renderHistory();
    }

    function renderHistory() {
      const history = loadHistory();
      const items = history.entries;
      historyListEl.innerHTML = "";

      if (!items.length) {
        const li = document.createElement("li");
        li.className = "history-empty";
        li.textContent = "還沒有任何紀錄，先玩一輪看看你的時間感。";
        historyListEl.appendChild(li);
        statCountEl.textContent = "0";
        statAvgErrorEl.textContent = "0.0s";
        badgeTrendEl.textContent = "趨勢：尚未形成";
        return;
      }

      statCountEl.textContent = items.length.toString();

      let sumAbsError = 0;
      items.forEach((e) => {
        sumAbsError += Math.abs(e.diffSeconds);
      });
      const avgAbs = sumAbsError / items.length;
      statAvgErrorEl.textContent = avgAbs.toFixed(1) + "s";

      if (avgAbs <= 1) {
        badgeTrendEl.textContent = "趨勢：時間感偏穩定";
      } else if (avgAbs <= 3) {
        badgeTrendEl.textContent = "趨勢：時間感略有偏差";
      } else {
        badgeTrendEl.textContent = "趨勢：時間感很 freestyle";
      }

      items.forEach((e) => {
        const li = document.createElement("li");
        li.className = "history-item";

        const main = document.createElement("div");
        main.className = "history-main";

        const line = document.createElement("div");
        line.className = "history-line";
        const diff = e.diffSeconds;
        const sign = diff > 0 ? "+" : "";
        const tendency =
          diff > 0 ? "偏慢" : diff < 0 ? "偏快" : "剛好";

        line.textContent =
          "目標 " +
          e.targetSeconds +
          " 秒 → 實際 " +
          e.actualSeconds.toFixed(1) +
          " 秒";

        const meta = document.createElement("div");
        meta.className = "history-meta";

        const date = new Date(e.timestamp);
        const timeStr = date.toLocaleTimeString("zh-TW", {
          hour: "2-digit",
          minute: "2-digit",
        });

        meta.textContent =
          timeStr +
          " · 誤差 " +
          sign +
          diff.toFixed(1) +
          " 秒 · " +
          tendency;

        main.appendChild(line);
        main.appendChild(meta);

        const badge = document.createElement("div");
        badge.className = "history-error";
        badge.textContent =
          (sign + diff.toFixed(1) + "s").padStart(6, " ");

        li.appendChild(main);
        li.appendChild(badge);
        historyListEl.appendChild(li);
      });
    }

    function selectTarget(seconds) {
      targetSeconds = seconds;
      targetValueEl.textContent = seconds + "s";

      document.querySelectorAll(".chip").forEach((chip) => {
        const s = Number(chip.dataset.seconds);
        chip.classList.toggle("active", s === seconds);
      });

      if (!running) {
        stateLabelEl.textContent = "尚未開始";
        hintTextEl.textContent =
          "按下「開始測驗」後，前 3 秒會顯示讀秒。3 秒之後讀條會消失，只能靠感覺，在你覺得時間到了時按「我覺得到了」。";
        elapsedLabelEl.textContent = "經過時間（前 3 秒可見）";
        elapsedValueEl.textContent = "0.0s";
        timeCircleEl.style.setProperty("--progress", "0deg");
        timeCircleEl.classList.remove("blind");
        timeCircleEl.classList.remove("active");
        timeCircleInnerEl.classList.remove("active");
      }
    }

    function startTest() {
      if (running) return;
      running = true;
      passedCalibration = false;
      startTime = performance.now();
      resultBoxEl.style.display = "none";

      stateLabelEl.textContent = "校正中 · 可以看時間";
      hintTextEl.textContent =
        "前 " +
        CALIBRATION_SECONDS +
        " 秒可以看著秒數走，感覺一下節奏。3 秒後讀條就會消失，只能靠感覺。";
      elapsedLabelEl.textContent = "經過時間";

      btnStart.disabled = true;
      btnStop.disabled = false;
      timeCircleEl.classList.remove("blind");
      timeCircleEl.classList.add("active");        // 顯示紅圈與卡片
      timeCircleInnerEl.classList.add("active");   // 顯示白底與邊線

      let frameId;
      function tick() {
        if (!running || startTime == null) {
          cancelAnimationFrame(frameId);
          return;
        }
        const now = performance.now();
        const elapsedSeconds = (now - startTime) / 1000;

        if (elapsedSeconds <= CALIBRATION_SECONDS) {
          // 校正階段：顯示實際時間 + 讀條
          const ratio = Math.min(elapsedSeconds / CALIBRATION_SECONDS, 1);
          const progressDeg = 360 * ratio;
          timeCircleEl.style.setProperty("--progress", progressDeg + "deg");
          elapsedValueEl.textContent = elapsedSeconds.toFixed(1) + "s";
        } else {
          if (!passedCalibration) {
            // 剛進入盲測階段時切換一次
            passedCalibration = true;
            stateLabelEl.textContent = "盲測階段 · 靠感覺";
            hintTextEl.textContent =
              "現在讀條已關閉，只靠你對時間的感覺。覺得到達 " +
              targetSeconds +
              " 秒時，按下「我覺得到了」。";
            elapsedLabelEl.textContent = "經過時間（已隱藏）";
            elapsedValueEl.textContent = "??.?s";
            timeCircleEl.classList.add("blind");
          }
        }

        frameId = requestAnimationFrame(tick);
      }
      frameId = requestAnimationFrame(tick);
    }

    function stopTest() {
      if (!running || startTime == null) return;
      running = false;

      const endTime = performance.now();
      const elapsedSeconds = (endTime - startTime) / 1000;
      const diff = elapsedSeconds - targetSeconds;
      const sign = diff > 0 ? "+" : "";
      const absDiff = Math.abs(diff);
      const tendency =
        diff > 0
          ? "偏慢（你的體感時間走得比較慢）"
          : diff < 0
          ? "偏快（你的體感時間走得比較快）"
          : "完全準時";

      // 顯示結果
      stateLabelEl.textContent = "這一輪的結果";
      hintTextEl.textContent =
        "你可以再多測幾次，觀察自己是偏快派還是偏慢派，之後在排程時可以稍微修正自己對時間的預估。";
      elapsedLabelEl.textContent = "實際經過時間";
      elapsedValueEl.textContent = elapsedSeconds.toFixed(1) + "s";

      // 顯示完整讀條（依照實際時間比例）
      timeCircleEl.classList.remove("blind");
      timeCircleEl.classList.add("active");
      timeCircleInnerEl.classList.add("active");
      const ratio = Math.min(elapsedSeconds / targetSeconds, 1.6);
      const progressDeg = 360 * ratio;
      timeCircleEl.style.setProperty("--progress", progressDeg + "deg");

      resultMainEl.textContent =
        "你覺得的「" +
        targetSeconds +
        " 秒」，實際是 " +
        elapsedSeconds.toFixed(1) +
        " 秒。";

      resultDetailEl.innerHTML =
        "誤差 " +
        sign +
        diff.toFixed(1) +
        " 秒，屬於「" +
        tendency +
        "」。" +
        (absDiff <= 1
          ? '<span class="result-tag">時間感很穩定</span>'
          : absDiff <= 3
          ? '<span class="result-tag">再練練就會更準</span>'
          : '<span class="result-tag">很 freestyle，但這就是練習的開始</span>');

      resultBoxEl.style.display = "block";

      btnStart.disabled = false;
      btnStop.disabled = true;

      addHistoryEntry({
        targetSeconds,
        actualSeconds: elapsedSeconds,
        diffSeconds: diff,
        timestamp: new Date().toISOString(),
      });
    }

    function resetTest() {
      running = false;
      passedCalibration = false;
      startTime = null;
      btnStart.disabled = false;
      btnStop.disabled = true;
      stateLabelEl.textContent = "尚未開始";
      hintTextEl.textContent =
        "按下「開始測驗」後，前 3 秒會顯示讀秒。3 秒之後讀條會消失，只能靠感覺，在你覺得時間到了時按「我覺得到了」。";
      elapsedLabelEl.textContent = "經過時間（前 3 秒可見）";
      elapsedValueEl.textContent = "0.0s";
      timeCircleEl.style.setProperty("--progress", "0deg");
      timeCircleEl.classList.remove("blind");
      timeCircleEl.classList.remove("active");
      timeCircleInnerEl.classList.remove("active");
      resultBoxEl.style.display = "none";
    }

    function clearHistory() {
      if (!confirm("確定要清空所有時間感知紀錄嗎？")) return;
      localStorage.removeItem(STORAGE_KEY);
      renderHistory();
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".chip").forEach((chip) => {
        chip.addEventListener("click", () => {
          const seconds = Number(chip.dataset.seconds);
          selectTarget(seconds);
        });
      });

      btnStart.addEventListener("click", startTest);
      btnStop.addEventListener("click", stopTest);
      btnReset.addEventListener("click", resetTest);
      btnClearHistory.addEventListener("click", clearHistory);

      selectTarget(10);
      renderHistory();
    });

    // 空白鍵也可以開始 / 停止
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space") {
        e.preventDefault();
        if (!running) {
          startTest();
        } else {
          stopTest();
        }
      }
    });
  </script>
</body>
</html>



