<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>自律控肉飯 · 日程行事曆</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --red: #ff4b4b;
      --red-dark: #b91c1c;
      --black: #111827;
      --text: #111827;
      --sub: #6b7280;
      --border: #e5e7eb;
      --bg: #ffffff;
      --bg-soft: #f9fafb;
      --radius-card: 18px;
      --shadow-soft: 0 22px 45px rgba(15, 23, 42, 0.12);
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans TC",
        "PingFang TC", "Microsoft JhengHei", sans-serif;
    }

    * {
      box-sizing: border-box;
      font-family: var(--font);
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
    }

    .page {
      max-width: 1180px;
      margin: 0 auto;
      padding: 20px 16px 32px;
    }

    /* 頂部導覽列 */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 26px;
      height: 26px;
      border-radius: 10px;
      background: linear-gradient(135deg, #111827, var(--red));
      position: relative;
      box-shadow: 0 0 14px rgba(248, 113, 113, 0.9);
      overflow: hidden;
    }

    .logo-mark::after {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 8px;
      border: 1px solid rgba(249, 250, 251, 0.8);
    }

    .logo-main {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .logo-sub {
      font-size: 11px;
      color: var(--sub);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg-soft);
      color: var(--sub);
      white-space: nowrap;
    }

    .account-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
    }

    .account-avatar {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      background: #111827;
      color: #f9fafb;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .account-text-main {
      font-size: 12px;
      font-weight: 500;
    }

    .account-text-sub {
      font-size: 11px;
      color: var(--sub);
    }

    /* Hero / 說明區 */
    .hero {
      margin-bottom: 18px;
    }

    .hero-kicker {
      font-size: 11px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--red-dark);
      margin-bottom: 4px;
    }

    .hero-title {
      margin: 0 0 4px;
      font-size: 24px;
      font-weight: 700;
    }

    .hero-sub {
      margin: 0;
      font-size: 13px;
      color: var(--sub);
      max-width: 620px;
      line-height: 1.7;
    }

    /* 模式切換：個人 / 團隊 */
    .mode-toggle {
      margin-top: 14px;
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg-soft);
      gap: 4px;
    }

    .mode-btn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: var(--sub);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .mode-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--border);
    }

    .mode-btn.active {
      background: #111827;
      color: #f9fafb;
      font-weight: 600;
    }

    .mode-btn.active .mode-dot {
      background: var(--red);
    }

    /* 主體 layout */
    .layout {
      margin-top: 18px;
      display: grid;
      grid-template-columns: minmax(0, 260px) minmax(0, 1fr);
      gap: 16px;
    }

    @media (max-width: 880px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* 左側 side panel：成員 & 檢視設定 */
    .side-card {
      background: #ffffff;
      border-radius: var(--radius-card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px;
    }

    .side-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .side-sub {
      font-size: 12px;
      color: var(--sub);
      margin-bottom: 10px;
    }

    .side-section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--sub);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin: 10px 0 6px;
    }

    .member-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 4px;
      max-height: 180px;
      overflow-y: auto;
    }

    .member-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 6px;
      border-radius: 10px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background 0.12s ease, border-color 0.12s ease;
    }

    .member-item:hover {
      background: var(--bg-soft);
      border-color: var(--border);
    }

    .member-left {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .member-avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: #ffffff;
      background: #111827;
    }

    .member-name {
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 140px;
    }

    .member-tag {
      font-size: 10px;
      color: var(--sub);
    }

    .member-check {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--sub);
      background: #ffffff;
    }

    .member-item.active .member-check {
      border-color: var(--red);
      background: #fef2f2;
      color: var(--red-dark);
    }

    .member-item.active .member-avatar {
      background: var(--red-dark);
    }

    .new-member-row {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .new-member-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 5px 9px;
      font-size: 12px;
    }

    .new-member-btn {
      border-radius: 999px;
      border: 1px solid var(--black);
      background: #111827;
      color: #f9fafb;
      font-size: 11px;
      padding: 5px 10px;
      cursor: pointer;
    }

    .side-note {
      margin-top: 6px;
      font-size: 10px;
      color: var(--sub);
      text-align: right;
    }

    .filter-rows {
      margin-top: 4px;
      display: grid;
      gap: 4px;
    }

    .filter-row {
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .filter-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .filter-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--border);
    }

    .filter-dot-me {
      background: var(--black);
    }

    .filter-dot-team {
      background: var(--red);
    }

    .toggle-switch {
      position: relative;
      width: 32px;
      height: 16px;
      border-radius: 999px;
      background: var(--bg-soft);
      border: 1px solid var(--border);
      cursor: pointer;
    }

    .toggle-knob {
      position: absolute;
      top: 1px;
      left: 1px;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #ffffff;
      transition: transform 0.16s ease;
    }

    .toggle-switch.on {
      background: #111827;
      border-color: #111827;
    }

    .toggle-switch.on .toggle-knob {
      transform: translateX(14px);
    }

    /* 右側：行事曆卡片 */
    .calendar-card {
      background: #ffffff;
      border-radius: var(--radius-card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 12px 14px 14px;
      display: flex;
      flex-direction: column;
      min-height: 460px;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .calendar-header-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .calendar-title {
      font-size: 16px;
      font-weight: 600;
    }

    .calendar-sub {
      font-size: 11px;
      color: var(--sub);
    }

    .calendar-nav {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .calendar-nav-btn {
      border: none;
      background: #ffffff;
      padding: 6px 9px;
      font-size: 11px;
      cursor: pointer;
      border-right: 1px solid var(--border);
    }

    .calendar-nav-btn:last-child {
      border-right: none;
    }

    .calendar-nav-btn.primary {
      background: #111827;
      color: #f9fafb;
      font-weight: 600;
    }

    .calendar-nav-btn span {
      font-size: 12px;
    }

    /* 行事曆 Grid */
    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      margin-top: 8px;
      border-bottom: 1px solid var(--border);
    }

    .weekday-cell {
      padding: 4px 2px 6px;
      text-align: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--sub);
    }

    .calendar-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      grid-auto-rows: 90px;
      gap: 1px;
      margin-top: 1px;
      background: var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .day-cell {
      background: #ffffff;
      padding: 4px 4px 4px;
      display: flex;
      flex-direction: column;
      border-radius: 0;
    }

    .day-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .day-number {
      font-size: 12px;
      font-weight: 600;
    }

    .day-number.other-month {
      color: #d4d4d8;
      font-weight: 400;
    }

    .day-badge {
      font-size: 10px;
      padding: 1px 5px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--sub);
    }

    .day-badge-today {
      border-color: var(--red-dark);
      color: var(--red-dark);
      font-weight: 600;
    }

    .events-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow: hidden;
    }

    .event-pill {
      border-radius: 6px;
      padding: 2px 4px;
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border: 1px solid transparent;
    }

    .event-me {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    .event-team {
      background: #fef2f2;
      color: var(--red-dark);
      border-color: #fecaca;
    }

    .event-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #ffffff;
    }

    .event-me .event-dot {
      background: var(--red);
    }

    .event-team .event-dot {
      background: var(--red-dark);
    }

    .event-empty {
      font-size: 10px;
      color: #d4d4d8;
      margin-top: 2px;
    }

    /* 新增行程輸入列 */
    .event-add-row {
      margin-top: 2px;
      display: flex;
      gap: 2px;
    }

    .event-add-input {
      flex: 1;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 10px;
      padding: 2px 4px;
    }

    .event-add-btn {
      border-radius: 6px;
      border: 1px solid var(--black);
      background: #111827;
      color: #ffffff;
      font-size: 10px;
      padding: 2px 6px;
      cursor: pointer;
    }

    /* 底部說明列 */
    .calendar-footer {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 6px;
      font-size: 11px;
      color: var(--sub);
    }

    .legend-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-box {
      width: 12px;
      height: 12px;
      border-radius: 4px;
    }

    .legend-me {
      background: #111827;
    }

    .legend-team {
      background: #ff4b4b;
    }

    .legend-today {
      background: #ffffff;
      border: 1px solid var(--red-dark);
      box-sizing: border-box;
    }

    .calendar-note {
      text-align: right;
    }

    @media (max-width: 720px) {
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .calendar-card {
        padding: 10px 10px 12px;
      }
      .calendar-grid {
        grid-auto-rows: 80px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- 頂部 -->
    <header class="topbar">
      <div class="logo">
        <div class="logo-mark"></div>
        <div>
          <div class="logo-main">ZILV · CALENDAR</div>
          <div class="logo-sub">自律控肉飯 · 個人 / 團隊日程行事曆</div>
        </div>
      </div>
      <div class="topbar-right">
        <span class="pill">白底 · 紅黑白 · 月視圖</span>
        <!-- 右上角帳戶（接 Supabase） -->
        <div class="account-box">
          <div class="account-avatar" id="accountAvatar">？</div>
          <div>
            <div class="account-text-main" id="accountName">載入中…</div>
            <div class="account-text-sub" id="accountEmail">請先從登入頁登入帳號</div>
          </div>
        </div>
      </div>
    </header>

    <!-- 說明 + 模式切換 -->
    <section class="hero">
      <div class="hero-kicker">TIME · DISCIPLINE</div>
      <h1 class="hero-title">把一整個月的節奏排在白紙上。</h1>
      <p class="hero-sub">
        這裡是以「月」為主的日程行事曆。個人版可以看自己的節奏；團隊版可以把成員加進來，一起協調時間。
        保持界面乾淨，用顏色只標記重要的事。
      </p>

      <div class="mode-toggle" id="modeToggle">
        <button class="mode-btn active" data-mode="personal">
          <span class="mode-dot"></span>
          個人日程
        </button>
        <button class="mode-btn" data-mode="team">
          <span class="mode-dot"></span>
          團隊日程
        </button>
      </div>
    </section>

    <!-- 主體 layout -->
    <div class="layout">
      <!-- 左側：成員 / 檢視設定 -->
      <aside class="side-card">
        <div class="side-title">成員與檢視設定</div>
        <div class="side-sub">預設是「只看自己」，切換到團隊模式後可以將行程標記為團隊行程。</div>

        <div class="side-section-title">目前模式</div>
        <div class="filter-rows">
          <div class="filter-row">
            <span class="filter-label">
              <span class="filter-dot filter-dot-me"></span>
              <span>顯示我的行程</span>
            </span>
            <div class="toggle-switch on" data-key="showMe">
              <div class="toggle-knob"></div>
            </div>
          </div>
          <div class="filter-row">
            <span class="filter-label">
              <span class="filter-dot filter-dot-team"></span>
              <span>顯示團隊行程</span>
            </span>
            <div class="toggle-switch" data-key="showTeam">
              <div class="toggle-knob"></div>
            </div>
          </div>
        </div>

        <div class="side-section-title">團隊成員（展示用）</div>
        <ul class="member-list" id="memberList"></ul>

        <div class="new-member-row">
          <input
            id="newMemberInput"
            class="new-member-input"
            type="text"
            placeholder="輸入成員名稱（純展示）"
          />
          <button id="addMemberBtn" class="new-member-btn">+ 新增</button>
        </div>

        <div class="side-note">
          現在的行程資料只綁定當前登入帳號。之後可擴充成真正多人共用的團隊行事曆。
        </div>
      </aside>

      <!-- 右側：日程行事曆 -->
      <section class="calendar-card">
        <header class="calendar-header">
          <div class="calendar-header-left">
            <div class="calendar-title" id="monthLabel">2025 年 01 月</div>
            <div class="calendar-sub" id="calendarSub">
              點左右箭頭切換月份，在每日格子底下可以直接新增行程。
            </div>
          </div>
          <div class="calendar-nav">
            <button class="calendar-nav-btn" id="prevMonthBtn">
              <span>←</span>
            </button>
            <button class="calendar-nav-btn primary" id="todayBtn">
              本月
            </button>
            <button class="calendar-nav-btn" id="nextMonthBtn">
              <span>→</span>
            </button>
          </div>
        </header>

        <!-- 星期列 -->
        <div class="calendar-weekdays">
          <div class="weekday-cell">Sun</div>
          <div class="weekday-cell">Mon</div>
          <div class="weekday-cell">Tue</div>
          <div class="weekday-cell">Wed</div>
          <div class="weekday-cell">Thu</div>
          <div class="weekday-cell">Fri</div>
          <div class="weekday-cell">Sat</div>
        </div>

        <!-- 行事曆 grid -->
        <div class="calendar-grid" id="calendarGrid"></div>

        <!-- 底部說明 -->
        <div class="calendar-footer">
          <div class="legend-row">
            <span class="legend-item">
              <span class="legend-box legend-me"></span> 我的行程
            </span>
            <span class="legend-item">
              <span class="legend-box legend-team"></span> 團隊行程
            </span>
            <span class="legend-item">
              <span class="legend-box legend-today"></span> 今日
            </span>
          </div>
          <div class="calendar-note">
            目前所有行程都存到 Supabase 的 <code>calendar_events</code>。
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === Supabase 初始化 ===
    const SUPABASE_URL = "https://rbtevdmunkjjevoeooli.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJidGV2ZG11bmtqamV2b2Vvb2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNzMxMjIsImV4cCI6MjA3NTg0OTEyMn0.XjWId9AynP3TrJJEKIXZcsvmAW4kHLgH4dGDGqBH9dw";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentMonth = new Date();
    let monthEvents = []; // 當前月份的所有行程（從 DB 抓）

    const accountNameEl = document.getElementById("accountName");
    const accountEmailEl = document.getElementById("accountEmail");
    const accountAvatarEl = document.getElementById("accountAvatar");

    const modeToggle = document.getElementById("modeToggle");
    const calendarSubEl = document.getElementById("calendarSub");
    const monthLabelEl = document.getElementById("monthLabel");
    const calendarGridEl = document.getElementById("calendarGrid");

    const prevMonthBtn = document.getElementById("prevMonthBtn");
    const nextMonthBtn = document.getElementById("nextMonthBtn");
    const todayBtn = document.getElementById("todayBtn");

    const memberListEl = document.getElementById("memberList");
    const newMemberInput = document.getElementById("newMemberInput");
    const addMemberBtn = document.getElementById("addMemberBtn");

    const filterToggles = document.querySelectorAll(".toggle-switch");

    // 檢視模式：個人 / 團隊
    let viewMode = "personal"; // 'personal' | 'team'

    // 檢視 filter
    const viewFilter = {
      showMe: true,
      showTeam: false,
    };

    // 假的成員清單（目前只影響左側 UI，美感用）
    let members = [
      { id: "m1", name: "我（登入帳號）", role: "ME", active: true },
      { id: "m2", name: "設計組 · 小林", role: "TEAM", active: true },
      { id: "m3", name: "工程組 · 阿豪", role: "TEAM", active: false },
    ];

    function setToFirstOfMonth(date) {
      return new Date(date.getFullYear(), date.getMonth(), 1);
    }

    function formatYearMonth(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      return `${y} 年 ${m} 月`;
    }

    function sameDay(a, b) {
      return (
        a.getFullYear() === b.getFullYear() &&
        a.getMonth() === b.getMonth() &&
        a.getDate() === b.getDate()
      );
    }

    // === 讀取登入使用者，更新右上角帳號顯示 ================================
    async function initAccount() {
      const { data, error } = await sb.auth.getUser();
      currentUser = data?.user || null;

      if (currentUser) {
        const name =
          currentUser.user_metadata?.full_name ||
          (currentUser.email ? currentUser.email.split("@")[0] : "使用者");
        accountNameEl.textContent = name;
        accountEmailEl.textContent = currentUser.email || "";
        accountAvatarEl.textContent = name.charAt(0).toUpperCase();
      } else {
        accountNameEl.textContent = "尚未登入";
        accountEmailEl.textContent = "請先到登入頁登入（例如 supabase-test.html）";
        accountAvatarEl.textContent = "？";
      }
    }

    // === 團隊成員（純 UI，不寫入 DB） =====================================
    function renderMembers() {
      memberListEl.innerHTML = "";
      members.forEach((m) => {
        const li = document.createElement("li");
        li.className = "member-item" + (m.active ? " active" : "");
        li.dataset.id = m.id;

        const left = document.createElement("div");
        left.className = "member-left";

        const avatar = document.createElement("div");
        avatar.className = "member-avatar";
        avatar.textContent = m.name.charAt(0);

        const infoBox = document.createElement("div");
        const nameSpan = document.createElement("div");
        nameSpan.className = "member-name";
        nameSpan.textContent = m.name;

        const tagSpan = document.createElement("div");
        tagSpan.className = "member-tag";
        tagSpan.textContent = m.role === "ME" ? "我的帳號" : "團隊成員";

        infoBox.appendChild(nameSpan);
        infoBox.appendChild(tagSpan);

        left.appendChild(avatar);
        left.appendChild(infoBox);

        const check = document.createElement("div");
        check.className = "member-check";
        check.textContent = m.active ? "顯示中" : "顯示";

        li.appendChild(left);
        li.appendChild(check);

        li.addEventListener("click", () => {
          m.active = !m.active;
          renderMembers();
        });

        memberListEl.appendChild(li);
      });
    }

    addMemberBtn.addEventListener("click", () => {
      const name = (newMemberInput.value || "").trim();
      if (!name) return;
      members.push({
        id: "m" + (members.length + 1),
        name,
        role: "TEAM",
        active: true,
      });
      newMemberInput.value = "";
      renderMembers();
    });

    // === 模式切換：個人 / 團隊 ============================================
    modeToggle.querySelectorAll(".mode-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const mode = btn.dataset.mode;
        if (mode === viewMode) return;
        viewMode = mode;

        // 切換 active 樣式
        modeToggle.querySelectorAll(".mode-btn").forEach((b) => {
          b.classList.toggle("active", b.dataset.mode === viewMode);
        });

        // 調整 team filter 預設
        const showTeamToggle = document.querySelector(
          '.toggle-switch[data-key="showTeam"]'
        );
        if (viewMode === "personal") {
          showTeamToggle.classList.remove("on");
          viewFilter.showTeam = false;
        } else {
          showTeamToggle.classList.add("on");
          viewFilter.showTeam = true;
        }

        loadAndRenderCalendar();
      });
    });

    // === filter 顯示設定 ===================================================
    filterToggles.forEach((el) => {
      el.addEventListener("click", () => {
        const key = el.dataset.key;
        const current = el.classList.contains("on");
        el.classList.toggle("on", !current);
        viewFilter[key] = !current;
        loadAndRenderCalendar();
      });
    });

    // === 從 Supabase 抓當月事件 ===========================================
    async function fetchEventsForCurrentMonth() {
      if (!currentUser) {
        monthEvents = [];
        return;
      }
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const startStr = `${year}-${String(month + 1).padStart(2, "0")}-01`;
      const endStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(
        daysInMonth
      ).padStart(2, "0")}`;

      const { data, error } = await sb
        .from("calendar_events")
        .select("id, title, date, visibility")
        .eq("user_id", currentUser.id)
        .gte("date", startStr)
        .lte("date", endStr)
        .order("date", { ascending: true });

      if (error) {
        console.error("load events error", error);
        monthEvents = [];
        return;
      }
      monthEvents = data || [];
    }

    function getEventsForDate(dateObj) {
      const key = dateObj.toISOString().slice(0, 10);
      return (monthEvents || []).filter((e) => e.date === key);
    }

    async function loadAndRenderCalendar() {
      currentMonth = setToFirstOfMonth(currentMonth);
      await fetchEventsForCurrentMonth();
      renderCalendar();
    }

    // === 渲染行事曆 ========================================================
    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      monthLabelEl.textContent = formatYearMonth(currentMonth);

      const today = new Date();
      const firstDay = new Date(year, month, 1);
      const firstWeekday = firstDay.getDay(); // 0=Sun
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const prevMonthDays = firstWeekday;
      const totalCells = Math.ceil((prevMonthDays + daysInMonth) / 7) * 7;

      const showMe =
        viewMode === "personal" ? true : viewFilter.showMe;
      const showTeam =
        viewMode === "personal" ? false : viewFilter.showTeam;

      calendarGridEl.innerHTML = "";

      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement("div");
        cell.className = "day-cell";

        const dayIndex = i - prevMonthDays + 1;
        let cellDate;
        let isOtherMonth = false;

        if (dayIndex <= 0) {
          cellDate = new Date(year, month, dayIndex);
          isOtherMonth = true;
        } else if (dayIndex > daysInMonth) {
          cellDate = new Date(year, month, dayIndex);
          isOtherMonth = true;
        } else {
          cellDate = new Date(year, month, dayIndex);
        }

        const headerRow = document.createElement("div");
        headerRow.className = "day-header-row";

        const numberSpan = document.createElement("div");
        numberSpan.className =
          "day-number" + (isOtherMonth ? " other-month" : "");
        numberSpan.textContent = cellDate.getDate();

        const badgeSpan = document.createElement("div");
        badgeSpan.className = "day-badge";

        if (sameDay(cellDate, today)) {
          badgeSpan.classList.add("day-badge-today");
          badgeSpan.textContent = "今天";
        } else {
          badgeSpan.textContent = "";
        }

        headerRow.appendChild(numberSpan);
        headerRow.appendChild(badgeSpan);
        cell.appendChild(headerRow);

        const eventsCol = document.createElement("div");
        eventsCol.className = "events-column";

        const dayEvents = getEventsForDate(cellDate);
        const filteredEvents = dayEvents.filter((e) => {
          if (e.visibility === "me" && !showMe) return false;
          if (e.visibility === "team" && !showTeam) return false;
          return true;
        });

        if (filteredEvents.length === 0 && !isOtherMonth) {
          const empty = document.createElement("div");
          empty.className = "event-empty";
          empty.textContent = "（無行程）";
          eventsCol.appendChild(empty);
        } else {
          filteredEvents.forEach((e) => {
            const pill = document.createElement("div");
            pill.className =
              "event-pill " +
              (e.visibility === "team" ? "event-team" : "event-me");
            const dot = document.createElement("span");
            dot.className = "event-dot";
            const text = document.createElement("span");
            text.textContent = e.title;
            pill.appendChild(dot);
            pill.appendChild(text);
            eventsCol.appendChild(pill);
          });
        }

        // 只有本月日期可以新增行程
        if (!isOtherMonth) {
          const addRow = document.createElement("div");
          addRow.className = "event-add-row";

          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = "新增行程…";
          input.className = "event-add-input";

          const saveBtn = document.createElement("button");
          saveBtn.className = "event-add-btn";
          saveBtn.textContent = "+";

          saveBtn.onclick = async (e) => {
            e.stopPropagation();
            const title = (input.value || "").trim();
            if (!title) return;

            if (!currentUser) {
              alert("請先登入才能新增行程。");
              return;
            }

            const dateStr = cellDate.toISOString().slice(0, 10);
            const visibility = viewMode === "team" ? "team" : "me";

            const { error } = await sb.from("calendar_events").insert({
              user_id: currentUser.id,
              title,
              date: dateStr,
              visibility,
            });

            if (error) {
              console.error(error);
              alert("新增行程失敗：" + error.message);
              return;
            }

            input.value = "";
            await loadAndRenderCalendar();
          };

          addRow.appendChild(input);
          addRow.appendChild(saveBtn);
          eventsCol.appendChild(addRow);
        }

        cell.appendChild(eventsCol);
        calendarGridEl.appendChild(cell);
      }

      if (viewMode === "personal") {
        calendarSubEl.textContent =
          "目前是「個人日程」模式：日曆只標記與你自己相關的行程。切換到團隊模式時，新增行程會被標記為團隊行程。";
      } else {
        calendarSubEl.textContent =
          "目前是「團隊日程」模式：黑色為你的行程、紅色為團隊行程。新增行程會自動標記為團隊行程。";
      }
    }

    // === 月份切換按鈕 ======================================================
    prevMonthBtn.addEventListener("click", () => {
      currentMonth = new Date(
        currentMonth.getFullYear(),
        currentMonth.getMonth() - 1,
        1
      );
      loadAndRenderCalendar();
    });

    nextMonthBtn.addEventListener("click", () => {
      currentMonth = new Date(
        currentMonth.getFullYear(),
        currentMonth.getMonth() + 1,
        1
      );
      loadAndRenderCalendar();
    });

    todayBtn.addEventListener("click", () => {
      currentMonth = setToFirstOfMonth(new Date());
      loadAndRenderCalendar();
    });

    // === 初始化 ============================================================
    document.addEventListener("DOMContentLoaded", async () => {
      await initAccount();
      renderMembers();
      currentMonth = setToFirstOfMonth(new Date());
      await loadAndRenderCalendar();
    });
  </script>
</body>
</html>
