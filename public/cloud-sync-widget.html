<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ä»»å‹™ç´€éŒ„</title>
<link rel="preconnect" href="{SUPABASE_URL}">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root {
    --bg: #f5f5f7;
    --card: #ffffff;
    --line: #e1e2e7;
    --txt: #111111;
    --sub: #666666;
    --pri: #e10600;
    --pri-soft: #fff3f3;
    --black: #111111;
  }

  html, body {
    margin: 0;
    font-family: ui-sans-serif, -apple-system, 'Noto Sans TC', system-ui, sans-serif;
    color: var(--txt);
    background: radial-gradient(circle at top left, #ffffff 0, #f5f5f7 40%, #f0f1f5 100%);
  }

  .wrap {
    max-width: 880px;
    margin: 16px auto 24px;
    padding: 12px 12px 24px;
  }

  /* é ‚éƒ¨æ¨™é¡Œåˆ— */
  .toolbar {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 10px;
  }

  .toolbar h2 {
    margin: 0;
    font-size: 20px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .toolbar h2::before {
    content: "";
    width: 20px;
    height: 2px;
    background: var(--pri);
    display: inline-block;
  }

  #who {
    font-size: 12px;
    color: var(--sub);
  }

  /* å…©æ¬„å¸ƒå±€ï¼ˆå·¦ï¼šç·¨è¼¯ï¼Œå³ï¼šKPI / æ­·å²ï¼‰ */
  .grid {
    display: grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
    gap: 16px;
  }

  @media (max-width: 768px) {
    .grid {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  .card {
    background: var(--card);
    border-radius: 14px;
    padding: 14px 14px 12px;
    border: 1px solid rgba(0, 0, 0, 0.03);
    box-shadow: 0 12px 30px rgba(0,0,0,.06);
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border-top: 3px solid var(--black);
    border-left: 3px solid var(--pri);
    opacity: 0.85;
    pointer-events: none;
  }

  .card h3 {
    margin: 0 0 6px;
    font-size: 15px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .card h3::after {
    content: "";
    flex: 1;
    height: 1px;
    margin-left: 4px;
    background: linear-gradient(to right, #000, transparent);
    opacity: 0.10;
  }

  .sub {
    color: var(--sub);
    font-size: 12px;
  }

  .muted {
    color: var(--sub);
    font-size: 12px;
  }

  .row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin: 8px 0;
    flex-wrap: wrap;
  }

  /* è¼¸å…¥å€ï¼šè®“æ™‚é–“è¼¸å…¥æ›´ç›´è¦º */
  .row-time {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }

  .row-time-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .row-time-label {
    font-size: 11px;
    color: var(--sub);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  input[type=time],
  input[type=text],
  input[type=date] {
    padding: 7px 9px;
    border: 1px solid var(--line);
    border-radius: 999px;
    background: #fff;
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out, background 0.15s;
  }

  input[type=time] {
    width: 110px;
  }

  input[type=text] {
    flex: 1;
    min-width: 180px;
  }

  input[type=date] {
    border-radius: 999px;
  }

  input:focus {
    border-color: var(--pri);
    box-shadow: 0 0 0 1px rgba(225, 6, 0, 0.15);
    background: #fffdfd;
  }

  button {
    padding: 7px 12px;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: #fff;
    cursor: pointer;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: background 0.15s ease-out, color 0.15s, border-color 0.15s, transform 0.08s;
  }

  button:hover {
    background: #f5f5f7;
    transform: translateY(-0.5px);
  }

  .btn-pri {
    background: var(--pri);
    color: #fff;
    border-color: transparent;
  }

  .btn-pri:hover {
    background: #b00000;
    transform: translateY(-1px);
  }

  .btn-outlined {
    border-radius: 999px;
  }

  .list {
    display: grid;
    gap: 8px;
    margin-top: 6px;
  }

  .item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 9px 11px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: #fff;
    gap: 8px;
  }

  .item b {
    font-size: 13px;
  }

  .item .sub {
    font-size: 11px;
  }

  .empty {
    color: var(--sub);
    padding: 8px;
    font-size: 12px;
  }

  .pill {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid var(--line);
    font-size: 11px;
    background: #fff;
  }

  .pill-strong {
    border-color: var(--pri);
    color: var(--pri);
    background: var(--pri-soft);
  }

  .history-list {
    display: grid;
    gap: 6px;
    max-height: 380px;
    overflow: auto;
  }

  .history-item {
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid var(--line);
    background: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-size: 13px;
  }

  .history-item:hover {
    border-color: var(--pri);
    background: #fff7f7;
  }

  .right .card {
    height: fit-content;
  }

  .sep {
    height: 1px;
    background: var(--line);
    margin: 10px 0;
  }

  /* KPI å¡ç‰‡å°ˆç”¨ï¼šprogress bar æ”¹æˆç´…è‰² */
  .bar {
    width: 100%;
    height: 8px;
    background: #f0f1f5;
    border-radius: 999px;
    overflow: hidden;
  }

  .bar span {
    display: block;
    height: 100%;
    background: var(--pri);
    width: 0%;
    border-radius: inherit;
    transition: width 0.25s ease-out;
  }

  /* KPI æˆå°±æ ¼å­ï¼šç”¨æ·¡ç·šæ¡† + å…©æ¬„ */
  #achGrid .item {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    padding-block: 8px;
  }

  #achGrid .item .row {
    margin: 0;
  }

  /* å°è¢å¹•å„ªåŒ–ï¼šæŠŠä¸‹åŠéƒ¨æŒ‰éˆ•æ’æ•´é½Š */
  @media (max-width: 640px) {
    .row-actions-bottom {
      flex-direction: column;
      align-items: flex-start;
    }

    .history-list {
      max-height: 260px;
    }

    .card {
      padding-inline: 12px;
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <h2>ä»»å‹™ç´€éŒ„</h2>
    <div class="sub" id="who"></div>
  </div>

  <div class="grid">
    <!-- å·¦å´ï¼šä»Šæ—¥ä»»å‹™ + ä»»æ„æ—¥æœŸæª¢è¦– -->
    <section class="left">
      <div class="card">
        <h3>ä»Šå¤©çš„ä»»å‹™</h3>
        <p class="muted" style="margin:2px 0 6px;font-size:11px;">
          å…ˆè¼¸å…¥ <b>é–‹å§‹æ™‚é–“ / çµæŸæ™‚é–“ / ä»»å‹™åç¨±</b>ï¼ŒæŒ‰ã€Œæ–°å¢ã€å³å¯åŒæ­¥åˆ°é›²ç«¯ã€‚
        </p>

        <!-- è¼¸å…¥åˆ—ï¼šæ™‚é–“ + ä»»å‹™åç¨± -->
        <div class="row row-time">
          <div class="row-time-group">
            <span class="row-time-label">é–‹å§‹</span>
            <input type="time" id="start" value="09:00">
          </div>
          <span style="font-size:12px;color:var(--sub);margin-top:18px;">â€”</span>
          <div class="row-time-group">
            <span class="row-time-label">çµæŸ</span>
            <input type="time" id="end" value="10:00">
          </div>
          <div class="row-time-group" style="flex:1;min-width:180px;">
            <span class="row-time-label">ä»»å‹™</span>
            <input type="text" id="title" placeholder="ä¾‹å¦‚ï¼šå¯«ä¼åŠƒã€ç·´èƒ¸èƒŒã€è®€ 30 åˆ†é˜æ›¸">
          </div>
          <div class="row-time-group" style="align-self:flex-end;">
            <button class="btn-pri" id="add">ï¼‹ æ–°å¢</button>
          </div>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:4px;">
          <button id="reload" class="btn-outlined">é‡æ–°æ•´ç†</button>
        </div>

        <!-- ä»Šæ—¥æ¸…å–® -->
        <div id="todayList" class="list"></div>

        <!-- å®Œæˆç‡ ï¼‹ å­˜æª” -->
        <div class="row row-actions-bottom" style="justify-content:space-between;margin-top:10px;">
          <div class="muted">
            å®Œæˆç‡ï¼š
            <b id="rate">0%</b>
            ï¼ˆ<span id="doneCnt">0</span>/<span id="totalCnt">0</span>ï¼‰
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="saveDone" class="btn-outlined">ğŸ’¾ å„²å­˜å®Œæˆæƒ…æ³</button>
            <button class="btn-pri" id="archive">ğŸ“Œ å­˜å…¥æ­·å²ï¼ˆä»Šæ—¥ï¼‰</button>
          </div>
        </div>

        <div class="sep"></div>
        <div class="muted" style="font-size:11px;">
          å°æé†’ï¼šé€™è£¡åªè² è²¬ <b>é›²ç«¯åŒæ­¥èˆ‡æ­·å²ç´€éŒ„</b>ï¼Œä½ ä¸»ç¶²ç«™ä¸Šçš„ AI åˆ†æèˆ‡æ™‚é–“å·¥å…·ä¸æœƒè¢«å½±éŸ¿ã€‚
        </div>
      </div>

      <div class="card">
        <h3>æª¢è¦–ä»»å‹™ï¼ˆä»»ä½•ä¸€å¤©ï¼‰</h3>
        <div class="row">
          <input type="date" id="pickDay">
          <button id="viewPicked" class="btn-outlined">æŸ¥çœ‹é€™ä¸€å¤©</button>
        </div>
        <div id="pickedList" class="list"></div>
      </div>
    </section>

    <!-- å³å´ï¼šå®Œæˆç‡ KPI + æˆå°± + æ­·å² -->
    <section class="right">
      <!-- å®Œæˆç‡ KPI + æˆå°± -->
      <div class="card" id="kpiCard">
        <div class="row" style="justify-content:space-between;align-items:flex-end;">
          <h3>å®Œæˆç‡èˆ‡æˆå°±</h3>
          <div class="row" style="gap:6px;">
            <span class="pill" id="kpiMonthLabel">æœ¬æœˆ</span>
            <span class="pill pill-strong" id="kpiWeekLabel">æœ¬é€±</span>
          </div>
        </div>

        <!-- KPI å€ -->
        <div class="list" style="gap:10px;margin-top:6px;">
          <div>
            <div class="row" style="justify-content:space-between;margin:0 0 4px;">
              <div class="muted">æœ¬æœˆå®Œæˆç‡</div>
              <div class="muted">
                <b id="mRatio">--%</b>
                ï¼ˆ<span id="mDone">0</span>/<span id="mTotal">0</span>ï¼‰
              </div>
            </div>
            <div class="bar"><span id="mBar"></span></div>
          </div>

          <div>
            <div class="row" style="justify-content:space-between;margin:0 0 4px;">
              <div class="muted">æœ¬é€±å®Œæˆç‡</div>
              <div class="muted">
                <b id="wRatio">--%</b>
                ï¼ˆ<span id="wDone">0</span>/<span id="wTotal">0</span>ï¼‰
              </div>
            </div>
            <div class="bar"><span id="wBar"></span></div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- æˆå°±å€ -->
        <div class="row" style="justify-content:space-between;margin-top:2px;">
          <div class="muted">æˆå°±ç³»çµ±</div>
          <div class="muted" id="achDbg"></div>
        </div>
        <div id="achGrid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:6px;"></div>
      </div>

      <!-- æ­·å²æ¸…å–® -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <h3>æ­·å²ï¼ˆæœ¬é€± / æœ¬æœˆï¼‰</h3>
          <div class="row">
            <button id="showWeek" class="btn-outlined">æœ¬é€±</button>
            <button id="showMonth" class="btn-outlined">æœ¬æœˆ</button>
          </div>
        </div>
        <div class="history-list" id="history"></div>
        <div class="sep"></div>
        <div class="muted">é»ä»»ä¸€æ—¥æœŸå¯å±•é–‹ç•¶å¤©çš„ä»»å‹™ç´°ç¯€ã€‚</div>
      </div>
    </section>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://rbtevdmunkjjevoeooli.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJidGV2ZG11bmtqamV2b2Vvb2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNzMxMjIsImV4cCI6MjA3NTg0OTEyMn0.XjWId9AynP3TrJJEKIXZcsvmAW4kHLgH4dGDGqBH9dw";
  const LOGIN_PAGE = "https://tool-server-d695.onrender.com/supabase-test.html?redirect=/home.html";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const $ = sel => document.querySelector(sel);
  const el = (tag, attrs={}, html="") => { const x=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>x.setAttribute(k,v)); if(html) x.innerHTML=html; return x; };

  const todayStr = () => new Date().toISOString().slice(0,10);
  const toMin = (hhmm) => { const [h,m] = hhmm.split(":").map(Number); return h*60+m; };
  const toHHMM = (min) => String(Math.floor(min/60)).padStart(2,'0')+":"+String(min%60).padStart(2,'0');

  async function getUser(){ return (await sb.auth.getUser()).data.user || null; }

  // âœ… æ–°å¢ï¼šçµ±ä¸€æœªç™»å…¥è·³è½‰ï¼ˆé¿å…åŒé å¤šæ®µ script æœ‰çš„åª return ä¸è·³ï¼‰
  function redirectToLogin(message = "è«‹å…ˆç™»å…¥") {
    // é¿å…é‡è¤‡ alert / é‡è¤‡è·³è½‰ï¼ˆä¾‹å¦‚å¤šæ®µ code åŒæ™‚è§¸ç™¼ï¼‰
    if (sessionStorage.getItem("__redirecting_to_login__") === "1") return;
    sessionStorage.setItem("__redirecting_to_login__", "1");
    try { alert(message); } catch(e) {}
    location.href = LOGIN_PAGE;
  }

  async function fetchToday(){
    const u = await getUser();
    if(!u) { redirectToLogin(); return []; }
    const { data, error } = await sb.from("cloud_tasks")
      .select("*").eq("user_id", u.id).eq("date", todayStr()).order("start_min");
    if(error) throw error; return data || [];
  }
  async function addToday(start_min, end_min, title){
    const u = await getUser();
    if(!u) { redirectToLogin(); throw new Error("æœªç™»å…¥"); }
    const { error } = await sb.from("cloud_tasks").insert([{ user_id: u.id, date: todayStr(), start_min, end_min, title, done:false }]);
    if(error) throw error;
  }
  async function toggleDone(id, done){
    const { error } = await sb.from("cloud_tasks").update({ done }).eq("id", id);
    if(error) throw error;
  }
  async function removeToday(id){
    const { error } = await sb.from("cloud_tasks").delete().eq("id", id);
    if(error) throw error;
  }
  async function archiveToday(){
    const u = await getUser();
    if(!u) { redirectToLogin(); throw new Error("æœªç™»å…¥"); }
    const rows = await fetchToday(); if(!rows.length) return 0;
    await sb.from("cloud_tasks_archive").delete().eq("user_id", u.id).eq("date", todayStr());
    const payload = rows.map(r=>({ user_id:u.id, date:r.date, start_min:r.start_min, end_min:r.end_min, title:r.title, done:r.done }));
    const { error } = await sb.from("cloud_tasks_archive").insert(payload);
    if(error) throw error;
    return payload.length;
  }
  async function fetchRange(from, to){
    const u = await getUser();
    if(!u) { redirectToLogin(); return []; }
    const { data, error } = await sb.from("cloud_tasks_archive")
      .select("date, done").eq("user_id", u.id).gte("date", from).lte("date", to);
    if(error) throw error; return data || [];
  }
  async function fetchDayArchive(dateStr){
    const u = await getUser();
    if(!u) { redirectToLogin(); return []; }
    const { data, error } = await sb.from("cloud_tasks_archive")
      .select("*").eq("user_id", u.id).eq("date", dateStr).order("start_min");
    if(error) throw error; return data || [];
  }

  function renderList(rows){
    const list = $("#todayList");
    if(!rows.length) { list.innerHTML = '<div class="empty">ä»Šå¤©é‚„æ²’æœ‰ä»»å‹™ï¼Œå…ˆåœ¨ä¸Šæ–¹æ–°å¢å§ã€‚</div>'; updateRate(0,0); return; }
    list.innerHTML = "";
    let done=0;
    rows.forEach(r=>{
      if(r.done) done++;
      const item = el("div", { class:"item" });
      const left = el("div", {}, '<div><b>'+toHHMM(r.start_min)+'â€“'+toHHMM(r.end_min)+'</b>ã€€'+escapeHtml(r.title)+'</div><div class="sub">'+(r.done?'å·²å®Œæˆ':'æœªå®Œæˆ')+'</div>');
      const right = el("div");
      const chk = el("input", { type:"checkbox" });
      if(r.done) chk.checked = true;
      chk.addEventListener("change", async ()=>{ await toggleDone(r.id, chk.checked); await loadToday(); });
      const del = el("button", {}, "åˆªé™¤");
      del.addEventListener("click", async ()=>{ if(confirm("ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ")){ await removeToday(r.id); await loadToday(); } });
      right.append(chk); right.append(del);
      item.append(left); item.append(right);
      list.append(item);
    });
    updateRate(rows.length, done);
  }
  function updateRate(total, done){
    $("#totalCnt").textContent = total;
    $("#doneCnt").textContent = done;
    $("#rate").textContent = total? Math.round(done*100/total)+'%':'0%';
  }

  async function loadToday(){
    const rows = await fetchToday();
    renderList(rows);
  }

  async function renderHistory(mode='week'){
    const now = new Date();
    const to = new Date(now);
    const from = new Date(now);
    if(mode==='week') from.setDate(now.getDate()-6);
    if(mode==='month') from.setDate(now.getDate()-29);
    const dstr = (d)=> d.toISOString().slice(0,10);
    const data = await fetchRange(dstr(from), dstr(to));
    const agg = new Map();
    data.forEach(r=>{ const k=r.date; const v=agg.get(k)||{total:0,done:0}; v.total++; if(r.done) v.done++; agg.set(k,v); });
    const days = Array.from(agg.keys()).sort((a,b)=> b.localeCompare(a));
    const box = $("#history"); box.innerHTML = "";
    if(!days.length) { box.innerHTML = '<div class="empty">å°šç„¡æ­·å²è³‡æ–™ï¼Œå…ˆæŠŠä»Šå¤©ã€Œå­˜å…¥æ­·å²ã€å§ã€‚</div>'; return; }
    days.forEach(d=>{
      const v = agg.get(d); const pct = v.total? Math.round(v.done*100/v.total) : 0;
      const row = el("div", { class:"history-item" }, '<div><b>'+d+'</b>ã€€<span class="pill">å®Œæˆç‡ '+pct+'%</span></div><div class="sub">('+v.done+'/'+v.total+')</div>');
      row.addEventListener("click", async ()=>{ const items = await fetchDayArchive(d); showPicked(d, items); });
      box.append(row);
    });
  }

  function showPicked(dateStr, rows){
    const list = $("#pickedList");
    if(!rows.length) { list.innerHTML = '<div class="empty">'+dateStr+' æ²’æœ‰å­˜æª”ç´€éŒ„ã€‚</div>'; return; }
    list.innerHTML = rows.map(r=>'<div class="item"><div><b>'+toHHMM(r.start_min)+'â€“'+toHHMM(r.end_min)+'</b>ã€€'+escapeHtml(r.title)+'</div><div class="sub">'+(r.done?'âœ” å®Œæˆ':'â€” æœªå®Œæˆ')+'</div></div>').join("");
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  $("#add").addEventListener("click", async ()=>{
    const s = $("#start").value, e = $("#end").value, t = $("#title").value.trim();
    if(!s || !e || !t) return alert("è«‹å¡«æ™‚é–“èˆ‡ä»»å‹™å…§å®¹");
    if(toMin(e) <= toMin(s)) return alert("çµæŸæ™‚é–“éœ€å¤§æ–¼é–‹å§‹");
    await addToday(toMin(s), toMin(e), t);
    $("#title").value = "";
    await loadToday();
  });
  $("#reload").addEventListener("click", loadToday);
  $("#saveDone").addEventListener("click", async ()=>{ await loadToday(); alert("å®Œæˆæƒ…æ³å·²å„²å­˜åˆ°é›²ç«¯ã€‚"); });
  $("#archive").addEventListener("click", async ()=>{ const n = await archiveToday(); await renderHistory('week'); alert(n? ("å·²å­˜å…¥ä»Šæ—¥ï¼š"+n+" ç­†"):"ä»Šå¤©æ²’æœ‰ä»»å‹™å¯å­˜å…¥"); });
  $("#showWeek").addEventListener("click", ()=> renderHistory('week'));
  $("#showMonth").addEventListener("click", ()=> renderHistory('month'));
  $("#viewPicked").addEventListener("click", async ()=>{ const d = $("#pickDay").value; if(!d) return; const rows = await fetchDayArchive(d); showPicked(d, rows); });

  (async () => {
    const u = await getUser();
    if(!u) { redirectToLogin(); return; }   // âœ… æ”¹æˆçµ±ä¸€çš„è·³è½‰ï¼ˆå«æç¤ºï¼‰
    $("#who").textContent = u.email + "ï¼ˆå·²ç™»å…¥ï¼‰";
    $("#pickDay").value = todayStr();
    await loadToday();
    await renderHistory('week');
  })();
</script>

<script>
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('saveButton');
    if(btn) btn.addEventListener('click', Save_Cloud_Archive_Achievements);
  });
</script>

<script>
  // ====== é€±/æœˆå®Œæˆç‡ + æˆå°±ï¼ˆä½¿ç”¨ cloud_tasks_archiveï¼‰ ======
  (function(){
    const el = id => document.getElementById(id);

    const mondayOf = (d) => { const x=new Date(d); const wd=(x.getDay()+6)%7; x.setDate(x.getDate()-wd); x.setHours(0,0,0,0); return x; };
    const sundayOf = (d) => { const m=mondayOf(d); const x=new Date(m); x.setDate(m.getDate()+6); x.setHours(23,59,59,999); return x; };
    const iso = (d) => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);

    function monthRange(base=new Date()){
      const s = new Date(base.getFullYear(), base.getMonth(), 1, 0,0,0,0);
      const e = new Date(base.getFullYear(), base.getMonth()+1, 0, 23,59,59,999);
      return {s, e};
    }
    function weekRange(base=new Date()){ return { s: mondayOf(base), e: sundayOf(base) }; }

    async function fetchArchiveRange(userId, from, to){
      const { data, error } = await sb.from("cloud_tasks_archive")
        .select("date, done")
        .eq("user_id", userId)
        .gte("date", iso(from))
        .lte("date", iso(to));
      if (error) { console.warn("[KPI] query error", error); return []; }
      return data || [];
    }

    function computeRate(rows){
      const total = rows.length;
      const done  = rows.filter(r => r.done).length;
      const ratio = total ? Math.round(done*100/total) : 0;
      return { total, done, ratio };
    }

    function renderBar(barEl, pct){ barEl.style.width = (pct||0) + "%"; }

    function renderAchievements({ month, week }){
      const list = [];
      list.push({ id:"m10",  title:"æš–èº«å®Œæˆè€…", desc:"æœ¬æœˆå®Œæˆ â‰¥ 10 ä»¶", ok: month.done >= 10, need:10 });
      list.push({ id:"m25",  title:"ç©©å®šè¼¸å‡º",   desc:"æœ¬æœˆå®Œæˆ â‰¥ 25 ä»¶", ok: month.done >= 25, need:25 });
      list.push({ id:"m50",  title:"æ•ˆç‡é”äºº",   desc:"æœ¬æœˆå®Œæˆ â‰¥ 50 ä»¶", ok: month.done >= 50, need:50 });
      list.push({ id:"m70",  title:"æœ¬æœˆä¸ƒæˆé”æ¨™", desc:"æœ¬æœˆå®Œæˆç‡ â‰¥ 70%", ok: month.ratio >= 70, need:"70%" });
      list.push({ id:"w80",  title:"æœ¬é€±å…«æˆé”æ¨™", desc:"æœ¬é€±å®Œæˆç‡ â‰¥ 80%", ok: week.ratio >= 80, need:"80%" });

      const { s:ms, e:me } = monthRange(new Date());
      const days = new Map();
      month.rows.forEach(r=>{
        const k = r.date;
        const v = days.get(k) || { done:0, total:0 };
        v.total++; if (r.done) v.done++;
        days.set(k, v);
      });
      let streak = 0;
      for (let d=me.getDate(); d>=1; d--){
        const k = iso(new Date(ms.getFullYear(), ms.getMonth(), d));
        const rec = days.get(k);
        if (rec && rec.done > 0) streak++;
        else break;
      }
      list.push({ id:"s3", title:"é€£ä¸‰å¥½æ—¥å­", desc:"é€£çºŒ 3 å¤©æœ‰å®Œæˆï¼ˆæœ¬æœˆï¼‰", ok: streak >= 3, need:"3å¤©" });
      list.push({ id:"s7", title:"ä¸€é€±ç©©ç©©ä¾†", desc:"é€£çºŒ 7 å¤©æœ‰å®Œæˆï¼ˆæœ¬æœˆï¼‰", ok: streak >= 7, need:"7å¤©" });

      const grid = el("achGrid");
      if (!grid) return;
      grid.innerHTML = "";
      list.forEach(a=>{
        const card = document.createElement("div");
        card.className = "item";
        card.style.opacity = a.ok ? "1" : ".52";
        card.innerHTML = `
          <div style="font-weight:700;font-size:13px;">${a.title}</div>
          <div class="sub" style="font-size:11px;">${a.desc}</div>
          <div class="row" style="justify-content:space-between;margin-top:4px;">
            <span class="muted">${a.ok ? "å·²è§£é–" : "æœªè§£é–"}</span>
            <span class="pill">${a.need}</span>
          </div>
        `;
        grid.appendChild(card);
      });
      el("achDbg").textContent = `æœ¬æœˆ ${month.done}/${month.total}ï¼Œæœ¬é€± ${week.done}/${week.total}`;
    }

    async function refreshKPI(){
      const u = await (typeof getUser === "function" ? getUser() : (await sb.auth.getUser()).data.user);

      // âœ… åŸæœ¬æ˜¯ if(!u) return; æ”¹æˆï¼šæ²’ç™»å…¥ä¹Ÿç›´æ¥è·³ç™»å…¥é 
      if (!u) { redirectToLogin(); return; }

      const now = new Date();
      const { s:ms, e:me } = monthRange(now);
      const mRows = await fetchArchiveRange(u.id, ms, me);
      const mStat = computeRate(mRows);

      const { s:ws, e:we } = weekRange(now);
      const wRows = await fetchArchiveRange(u.id, ws, we);
      const wStat = computeRate(wRows);

      el("mRatio").textContent = mStat.ratio + "%";
      el("mDone").textContent  = mStat.done;
      el("mTotal").textContent = mStat.total;
      renderBar(el("mBar"), mStat.ratio);

      el("wRatio").textContent = wStat.ratio + "%";
      el("wDone").textContent  = wStat.done;
      el("wTotal").textContent = wStat.total;
      renderBar(el("wBar"), wStat.ratio);

      renderAchievements({ month: { ...mStat, rows: mRows }, week: wStat });

      el("kpiMonthLabel").textContent = `æœ¬æœˆ ${iso(ms)} ~ ${iso(me)}`;
      el("kpiWeekLabel").textContent  = `æœ¬é€± ${iso(ws)} ~ ${iso(we)}`;
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      setTimeout(refreshKPI, 300);

      const oldArchive = window.archiveToday;
      if (typeof oldArchive === "function"){
        window.archiveToday = async function(){
          const n = await oldArchive.apply(this, arguments);
          await refreshKPI();
          return n;
        };
      }

      const btnW = document.getElementById("showWeek");
      const btnM = document.getElementById("showMonth");
      btnW && btnW.addEventListener("click", ()=> setTimeout(refreshKPI, 100));
      btnM && btnM.addEventListener("click", ()=> setTimeout(refreshKPI, 100));

      setInterval(refreshKPI, 5000);
    });
  })();
</script>
</body>
</html>
