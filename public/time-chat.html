<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>時間管理 AI 聊天室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f5f7;
      --card: #ffffff;
      --accent: #e31b23; /* 紅 */
      --border: #e1e1e5;
      --text: #111111;
      --sub: #777777;
      --bubble-ai: #f3f4f6;
      --bubble-user: #111111;
      --bubble-user-text: #ffffff;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    body {
      padding: 8px;
    }

    .chat-shell {
      width: 100%;
      height: 100%;
      background: var(--card);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* 頂部標題列 */
    .chat-header {
      padding: 10px 14px 6px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .chat-title-group {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .chat-logo {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 2px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      background: #fff;
    }

    .chat-title-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .chat-title-text h1 {
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-title-text span {
      font-size: 11px;
      color: var(--sub);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-tag {
      flex-shrink: 0;
      border-radius: 999px;
      border: 1px solid var(--accent);
      padding: 3px 8px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--accent);
      background: #fff5f5;
    }

    /* 提示條 */
    .chat-hint {
      padding: 6px 14px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      color: var(--sub);
      background: #fafafa;
    }

    .chat-hint strong {
      color: var(--accent);
    }

    /* 訊息區 */
    .chat-messages {
      flex: 1;
      padding: 10px 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .msg-row {
      display: flex;
      gap: 6px;
      align-items: flex-end;
      max-width: 92%;
    }

    .msg-row.user {
      margin-left: auto;
      flex-direction: row-reverse;
    }

    .avatar {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      background: #fff;
      color: #555;
      flex-shrink: 0;
    }

    .avatar.ai {
      border-color: var(--accent);
      color: var(--accent);
    }

    .bubble {
      padding: 7px 9px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .bubble.ai {
      background: var(--bubble-ai);
      border: 1px solid #e3e4ea;
      color: var(--text);
    }

    .bubble.user {
      background: var(--bubble-user);
      color: var(--bubble-user-text);
    }

    .bubble-meta {
      font-size: 10px;
      color: var(--sub);
      margin-top: 2px;
    }

    .typing-indicator {
      display: inline-flex;
      gap: 3px;
      align-items: center;
    }

    .dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: var(--accent);
      opacity: 0.4;
      animation: bounce 1s infinite ease-in-out;
    }

    .dot:nth-child(2) { animation-delay: 0.18s; }
    .dot:nth-child(3) { animation-delay: 0.36s; }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); opacity: 0.4; }
      50% { transform: translateY(-2px); opacity: 1; }
    }

    /* 底部輸入區 */
    .chat-input-area {
      padding: 8px 10px 10px;
      border-top: 1px solid var(--border);
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .quick-row {
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 2px;
    }

    .quick-chip {
      flex-shrink: 0;
      border-radius: 999px;
      border: 1px solid #e2e3ea;
      padding: 3px 8px;
      font-size: 10px;
      color: var(--sub);
      background: #fafafa;
      cursor: pointer;
      white-space: nowrap;
    }

    .quick-chip:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: #fff5f5;
    }

    .input-shell {
      display: flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      background: #f5f5f7;
      border: 1px solid #ddd;
      padding: 5px 8px 5px 10px;
    }

    .input-shell input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 13px;
      min-width: 0;
    }

    .input-shell input::placeholder {
      color: #aaa;
    }

    .send-btn {
      border-radius: 999px;
      border: none;
      outline: none;
      padding: 6px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .send-btn span.icon {
      font-size: 12px;
    }

    @media (max-width: 480px) {
      body {
        padding: 4px;
      }
      .chat-input-area {
        padding: 6px 6px 8px;
      }
      .chat-header {
        padding: 8px 10px 4px;
      }
    }
  </style>
</head>
<body>
<div class="chat-shell">
  <header class="chat-header">
    <div class="chat-title-group">
      <div class="chat-logo">⏱</div>
      <div class="chat-title-text">
        <h1>Time Coach</h1>
        <span>通用 AI · 擅長整理時間與計畫</span>
      </div>
    </div>
    <div class="chat-tag">ZILV · TOOLS</div>
  </header>

  <div class="chat-hint">
    你可以問任何事情，如果是
    <strong>時間管理、排程、自律</strong> 的問題，我會幫你把計畫拆得更清楚。
  </div>

  <main class="chat-messages" id="chatMessages">
    <!-- JS 會插入訊息 -->
  </main>

  <footer class="chat-input-area">
    <div class="quick-row">
      <button class="quick-chip" data-ask="幫我排一下今天的時間，早上有課、下午打工、晚上想寫報告。">排今天行程</button>
      <button class="quick-chip" data-ask="我常常想讀書但坐下來五分鐘就分心，有什麼建議？">容易分心怎麼辦</button>
      <button class="quick-chip" data-ask="期末考前兩週，每天只有兩小時可以讀書，怎麼安排比較好？">考前讀書計畫</button>
      <button class="quick-chip" data-ask="我想調整成早睡早起，能幫我排一個一週的作息調整計畫嗎？">調整作息</button>
    </div>

    <div class="input-shell">
      <input
        id="userInput"
        type="text"
        placeholder="輸入訊息，例如：『幫我排今天的行程』或其他想聊的事" />
      <button id="sendBtn" class="send-btn">
        <span class="icon">➤</span><span>送出</span>
      </button>
    </div>
  </footer>
</div>

<script>
  const chatMessages = document.getElementById("chatMessages");
  const userInput = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");

  let isWaiting = false;
  let messages = []; // 存 user / assistant 的對話，會傳給後端

  // === 初始化：歡迎訊息 ===
  window.addEventListener("DOMContentLoaded", () => {
    addBotMessage(
      "嗨，我是你的 AI 助理，也是專門幫你整理「時間與計畫」的小教練。\n\n" +
      "你可以：\n" +
      "・跟我聊生活、想法、任何問題\n" +
      "・或是請我幫你排今天／這週的時間、讀書計畫、自律作息\n\n" +
      "如果你有時間管理的困擾，可以先簡單說：\n" +
      "「我今天有什麼行程、想完成什麼」，剩下交給我。"
    );
  });

  // === UI：新增訊息 ===
  function addMessage(role, content, metaText) {
    const row = document.createElement("div");
    row.className = "msg-row " + (role === "user" ? "user" : "ai");

    const avatar = document.createElement("div");
    avatar.className = "avatar " + (role === "user" ? "" : "ai");
    avatar.textContent = role === "user" ? "你" : "AI";

    const bubbleWrap = document.createElement("div");

    const bubble = document.createElement("div");
    bubble.className = "bubble " + (role === "user" ? "user" : "ai");
    bubble.innerText = content;

    bubbleWrap.appendChild(bubble);

    if (metaText) {
      const meta = document.createElement("div");
      meta.className = "bubble-meta";
      meta.textContent = metaText;
      bubbleWrap.appendChild(meta);
    }

    row.appendChild(avatar);
    row.appendChild(bubbleWrap);
    chatMessages.appendChild(row);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function addBotMessage(text, meta) {
    addMessage("assistant", text, meta || "AI 助理 · 擅長整理時間與計畫");
  }

  function addUserMessage(text) {
    addMessage("user", text);
  }

  // 打字中指示
  function showTyping() {
    const row = document.createElement("div");
    row.className = "msg-row ai";
    row.id = "typingRow";

    const avatar = document.createElement("div");
    avatar.className = "avatar ai";
    avatar.textContent = "AI";

    const bubbleWrap = document.createElement("div");
    const bubble = document.createElement("div");
    bubble.className = "bubble ai";

    const typing = document.createElement("div");
    typing.className = "typing-indicator";
    typing.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';

    bubble.appendChild(typing);
    bubbleWrap.appendChild(bubble);

    row.appendChild(avatar);
    row.appendChild(bubbleWrap);

    chatMessages.appendChild(row);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function hideTyping() {
    const row = document.getElementById("typingRow");
    if (row) row.remove();
  }

  // ✅ 呼叫後端 /api/time-coach（現在當一般聊天用）
  async function askTimeCoach(userText) {
    const apiMessages = messages.map(m => ({
      role: m.role === "assistant" ? "assistant" : "user",
      content: m.content,
    }));

    apiMessages.push({ role: "user", content: userText });

    const res = await fetch("/api/time-coach", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: apiMessages }),
    });

    if (!res.ok) {
      throw new Error("API error");
    }

    const data = await res.json();
    return data.reply || "（AI 沒有回應內容）";
  }

  async function handleSend() {
    if (isWaiting) return;
    const text = userInput.value.trim();
    if (!text) return;

    isWaiting = true;
    sendBtn.disabled = true;
    userInput.value = "";

    messages.push({ role: "user", content: text });
    addUserMessage(text);
    showTyping();

    try {
      const reply = await askTimeCoach(text);
      hideTyping();
      messages.push({ role: "assistant", content: reply });
      addBotMessage(reply);
    } catch (err) {
      console.error(err);
      hideTyping();
      addBotMessage("抱歉，目前暫時連不到伺服器，你可以等一下再試一次。");
    } finally {
      isWaiting = false;
      sendBtn.disabled = false;
      userInput.focus();
    }
  }

  sendBtn.addEventListener("click", handleSend);
  userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  // 快速問題按鈕
  document.querySelectorAll(".quick-chip").forEach(chip => {
    chip.addEventListener("click", () => {
      const txt = chip.getAttribute("data-ask");
      userInput.value = txt;
      userInput.focus();
    });
  });
</script>
</body>
</html>

