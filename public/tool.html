<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI æ™‚é–“æ’ç¨‹èˆ‡æˆæœ¬åˆ†æ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ğŸ”´âš« ç´…é»‘ç™½ä¸»é¡Œæ¨£å¼ï¼šåªæ”¹ UIï¼Œä¸å‹•åŠŸèƒ½ -->
  <style> 
    :root {
      --cr-red: #e10600;
      --cr-red-dark: #b00000;
      --cr-black: #111111;
      --cr-gray-bg: #f4f5f7;
      --cr-card-bg: #ffffff;
      --cr-border: #dedfe3;
    }

    body {
      background-color: var(--cr-gray-bg);
      font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      color: var(--cr-black);
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 960px;
      margin: 0 auto 24px;
      padding-inline: 12px;
    }

    /* å°è¦½åˆ—ï¼šé»‘åº•ï¼‹æ­¥é©Ÿæç¤º */
    .app-navbar {
      border-bottom: 3px solid var(--cr-red);
      background-color: var(--cr-black) !important;
      padding-block: 8px;
    }

    .app-navbar .navbar-brand {
      color: #ffffff !important;
      font-weight: 700;
      letter-spacing: 0.12em;
      font-size: 1rem;
      text-transform: uppercase;
    }

    .app-steps {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.80);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .app-steps span {
      white-space: nowrap;
    }

    .app-steps-dot {
      margin-inline: 4px;
      color: rgba(255,255,255,0.35);
    }

    /* å¡ç‰‡ UIï¼šç´…é»‘ç™½ */
    .card-ui {
      background-color: var(--cr-card-bg);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      padding: 20px 20px 18px;
      margin-bottom: 18px;
      position: relative;
      overflow: hidden;
      border: 1px solid var(--cr-border);
    }

    .card-ui::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      border-left: 4px solid var(--cr-red);
      opacity: 0.9;
      pointer-events: none;
    }

    .card-ui h5 {
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 0.9rem;
      text-transform: uppercase;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-ui h5::after {
      content: "";
      flex: 1;
      height: 1px;
      margin-left: 6px;
      background: linear-gradient(to right, #000000, transparent);
      opacity: 0.12;
    }

    .card-ui:hover {
      box-shadow: 0 14px 34px rgba(0,0,0,0.10);
      transform: translateY(-1px);
      transition: box-shadow 0.18s ease-out, transform 0.18s ease-out;
    }

    /* æ­¥é©Ÿ header */
    .step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      margin-top: 4px;
    }

    .step-pills {
      display: flex;
      gap: 8px;
      font-size: 0.8rem;
    }

    .step-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d3d5dd;
      color: #666;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .step-pill span.step-num {
      font-weight: 700;
      font-size: 0.75rem;
    }

    .step-pill.current {
      border-color: var(--cr-red);
      color: var(--cr-black);
      background-color: #fff3f3;
    }

    /* step å€å¡Šï¼šä¸€æ¬¡åªé¡¯ç¤ºä¸€å€‹ */
    .step-section {
      display: none;
    }
    .step-section.active {
      display: block;
    }

    /* ä¸»è¦ç‰ˆé¢ï¼šå½ˆå‡ºå¼å°±ç•¶æˆç›´å‘å° wizard */
    @media (min-width: 768px) {
      .layout-main-step1 {
        display: grid;
        grid-template-columns: minmax(0,1.05fr) minmax(0,1fr);
        gap: 16px;
        align-items: flex-start;
      }
    }

    @media (max-width: 767.98px) {
      .layout-main-step1 {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
    }

    /* æ™‚é–“æ ¼å­ */
    .time-grid {
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 4px;
      max-height: 380px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .time-row {
      display: contents;
    }

    .time-label {
      text-align: right;
      padding-right: 8px;
      color: #777;
      font-size: 0.78rem;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .time-cell {
      background-color: #fafbfc;
      border: 1px solid #dcdfe5;
      min-height: 36px;
      cursor: pointer;
      position: relative;
      border-radius: 8px;
      transition: all 0.16s ease-out;
    }

    .time-cell:hover {
      border-color: var(--cr-red);
      background-color: #fff7f7;
    }

    .time-cell.active {
      background-color: #fff3f3;
      border-color: var(--cr-red-dark);
      box-shadow: inset 0 0 0 1px rgba(225,6,0,0.15);
    }

    .cell-label {
      position: absolute;
      top: 6px;
      left: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--cr-black);
      max-width: calc(100% - 16px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* è¡Œç‚ºæŒ‰éˆ• */
    .cr-actions {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .cr-actions .btn {
      font-size: 0.85rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      border-radius: 999px;
      padding-block: 8px;
    }

    .btn-primary {
      background-color: var(--cr-red) !important;
      border-color: var(--cr-red) !important;
    }

    .btn-primary:hover {
      background-color: var(--cr-red-dark) !important;
      border-color: var(--cr-red-dark) !important;
    }

    .btn-outline-secondary {
      border-radius: 999px;
    }

    .btn-success {
      border-radius: 999px;
    }

    /* å³å´æ–‡å­—å€å¡Š */
    #aiResult,
    #reviewArea,
    #costResult {
      font-size: 0.88rem;
      line-height: 1.5;
    }
    #costResult {
      color: var(--cr-red-dark);
    }

    #statChart {
      max-height: 200px;
    }

    /* æ›´å¤š RWD èª¿æ•´ */
    @media (max-width: 480px) {
      .card-ui {
        padding: 16px 14px 14px;
        border-radius: 14px;
      }
      .time-grid {
        max-height: 320px;
      }
    }

    /* æ­·å²é¢æ¿è‰²ç³»å¾®èª¿ï¼ˆä¿æŒå¯ç”¨ï¼‰ */
    .history-panel {
      background-color: #111;
      color: #fff;
    }

    .history-header h3 {
      font-size: 1rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* æŠŠæ™‚é–“å·¥å…·æŒ‰éˆ• & é¢æ¿æ•´å€‹è—èµ·ä¾† */
    .tools-btn,
    #tools-panel {
      display: none !important;
    }
  </style>


  <link rel="stylesheet" href="cr-achievements.css">
</head>
<body>
  <div class="app-root">
    <!-- å·¦å´ç´€éŒ„é¢æ¿æŒ‰éˆ• -->

    <!-- å·¦å´ç´€éŒ„é¢æ¿ -->
    <div id="history-panel" class="history-panel">
      <div class="history-header">
        <h3>ä»»å‹™å®Œæˆç´€éŒ„</h3>
        <button id="close-history">âœ–</button>
      </div>

      <div class="history-mode">
        <button data-mode="week">æœ¬é€±</button>
        <button data-mode="month">æœ¬æœˆ</button>
      </div>

      <div id="history-summary" class="history-summary">
        <p>å®Œæˆç‡ï¼š<span id="history-rate">0%</span></p>
      </div>

      <div id="history-days" class="history-days">
        <!-- å‹•æ…‹æ’å…¥æ¯å¤©çš„ç´€éŒ„ -->
      </div>
    </div>

    <!-- ===== ä½¿ç”¨è€…æ•™å­¸å°å¡ ===== -->
    <div id="crOnboarding" class="cr-onboard">
      <div class="cr-onboard-card">
        <h2>ğŸ¯ æ­¡è¿ä¾†åˆ°è‡ªå¾‹æ§è‚‰é£¯ï¼</h2>
        <p>é€™è£¡æœ‰ä¸‰å€‹å°æŠ€å·§ï¼Œå¹«åŠ©ä½ æ›´è‡ªå¾‹ï¼š</p>
        <ol>
          <li>âœ… <b>å®Œæˆä»»å‹™</b> â†’ è‡ªå‹•æ›´æ–°å®Œæˆç‡</li>
          <li>ğŸ† <b>é€£çºŒå®Œæˆ</b> â†’ è§£é–æˆå°±å¾½ç« </li>
          <li>ğŸ“… <b>è¨­å®šé€±ç›®æ¨™</b> â†’ å¹«åŠ©é¤Šæˆå¥½ç¿’æ…£</li>
        </ol>
        <button id="crOnboardBtn">é–‹å§‹æŒ‘æˆ° ğŸš€</button>
      </div>
    </div>

    <!-- ğŸ” å°è¦½åˆ—ï¼šé»‘åº•ç´…ç·šï¼‹æµç¨‹æç¤º -->
  <!-- ğŸ” å°è¦½åˆ—ï¼šé»‘åº•ç´…ç·šï¼‹æµç¨‹æç¤º -->
  <nav class="navbar navbar-light shadow-sm mb-3 app-navbar">
    <div class="container-fluid">
      <div class="d-flex flex-column">
        <span class="navbar-brand mb-1 h6">ğŸ§  è‡ªå¾‹æ§è‚‰é£¯ Â· æ™‚é–“ç®¡å®¶</span>
        <div class="app-steps">
          <span>â‘  æ’å¥½ä»Šå¤©</span><span class="app-steps-dot">â€¢</span>
          <span>â‘¡ å‹¾é¸å®Œæˆ</span><span class="app-steps-dot">â€¢</span>
          <span>â‘¢ çœ‹ AI åˆ†æ & æˆæœ¬</span>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">

    <!-- æ­¥é©Ÿ header -->
    <div class="step-header">
      <div class="step-pills">
        <div id="step-indicator-1" class="step-pill current">
          <span class="step-num">STEP 1</span> æ’ç¨‹èˆ‡ AI å»ºè­°
        </div>
        <div id="step-indicator-2" class="step-pill">
          <span class="step-num">STEP 2</span> å‹¾é¸å®Œæˆï¼†æˆæœ¬åˆ†æ
        </div>
      </div>
    </div>

    <!-- STEP 1ï¼šæ’ç¨‹ + AI åˆ†æ -->
    <section id="step1" class="step-section active">
      <div class="layout-main-step1">
        <div>
          <div class="card-ui">
            <h5>ğŸ“… ä»Šæ—¥ä»»å‹™æ’ç¨‹</h5>
            <div id="timeGrid" class="time-grid"></div>
          </div>

          <div class="cr-actions">
            <button class="btn btn-success w-100" onclick="analyzeByAI()">ğŸ” åˆ†æç›®å‰æ’ç¨‹</button>
            <button class="btn btn-primary w-100" onclick="goStep(2)">â¡ ä¸‹ä¸€æ­¥ï¼šåˆ†ææœªå®Œæˆæˆæœ¬</button>
          </div>
        </div>

        <div>
          <div class="card-ui">
            <h5>ğŸ¤– AI æ™‚é–“å»ºè­°</h5>
            <div id="aiResult" style="white-space: pre-wrap; min-height: 120px;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- STEP 2ï¼šå‹¾é¸å®Œæˆ + æˆæœ¬åˆ†æ -->
    <section id="step2" class="step-section">
      <div class="mb-2">
        <button class="btn btn-outline-secondary btn-sm" onclick="goStep(1)">â† ä¸Šä¸€æ­¥ï¼šèª¿æ•´æ’ç¨‹</button>
      </div>

      <div class="card-ui">
        <h5>ğŸ“Œ ä»Šæ—¥å®Œæˆæƒ…æ³</h5>
        <p class="text-muted mb-1" style="font-size:0.82rem;">ç³»çµ±æœƒè‡ªå‹•åˆ—å‡ºä½ åœ¨ä¸Šä¸€æ­¥æ’å¥½çš„æ‰€æœ‰å€å¡Šï¼Œä½ å¯ä»¥å‹¾é¸å·²å®Œæˆçš„é …ç›®ã€‚</p>
        <div id="reviewArea" class="mb-2"></div>
        <button class="btn btn-outline-secondary btn-sm mt-1" onclick="reviewDay()">é‡æ–°ç”¢ç”Ÿæ¸…å–®</button>
      </div>

      <div class="card-ui">
        <h5>ğŸ’¸ æˆæœ¬åˆ†æå›é¥‹</h5>
        <p class="text-muted mb-1" style="font-size:0.82rem;">å‹¾å®Œæœªå®Œæˆçš„é …ç›®å¾Œï¼ŒæŒ‰ä¸‹ä¸‹é¢æŒ‰éˆ•ï¼Œè®“ AI å¹«ä½ ä¼°ç®—æ™‚é–“èˆ‡æˆæœ¬ã€‚</p>
        <button class="btn btn-primary w-100 mb-2" onclick="submitReviewAndAnalyzeCost()">ğŸ“Š åˆ†ææœªå®Œæˆæˆæœ¬</button>
        <div id="costResult" style="white-space: pre-wrap; min-height: 100px;"></div>
      </div>

      <div class="card-ui">
        <h5>ğŸ“ˆ ä»»å‹™å®Œæˆç‡çµ±è¨ˆ</h5>
        <canvas id="statChart" width="400" height="200"></canvas>
      </div>
    </section>

  </div>


  <!-- ===== ä¸‹é¢é–‹å§‹ï¼šåŸæœ¬çš„ JS / Supabase / å·¥å…·å€ï¼Œå®Œå…¨ä¸å‹•åŠŸèƒ½ï¼Œåªæ”¹éƒ¨åˆ†æ¨£å¼ ===== -->


  <script>
    function goStep(step) {
      const step1 = document.getElementById("step1");
      const step2 = document.getElementById("step2");
      const pill1 = document.getElementById("step-indicator-1");
      const pill2 = document.getElementById("step-indicator-2");
      if (!step1 || !step2) return;
  
      if (step === 1) {
        step1.classList.add("active");
        step2.classList.remove("active");
        pill1?.classList.add("current");
        pill2?.classList.remove("current");
        return;
      }
  
      if (step === 2) {
        // æ²’æœ‰æ’ä»»ä½•ä»»å‹™å°±ä¸è®“é€²ä¸‹ä¸€æ­¥
        const activeCells = Array.from(document.querySelectorAll(".time-cell.active"));
        if (activeCells.length === 0) {
          alert("è«‹å…ˆåœ¨ STEP 1 æ’å¥½ä»Šå¤©çš„è¡Œç¨‹ï¼Œå†é€²åˆ°ä¸‹ä¸€æ­¥å–”ï¼");
          return;
        }
        // è‡ªå‹•ç”¢ç”Ÿå‹¾é¸æ¸…å–®
        reviewDay();
  
        step1.classList.remove("active");
        step2.classList.add("active");
        pill1?.classList.remove("current");
        pill2?.classList.add("current");
      }
    }
  
    const timeGrid = document.getElementById("timeGrid");
    const timeStart = 8 * 60, timeEnd = 22 * 60, interval = 30;
  
    for (let t = timeStart; t < timeEnd; t += interval) {
      const row = document.createElement("div");
      row.className = "time-row";
      const h = Math.floor(t / 60).toString().padStart(2, '0');
      const m = (t % 60).toString().padStart(2, '0');
  
      const label = document.createElement("div");
      label.className = "time-label align-self-center";
      label.textContent = `${h}:${m}`;
  
      const cell = document.createElement("div");
      cell.className = "time-cell";
      cell.dataset.time = `${h}:${m}`;
      cell.onclick = () => {
        if (cell.classList.contains("active")) {
          cell.classList.remove("active");
          cell.textContent = "";
        } else {
          const activity = prompt("è«‹è¼¸å…¥æ´»å‹•å…§å®¹ï¼š");
          if (activity) {
            cell.classList.add("active");
            const span = document.createElement("span");
            span.className = "cell-label";
            span.textContent = activity;
            cell.textContent = "";
            cell.appendChild(span);
          }
        }
      };
  
      row.appendChild(label);
      row.appendChild(cell);
      timeGrid.appendChild(row);
    }
  
    function reviewDay() {
      const reviewArea = document.getElementById("reviewArea");
      const activeCells = Array.from(document.querySelectorAll(".time-cell.active"));
      if (activeCells.length === 0) {
        alert("âš ï¸ å°šæœªå¡«å¯«ä»»ä½•ä»»å‹™ï¼");
        return;
      }
      reviewArea.innerHTML = activeCells.map((cell, i) => {
        const time = cell.dataset.time;
        const content = cell.textContent.trim();
        return `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="review${i}" data-time="${time}" data-content="${content}" checked>
          <label class="form-check-label" for="review${i}">${time} - ${content}</label>
        </div>`;
      }).join("");
    }
  
    async function analyzeByAI() {
      const resultBox = document.getElementById("aiResult");
      const activeCells = Array.from(document.querySelectorAll(".time-cell.active"));
      if (activeCells.length === 0) {
        resultBox.textContent = "âš ï¸ è«‹å…ˆå¡«å…¥ä¸€äº›è¡Œç¨‹å…§å®¹å†åˆ†æå–”ï¼";
        return;
      }
      const summary = activeCells.map(cell => `- ${cell.dataset.time} ${cell.textContent.trim()}`).join("\n");
      const prompt = `ä»¥ä¸‹æ˜¯æˆ‘çš„ä»Šæ—¥æ’ç¨‹ï¼š\n${summary}\n\nè«‹ä½ æª¢æŸ¥é€™æ¨£çš„æ™‚é–“åˆ†é…æ˜¯å¦åˆç†ï¼Œæœ‰æ²’æœ‰å®‰æ’éåº¦å¯†é›†ã€ç©ºæª”éé•·ã€ç¼ºä¹ä¼‘æ¯ç­‰å•é¡Œï¼Œä¸¦æä¾›å„ªåŒ–å»ºè­°ï¼Œå¯ä»¥è¬›çš„è©³ç´°é»ï¼Œæœ€å¾Œå¤§æ¦‚çµ¦å€‹åˆç†çš„æ™‚é–“å®‰æ’è¡¨åƒè€ƒã€‚`;
      resultBox.textContent = "AI åˆ†æä¸­...";
      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        resultBox.textContent = data.result || "âš ï¸ æ²’æœ‰æ”¶åˆ° AI å›è¦†ï¼Œè«‹é‡è©¦ã€‚";

  
      } catch (err) {
        resultBox.textContent = "âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼ŒAI ç„¡æ³•å›è¦†ã€‚";
      }
    }
  
    async function submitReviewAndAnalyzeCost() {
      const checkboxes = Array.from(document.querySelectorAll('#reviewArea input[type="checkbox"]'));
      const incomplete = checkboxes.filter(cb => !cb.checked);
      const costBox = document.getElementById("costResult");
  
      if (incomplete.length === 0) {
        costBox.textContent = "âœ… ä»Šå¤©ä»»å‹™å…¨éƒ¨å®Œæˆï¼Œè®šè®šï¼";
        updateChart(checkboxes.length, 0);
        return;
      }
  
      const incompleteList = incomplete.map(cb => `- ${cb.dataset.time} ${cb.dataset.content}`);
      const prompt = `ä»¥ä¸‹æ˜¯æˆ‘ä»Šå¤©æ²’æœ‰å®Œæˆçš„ä»»å‹™ï¼š\n${incompleteList.join("\n")}\n\nè«‹ä½ æ¨ä¼°é€™äº›æœªå®Œæˆé …ç›®å¯èƒ½é€ æˆçš„æ™‚é–“èˆ‡é‡‘éŒ¢æˆæœ¬ï¼Œä»¥åŠå¦‚ä½•æ”¹å–„ï¼Œä¸¦çµ¦æˆ‘ä¸€é»äººæ€§åŒ–çš„é¼“å‹µæˆ–å»ºè­°ã€‚`;
  
      costBox.textContent = "AI åˆ†æä¸­...";
  
      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        costBox.textContent = data.result || "âš ï¸ æ²’æœ‰æ”¶åˆ° AI å›è¦†ã€‚";
  
      } catch (err) {
        costBox.textContent = "âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼ŒAI ç„¡æ³•å›è¦†ã€‚";
      }
  
      updateChart(checkboxes.length, incomplete.length);
    }
  
    function updateChart(total, uncompleted) {
      const completed = total - uncompleted;
      const ctx = document.getElementById('statChart').getContext('2d');
      if (window.taskChart) window.taskChart.destroy();
      window.taskChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['å®Œæˆ', 'æœªå®Œæˆ'],
          datasets: [{
            data: [completed, uncompleted],
            backgroundColor: ['#198754', '#dc3545']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
  </script>
  

  <!-- æˆå°± & Bootstrap æ“´å…… -->
  <script src="cr-achievements.js"></script>
  <script src="cr-bootstrap.js"></script>

  <!-- âŒ› æ™‚é–“å·¥å…·ï¼šæµ®å‹•æŒ‰éˆ• -->
  <div id="tools-toggle" class="tools-btn">âŒ› æ™‚é–“å·¥å…·</div>

  <!-- âŒ› æ™‚é–“å·¥å…·ï¼šå·¦å´é¢æ¿ï¼ˆçµæ§‹ä¸å‹•ï¼Œåªæ”¹é¡è‰²åœ¨å¾Œé¢ styleï¼‰ -->
  <aside id="tools-panel" class="tools-panel">
    <div class="tools-head">
      <div class="tools-title">æ™‚é–“å·¥å…·</div>
      <button id="tools-close" class="tools-close">âœ•</button>
    </div>

    <div class="tools-tabs">
      <button class="tools-tab is-active" data-tab="pomodoro">è•ƒèŒ„æ™‚é˜</button>
      <button class="tools-tab" data-tab="countdown">å€’æ•¸</button>
      <button class="tools-tab" data-tab="stopwatch">ç¢¼éŒ¶</button>
    </div>

    <!-- è•ƒèŒ„æ™‚é˜ -->
    <section class="tools-pane" id="pane-pomodoro" style="display:block;">
      <div class="tools-row">
        <label>å°ˆæ³¨(åˆ†)</label><input id="pomo-focus" type="number" min="1" value="25">
        <label>ä¼‘æ¯(åˆ†)</label><input id="pomo-break" type="number" min="1" value="5">
        <label>é•·ä¼‘(åˆ†)</label><input id="pomo-long" type="number" min="1" value="15">
        <label>å¾ªç’°</label><input id="pomo-rounds" type="number" min="1" value="4">
      </div>
      <div class="tools-timer" id="pomo-display">25:00</div>
      <div class="tools-actions">
        <button id="pomo-start" class="tools-btn-primary">é–‹å§‹</button>
        <button id="pomo-pause">æš«åœ</button>
        <button id="pomo-reset">é‡è¨­</button>
        <button id="pomo-skip">è·³ééšæ®µ</button>
        <label class="tools-inline"><input id="pomo-autonext" type="checkbox" checked> è‡ªå‹•é€²ä¸‹ä¸€éšæ®µ</label>
      </div>
      <div class="tools-sub">æ¨¡å¼ï¼š<span id="pomo-mode">å°ˆæ³¨</span>ï½œå®Œæˆå¾ªç’°ï¼š<span id="pomo-done">0</span></div>
      <div class="tools-sub">ä»Šæ—¥å®Œæˆç•ªèŒ„æ•¸ï¼š<span id="pomo-today">0</span></div>
    </section>

    <!-- å€’æ•¸ -->
    <section class="tools-pane" id="pane-countdown">
      <div class="tools-row">
        <label>å€’æ•¸åˆ†é˜</label><input id="cd-min" type="number" min="0" value="10">
        <label>ç§’</label><input id="cd-sec" type="number" min="0" max="59" value="0">
      </div>
      <div class="tools-timer" id="cd-display">10:00</div>
      <div class="tools-actions">
        <button id="cd-start" class="tools-btn-primary">é–‹å§‹</button>
        <button id="cd-pause">æš«åœ</button>
        <button id="cd-reset">é‡è¨­</button>
      </div>
    </section>

    <!-- ç¢¼éŒ¶ -->
    <section class="tools-pane" id="pane-stopwatch">
      <div class="tools-timer" id="sw-display">00:00.0</div>
      <div class="tools-actions">
        <button id="sw-start" class="tools-btn-primary">é–‹å§‹</button>
        <button id="sw-lap">åœˆæ•¸</button>
        <button id="sw-pause">æš«åœ</button>
        <button id="sw-reset">é‡è¨­</button>
      </div>
      <ol id="sw-laps" class="tools-laps"></ol>
    </section>
  </aside>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://rbtevdmunkjjevoeooli.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJidGV2ZG11bmtqamV2b2Vvb2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNzMxMjIsImV4cCI6MjA3NTg0OTEyMn0.XjWId9AynP3TrJJEKIXZcsvmAW4kHLgH4dGDGqBH9dw";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const LS_KEY = "crProgressV1";
    const LOGIN_PAGE = "https://pengdoucheng.github.io/supabase-test.html";

    document.addEventListener("DOMContentLoaded", async () => {
      const { data } = await sb.auth.getUser();
      const user = data.user;
      if (!user) {
        alert("è«‹å…ˆç™»å…¥");
        window.location.href = LOGIN_PAGE;
        return;
      }

      const hadCloud = await hydrateFromCloud(user);

      if (!hadCloud) {
        const local = safeParse(localStorage.getItem(LS_KEY));
        if (local) {
          await upsertProgress(user, local);
        }
      }

      attachCloudSync(user);
    });

    async function hydrateFromCloud(user){
      try {
        const { data, error } = await sb.from("cr_progress")
          .select("progress, updated_at")
          .eq("user_id", user.id)
          .maybeSingle();
        if (error) throw error;
        if (!data || !data.progress) return false;

        const local = safeParse(localStorage.getItem(LS_KEY));
        const cloudNewer = newer(data.updated_at, local?.updated_at);
        if (!local || cloudNewer) {
          localStorage.setItem(LS_KEY, JSON.stringify(data.progress));
          try {
            window.dispatchEvent(new CustomEvent("cr:progress-updated", { detail: data.progress }));
          } catch {}
        }
        return true;
      } catch (e) {
        console.warn("è®€å–é›²ç«¯é€²åº¦å¤±æ•—ï¼š", e);
        return false;
      }
    }

    function newer(cloudTs, localTs){
      if (!cloudTs) return false;
      if (!localTs) return true;
      return new Date(cloudTs).getTime() > new Date(localTs).getTime();
    }

    function safeParse(s){ try { return JSON.parse(s || ""); } catch { return null; } }

    async function upsertProgress(user, progress){
      try {
        if (typeof progress === "object" && progress) {
          if (!progress.updated_at) progress.updated_at = new Date().toISOString();
        }
        const { error } = await sb.from("cr_progress").upsert({
          user_id: user.id,
          progress,
          updated_at: new Date().toISOString()
        });
        if (error) throw error;
      } catch (e) {
        console.warn("åŒæ­¥é›²ç«¯å¤±æ•—ï¼š", e);
      }
    }

    function attachCloudSync(user){
      window.addEventListener("cr:progress-updated", async (ev) => {
        const progress = ev?.detail || safeParse(localStorage.getItem(LS_KEY)) || {};
        await upsertProgress(user, progress);
      });
    }
  </script>

  <script>
    async function getUser(){ return (await sb.auth.getUser()).data.user || null; }

    function toMin(hhmm){ const [h,m]=hhmm.split(":").map(Number); return h*60 + (m||0); }
    function toHHMM(min){ const h=Math.floor(min/60), m=min%60; return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`; }
    function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }

    async function addSchedule({ date, startHHMM, endHHMM, title }){
      const u = await getUser(); if(!u) throw new Error("å°šæœªç™»å…¥");
      const start_min = toMin(startHHMM), end_min = toMin(endHHMM);
      if (end_min <= start_min) throw new Error("çµæŸæ™‚é–“éœ€å¤§æ–¼é–‹å§‹æ™‚é–“");
      const { data, error } = await sb.from("schedules").insert([{
        user_id: u.id, date, start_min, end_min, title
      }]).select().single();
      if (error) throw error;
      return data;
    }

    async function loadSchedulesByDate(date){
      const u = await getUser(); if(!u) throw new Error("å°šæœªç™»å…¥");
      const { data, error } = await sb.from("schedules")
        .select("*")
        .eq("user_id", u.id)
        .eq("date", date)
        .order("start_min", { ascending: true });
      if (error) throw error;
      return data;
    }

    async function updateSchedule(id, patch){
      const upd = {};
      if (patch.startHHMM) upd.start_min = toMin(patch.startHHMM);
      if (patch.endHHMM)   upd.end_min   = toMin(patch.endHHMM);
      if (patch.title != null) upd.title = patch.title;
      upd.updated_at = new Date().toISOString();
      const { data, error } = await sb.from("schedules").update(upd).eq("id", id).select().single();
      if (error) throw error;
      return data;
    }

    async function deleteSchedule(id){
      const { error } = await sb.from("schedules").delete().eq("id", id);
      if (error) throw error;
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const user = await getUser();
      if (!user) return;

      const $date = document.querySelector("#sch-date");
      const $start = document.querySelector("#sch-start");
      const $end = document.querySelector("#sch-end");
      const $title = document.querySelector("#sch-title");
      const $add = document.querySelector("#sch-add");
      const $reload = document.querySelector("#sch-reload");
      const $list = document.querySelector("#sch-list");

      if ($date) $date.value = todayStr();

      async function render(){
        if (!$date) return;
        const rows = await loadSchedulesByDate($date.value);
        $list.innerHTML = rows.map(r => `
          <li style="display:flex;gap:8px;align-items:center;border:1px solid #eee;border-radius:8px;padding:8px 12px">
            <b>${r.title}</b>
            <span style="color:#666">${toHHMM(r.start_min)}â€“${toHHMM(r.end_min)}</span>
            <span style="margin-left:auto;display:flex;gap:6px">
              <button data-id="${r.id}" class="sch-edit">ç·¨è¼¯</button>
              <button data-id="${r.id}" class="sch-del">åˆªé™¤</button>
            </span>
          </li>
        `).join(rows.length ? "" : "<li style='color:#666'>é€™å¤©é‚„æ²’æœ‰æ’ç¨‹</li>");
      }

      if ($add) $add.addEventListener("click", async () => {
        try{
          const row = await addSchedule({
            date: $date.value,
            startHHMM: $start.value,
            endHHMM: $end.value,
            title: $title.value.trim() || "æœªå‘½å"
          });
          $title.value = "";
          await render();
        }catch(e){ alert(e.message || e); }
      });

      if ($reload) $reload.addEventListener("click", render);

      if ($list) $list.addEventListener("click", async (ev) => {
        const id = ev.target?.dataset?.id;
        if (!id) return;
        if (ev.target.classList.contains("sch-del")) {
          if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await deleteSchedule(id); await render(); }
        } else if (ev.target.classList.contains("sch-edit")) {
          const newTitle = prompt("æ–°æ¨™é¡Œï¼Ÿï¼ˆç•™ç©ºä¸æ”¹ï¼‰");
          const newStart = prompt("æ–°é–‹å§‹æ™‚é–“ï¼Ÿ(HH:MMï¼Œç•™ç©ºä¸æ”¹)");
          const newEnd   = prompt("æ–°çµæŸæ™‚é–“ï¼Ÿ(HH:MMï¼Œç•™ç©ºä¸æ”¹)");
          try{
            await updateSchedule(id, {
              title: newTitle === "" ? undefined : newTitle,
              startHHMM: newStart || undefined,
              endHHMM: newEnd || undefined
            });
            await render();
          }catch(e){ alert(e.message || e); }
        }
      });

      await render();

      sb.channel('schedules-rt')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'schedules' }, async () => {
          if (document.hasFocus()) await render();
        })
        .subscribe();
    });
  </script>

  <!-- é›²ç«¯åŒæ­¥ modal ï¼‹ RWD èª¿æ•´ï¼šä¸å‹•åŠŸèƒ½ï¼Œåªæ˜¯æ¨£å¼ -->
  <section id="sched-dev-panel" style="margin:24px 0;">
    
   
         
        </div>
      </div>
    </div>
  </section>

  <script>
  (() => {
    const openBtn   = document.getElementById('open-cloud-sync');
    const modal     = document.getElementById('cloud-modal');
    const backdrop  = document.getElementById('cloud-backdrop');
    const dialog    = document.getElementById('cloud-dialog');
    const closeBtn  = document.getElementById('close-cloud-sync');
    const iframe    = document.getElementById('cloud-iframe');

    const lockScroll = () => { document.documentElement.style.overflow = 'hidden'; };
    const unlockScroll = () => { document.documentElement.style.overflow = ''; };

    function resizeIframe() {
      const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
      const iframeH = Math.max(320, Math.min(vh * 0.86, vh - 64));
      iframe.style.height = iframeH + 'px';
    }

    function openModal() {
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden', 'false');
      lockScroll();
      resizeIframe();
      closeBtn.focus({ preventScroll: true });
    }

    function closeModal() {
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
      unlockScroll();
      openBtn.focus?.();
    }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);
    window.addEventListener('resize', resizeIframe);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
        closeModal();
      }
    });

    dialog.addEventListener('click', (e) => e.stopPropagation());
  })();
  </script>

  <!-- è¡Œå‹•ç‰ˆå¾®èª¿ï¼‹å·¥å…·æ¢ï¼æŒ‰éˆ•ç´…é»‘ç™½åŒ– -->
  <style>
    @media (max-width: 640px) {
      #cloud-dialog{ width:96vw; margin:2vh auto 0; border-radius:12px; }
      #cloud-dialog iframe{ height:84vh !important; }
    }

    /* å·¥å…·åˆ— + tabs æ¡ç´…é»‘ç™½ */
    #tools-bar, .tools-toggle, .tools-tabs {
      position: sticky;
      top: 0;
      z-index: 40;
      background: #ffffff;
      border-bottom: 1px solid #e1e2e7;
    }

    .tools-toggle {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: var(--cr-black);
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.86rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      cursor: pointer;
    }

    .tools-tabs button {
      border-radius: 0;
      border: none;
      padding-inline: 12px;
      font-size: 0.85rem;
    }

    .tools-tabs .tools-tab.is-active {
      color: var(--cr-red);
      border-bottom: 2px solid var(--cr-red);
      font-weight: 600;
    }

    .tools-pane {
      position: relative;
      z-index: 1;
      margin-top: var(--tools-offset, 12px);
      scroll-margin-top: var(--tools-offset, 12px);
    }

    .tools-row,
    .tools-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tools-timer {
      font-variant-numeric: tabular-nums;
      letter-spacing: .5px;
      font-size: clamp(28px, 4vw, 40px);
      line-height: 1;
      margin: 8px 0 10px;
    }

    .tools-actions button,
    .tools-row input[type="number"],
    .tools-row input[type="time"] {
      min-height: 34px;
    }

    .tools-btn-primary {
      background: var(--cr-red);
      color: #fff;
      border-radius: 999px;
      border: 0;
      padding-inline: 16px;
    }

    .tools-btn-primary:hover {
      background: var(--cr-red-dark);
    }
  </style>

  <script>
    (function () {
      const bar = document.querySelector('#tools-bar, .tools-toggle, .tools-tabs');
      if (!bar) return;

      const setOffset = () => {
        const h = bar.offsetHeight + 12;
        document.documentElement.style.setProperty('--tools-offset', h + 'px');
      };

      setOffset();
      window.addEventListener('resize', setOffset);
      const ro = new ResizeObserver(setOffset);
      ro.observe(bar);
    })();
  </script>
</body>
</html>

