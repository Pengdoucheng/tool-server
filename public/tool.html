<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI æ™‚é–“æ’ç¨‹èˆ‡æˆæœ¬åˆ†æ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f2f4f7;
      font-family: 'Noto Sans TC', sans-serif;
      color: #333;
    }
    .container {
      max-width: 960px;
      margin: auto;
    }
    .card-ui {
      background-color: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      padding: 24px;
      margin-bottom: 24px;
      transition: all 0.2s ease-in-out;
    }
    .card-ui:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }
    .time-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 4px;
    }
    .time-row {
      display: flex;
      gap: 4px;
    }
    .time-label {
      width: 80px;
      text-align: right;
      padding-right: 8px;
      color: #555;
    }
    .time-cell {
      flex: 1;
      background-color: #fff;
      border: 1px solid #ccc;
      min-height: 40px;
      cursor: pointer;
      position: relative;
      border-radius: 6px;
      transition: all 0.2s ease-in-out;
    }
    .time-cell.active {
      background-color: #e6f0ff;
      border-left: 4px solid #4a90e2;
    }
    .cell-label {
      position: absolute;
      top: 4px;
      left: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      color: #333;
    }
  </style>
  <link rel="stylesheet" href="cr-achievements.css">\n</head>
<body>
  <!-- å·¦å´ç´€éŒ„é¢æ¿æŒ‰éˆ• -->
<div id="history-toggle" class="history-btn">ğŸ“… ç´€éŒ„</div>

<!-- å·¦å´ç´€éŒ„é¢æ¿ -->
<div id="history-panel" class="history-panel">
  <div class="history-header">
    <h3>ä»»å‹™å®Œæˆç´€éŒ„</h3>
    <button id="close-history">âœ–</button>
  </div>

  <div class="history-mode">
    <button data-mode="week">æœ¬é€±</button>
    <button data-mode="month">æœ¬æœˆ</button>
  </div>

  <div id="history-summary" class="history-summary">
    <p>å®Œæˆç‡ï¼š<span id="history-rate">0%</span></p>
  </div>

  <div id="history-days" class="history-days">
    <!-- å‹•æ…‹æ’å…¥æ¯å¤©çš„ç´€éŒ„ -->
  </div>
</div>

  <!-- ===== ä½¿ç”¨è€…æ•™å­¸å°å¡ ===== -->
<div id="crOnboarding" class="cr-onboard">
  <div class="cr-onboard-card">
    <h2>ğŸ¯ æ­¡è¿ä¾†åˆ°è‡ªå¾‹æ§è‚‰é£¯ï¼</h2>
    <p>é€™è£¡æœ‰ä¸‰å€‹å°æŠ€å·§ï¼Œå¹«åŠ©ä½ æ›´è‡ªå¾‹ï¼š</p>
    <ol>
      <li>âœ… <b>å®Œæˆä»»å‹™</b> â†’ è‡ªå‹•æ›´æ–°å®Œæˆç‡</li>
      <li>ğŸ† <b>é€£çºŒå®Œæˆ</b> â†’ è§£é–æˆå°±å¾½ç« </li>
      <li>ğŸ“… <b>è¨­å®šé€±ç›®æ¨™</b> â†’ å¹«åŠ©é¤Šæˆå¥½ç¿’æ…£</li>
    </ol>
    <button id="crOnboardBtn">é–‹å§‹æŒ‘æˆ° ğŸš€</button>
  </div>
</div>

  <nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h4">ğŸ§  è‡ªå¾‹æ§è‚‰é£¯ Â· æ™‚é–“ç®¡å®¶</span>
    </div>
  </nav>

  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <div class="card-ui">
          <h5>ğŸ“… ä»Šæ—¥ä»»å‹™æ’ç¨‹</h5>
          <div id="timeGrid" class="time-grid"></div>
        </div>
        <div class="card-ui">
          <h5>ğŸ¯ æœ¬é€±ç›®æ¨™è¨­å®š</h5>
          <textarea class="form-control" id="goalInput" rows="4" placeholder="è¼¸å…¥ä½ çš„æœ¬é€±ç›®æ¨™ï¼Œä¾‹å¦‚ï¼šé‹å‹•3æ¬¡ã€å®Œæˆå ±å‘Šã€é–±è®€ä¸€æœ¬æ›¸..."></textarea>
        </div>
        <button class="btn btn-success w-100 mb-2" onclick="analyzeByAI()">ğŸ” åˆ†æç›®å‰æ’ç¨‹</button>
        <button class="btn btn-outline-secondary w-100 mb-2" onclick="reviewDay()">ğŸ“Œ å¡«å¯«å®Œæˆæƒ…æ³</button>
        <button class="btn btn-primary w-100" onclick="submitReviewAndAnalyzeCost()">ğŸ“Š åˆ†ææœªå®Œæˆæˆæœ¬</button>
      </div>
      <div class="col-md-6">
        <div class="card-ui">
          <h5>ğŸ¤– AI æ™‚é–“å»ºè­°</h5>
          <div id="aiResult" style="white-space: pre-wrap; min-height: 120px;"></div>
        </div>
        <div class="card-ui">
          <h5>ğŸ“Œ ä»Šæ—¥å®Œæˆæƒ…æ³</h5>
          <div id="reviewArea" class="mb-2"></div>
        </div>
        <div class="card-ui">
          <h5>ğŸ’¸ æˆæœ¬åˆ†æå›é¥‹</h5>
          <div id="costResult" class="text-danger" style="white-space: pre-wrap; min-height: 100px;"></div>
        </div>
        <div class="card-ui">
          <h5>ğŸ“ˆ ä»»å‹™å®Œæˆç‡çµ±è¨ˆ</h5>
          <canvas id="statChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const timeGrid = document.getElementById("timeGrid");
    const timeStart = 8 * 60, timeEnd = 22 * 60, interval = 30;

    for (let t = timeStart; t < timeEnd; t += interval) {
      const row = document.createElement("div");
      row.className = "time-row";
      const h = Math.floor(t / 60).toString().padStart(2, '0');
      const m = (t % 60).toString().padStart(2, '0');

      const label = document.createElement("div");
      label.className = "time-label align-self-center";
      label.textContent = `${h}:${m}`;

      const cell = document.createElement("div");
      cell.className = "time-cell";
      cell.dataset.time = `${h}:${m}`;
      cell.onclick = () => {
        if (cell.classList.contains("active")) {
          cell.classList.remove("active");
          cell.textContent = "";
        } else {
          const activity = prompt("è«‹è¼¸å…¥æ´»å‹•å…§å®¹ï¼š");
          if (activity) {
            cell.classList.add("active");
            const span = document.createElement("span");
            span.className = "cell-label";
            span.textContent = activity;
            cell.textContent = "";
            cell.appendChild(span);
            
          }
        }
      };
      

      row.appendChild(label);
      row.appendChild(cell);
      timeGrid.appendChild(row);
    }

    function reviewDay() {
      const reviewArea = document.getElementById("reviewArea");
      const activeCells = Array.from(document.querySelectorAll(".time-cell.active"));
      if (activeCells.length === 0) {
        alert("âš ï¸ å°šæœªå¡«å¯«ä»»ä½•ä»»å‹™ï¼");
        return;
      }
      reviewArea.innerHTML = activeCells.map((cell, i) => {
        const time = cell.dataset.time;
        const content = cell.textContent.trim();
        return `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="review${i}" data-time="${time}" data-content="${content}" checked>
          <label class="form-check-label" for="review${i}">${time} - ${content}</label>
        </div>`;
      }).join("");
    }

    async function analyzeByAI() {
      const resultBox = document.getElementById("aiResult");
      const activeCells = Array.from(document.querySelectorAll(".time-cell.active"));
      if (activeCells.length === 0) {
        resultBox.textContent = "âš ï¸ è«‹å…ˆå¡«å…¥ä¸€äº›è¡Œç¨‹å…§å®¹å†åˆ†æå–”ï¼";
        return;
      }
      const summary = activeCells.map(cell => `- ${cell.dataset.time} ${cell.textContent.trim()}`).join("\n");
      const prompt = `ä»¥ä¸‹æ˜¯æˆ‘çš„ä»Šæ—¥æ’ç¨‹ï¼š\n${summary}\n\nè«‹ä½ æª¢æŸ¥é€™æ¨£çš„æ™‚é–“åˆ†é…æ˜¯å¦åˆç†ï¼Œæœ‰æ²’æœ‰å®‰æ’éåº¦å¯†é›†ã€ç©ºæª”éé•·ã€ç¼ºä¹ä¼‘æ¯ç­‰å•é¡Œï¼Œä¸¦æä¾›å„ªåŒ–å»ºè­°ã€‚`;
      resultBox.textContent = "AI åˆ†æä¸­...";
      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        resultBox.textContent = data.result || "âš ï¸ æ²’æœ‰æ”¶åˆ° AI å›è¦†ï¼Œè«‹é‡è©¦ã€‚";

      } catch (err) {
        resultBox.textContent = "âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼ŒAI ç„¡æ³•å›è¦†ã€‚";
      }
    }

    async function submitReviewAndAnalyzeCost() {
      const checkboxes = Array.from(document.querySelectorAll('#reviewArea input[type="checkbox"]'));
      const incomplete = checkboxes.filter(cb => !cb.checked);
      const costBox = document.getElementById("costResult");

      if (incomplete.length === 0) {
        costBox.textContent = "âœ… ä»Šå¤©ä»»å‹™å…¨éƒ¨å®Œæˆï¼Œè®šè®šï¼";
        updateChart(checkboxes.length, 0);
        return;
      }

      const incompleteList = incomplete.map(cb => `- ${cb.dataset.time} ${cb.dataset.content}`);
      const prompt = `ä»¥ä¸‹æ˜¯æˆ‘ä»Šå¤©æ²’æœ‰å®Œæˆçš„ä»»å‹™ï¼š\n${incompleteList.join("\n")}\n\nè«‹ä½ æ¨ä¼°é€™äº›æœªå®Œæˆé …ç›®å¯èƒ½é€ æˆçš„æ™‚é–“èˆ‡é‡‘éŒ¢æˆæœ¬ï¼Œä»¥åŠå¦‚ä½•æ”¹å–„ï¼Œä¸¦çµ¦æˆ‘ä¸€é»äººæ€§åŒ–çš„é¼“å‹µæˆ–å»ºè­°ã€‚`;

      costBox.textContent = "AI åˆ†æä¸­...";

      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        costBox.textContent = data.result || "âš ï¸ æ²’æœ‰æ”¶åˆ° AI å›è¦†ã€‚";

      } catch (err) {
        costBox.textContent = "âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼ŒAI ç„¡æ³•å›è¦†ã€‚";
      }

      updateChart(checkboxes.length, incomplete.length);
    }

    function updateChart(total, uncompleted) {
      const completed = total - uncompleted;
      const ctx = document.getElementById('statChart').getContext('2d');
      if (window.taskChart) window.taskChart.destroy();
      window.taskChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['å®Œæˆ', 'æœªå®Œæˆ'],
          datasets: [{
            data: [completed, uncompleted],
            backgroundColor: ['#198754', '#dc3545']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
  </script>

    <section class="cr-card" style="margin:24px 0;">
      <div class="cr-title">æœ¬æœˆå®Œæˆç‡</div>
      <div class="cr-sub">ä»¥æœ¬æœˆå·²å»ºç«‹çš„ä»»å‹™ç‚ºåŸºç¤è¨ˆç®—ï¼Œå®Œæˆè¶Šå¤šè¶Šäº®çœ¼ã€‚</div>
      <div class="cr-progress">
        <div class="cr-progress-bar cr-gradient" data-cr-progress-bar></div>
      </div>
      <div class="cr-sub" style="margin-top:8px;">ç›®å‰ï¼š<span data-cr-progress-label>0%</span>ï½œé€£çºŒå®Œæˆï¼š<span data-cr-streak>0 å¤©</span></div>
      <div class="cr-grid" style="margin-top:16px;">
        <div>
          <div class="cr-title" style="font-size:16px;">æˆå°±å¾½ç« </div>
          <div class="cr-badges" data-cr-badges></div>
        </div>
        <div>
          <div class="cr-title" style="font-size:16px;">æœ¬é€±ç›®æ¨™</div>
          <ul class="cr-goals" data-cr-goals></ul>
          <div class="cr-actions" style="margin-top:10px;">
            <button class="cr-btn" id="crSetWeeklyGoals">è¨­å®šæœ¬é€±ç›®æ¨™</button>
            <button class="cr-btn" id="crQuickDone">å¿«é€Ÿ+1ï¼ˆæ¸¬è©¦ï¼‰</button>
          </div>
        </div>
      </div>
    </section>
    \n<script src="cr-achievements.js"></script>\n<script src="cr-bootstrap.js"></script>\n
  <!-- âŒ› æ™‚é–“å·¥å…·ï¼šæµ®å‹•æŒ‰éˆ• -->
<div id="tools-toggle" class="tools-btn">âŒ› æ™‚é–“å·¥å…·</div>

<!-- âŒ› æ™‚é–“å·¥å…·ï¼šå·¦å´é¢æ¿ -->
<aside id="tools-panel" class="tools-panel">
  <div class="tools-head">
    <div class="tools-title">æ™‚é–“å·¥å…·</div>
    <button id="tools-close" class="tools-close">âœ•</button>
  </div>

  <div class="tools-tabs">
    <button class="tools-tab is-active" data-tab="pomodoro">è•ƒèŒ„æ™‚é˜</button>
    <button class="tools-tab" data-tab="countdown">å€’æ•¸</button>
    <button class="tools-tab" data-tab="stopwatch">ç¢¼éŒ¶</button>
  </div>

  <!-- è•ƒèŒ„æ™‚é˜ -->
  <section class="tools-pane" id="pane-pomodoro" style="display:block;">
    <div class="tools-row">
      <label>å°ˆæ³¨(åˆ†)</label><input id="pomo-focus" type="number" min="1" value="25">
      <label>ä¼‘æ¯(åˆ†)</label><input id="pomo-break" type="number" min="1" value="5">
      <label>é•·ä¼‘(åˆ†)</label><input id="pomo-long" type="number" min="1" value="15">
      <label>å¾ªç’°</label><input id="pomo-rounds" type="number" min="1" value="4">
    </div>
    <div class="tools-timer" id="pomo-display">25:00</div>
    <div class="tools-actions">
      <button id="pomo-start" class="tools-btn-primary">é–‹å§‹</button>
      <button id="pomo-pause">æš«åœ</button>
      <button id="pomo-reset">é‡è¨­</button>
      <button id="pomo-skip">è·³ééšæ®µ</button>
      <label class="tools-inline"><input id="pomo-autonext" type="checkbox" checked> è‡ªå‹•é€²ä¸‹ä¸€éšæ®µ</label>
    </div>
    <div class="tools-sub">æ¨¡å¼ï¼š<span id="pomo-mode">å°ˆæ³¨</span>ï½œå®Œæˆå¾ªç’°ï¼š<span id="pomo-done">0</span></div>
    <div class="tools-sub">ä»Šæ—¥å®Œæˆç•ªèŒ„æ•¸ï¼š<span id="pomo-today">0</span></div>
  </section>

  <!-- å€’æ•¸ -->
  <section class="tools-pane" id="pane-countdown">
    <div class="tools-row">
      <label>å€’æ•¸åˆ†é˜</label><input id="cd-min" type="number" min="0" value="10">
      <label>ç§’</label><input id="cd-sec" type="number" min="0" max="59" value="0">
    </div>
    <div class="tools-timer" id="cd-display">10:00</div>
    <div class="tools-actions">
      <button id="cd-start" class="tools-btn-primary">é–‹å§‹</button>
      <button id="cd-pause">æš«åœ</button>
      <button id="cd-reset">é‡è¨­</button>
    </div>
  </section>

  <!-- ç¢¼éŒ¶ -->
  <section class="tools-pane" id="pane-stopwatch">
    <div class="tools-timer" id="sw-display">00:00.0</div>
    <div class="tools-actions">
      <button id="sw-start" class="tools-btn-primary">é–‹å§‹</button>
      <button id="sw-lap">åœˆæ•¸</button>
      <button id="sw-pause">æš«åœ</button>
      <button id="sw-reset">é‡è¨­</button>
    </div>
    <ol id="sw-laps" class="tools-laps"></ol>
  </section>
</aside>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // âœ… å’Œç™»å…¥é åŒä¸€çµ„å°ˆæ¡ˆåƒæ•¸ï¼ˆä½ å¯ä»¥ç›´æ¥æ²¿ç”¨é€™å…©å€‹ï¼‰
  const SUPABASE_URL = "https://rbtevdmunkjjevoeooli.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJidGV2ZG11bmtqamV2b2Vvb2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNzMxMjIsImV4cCI6MjA3NTg0OTEyMn0.XjWId9AynP3TrJJEKIXZcsvmAW4kHLgH4dGDGqBH9dw";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ä½ ç›®å‰æœ¬æ©Ÿé€²åº¦ç”¨çš„ keyï¼ˆcr-achievements.js å·²åœ¨ç”¨ï¼‰
  const LS_KEY = "crProgressV1";

  // æ²’ç™»å…¥å°±å°å›ç™»å…¥é ï¼ˆæ”¾ä½ çš„ GitHub Pages ç™»å…¥æª”ç¶²å€ï¼‰
  const LOGIN_PAGE = "https://pengdoucheng.github.io/supabase-test.html";

  // --- å•Ÿå‹•ï¼šæª¢æŸ¥ç™»å…¥ï¼ŒçŒé›²ç«¯è³‡æ–™ï¼Œç¶å®šåŒæ­¥ ---
  document.addEventListener("DOMContentLoaded", async () => {
    const { data } = await sb.auth.getUser();
    const user = data.user;
    if (!user) {
      alert("è«‹å…ˆç™»å…¥");
      window.location.href = LOGIN_PAGE;
      return;
    }

    // 1) å…ˆæŠŠé›²ç«¯çš„é€²åº¦çŒå›æœ¬æ©Ÿï¼ˆè‹¥æœ‰ï¼‰
    const hadCloud = await hydrateFromCloud(user);

    // 2) å¦‚æœé›²ç«¯æ²’æœ‰ï¼Œè€Œæœ¬æ©Ÿæœ‰èˆŠè³‡æ–™ â†’ ä¸»å‹•ä¸Šå‚³ä¸€æ¬¡ï¼Œå»ºç«‹ç¬¬ä¸€ä»½é›²ç«¯å‚™ä»½
    if (!hadCloud) {
      const local = safeParse(localStorage.getItem(LS_KEY));
      if (local) {
        await upsertProgress(user, local);
      }
    }

    // 3) ç›£è½ä½ åŸæœ¬ç¨‹å¼æ¯æ¬¡æ›´æ–°é€²åº¦æ™‚æ‹‹å‡ºçš„äº‹ä»¶ â†’ ä¸Šå‚³åˆ°é›²ç«¯
    attachCloudSync(user);
  });

  // ä¸‹è¼‰é›²ç«¯ â†’ çŒæœ¬æ©Ÿï¼ˆæˆåŠŸå›å‚³ trueï¼Œå¦å‰‡ falseï¼‰
  async function hydrateFromCloud(user){
    try {
      const { data, error } = await sb.from("cr_progress")
        .select("progress, updated_at")
        .eq("user_id", user.id)
        .maybeSingle();
      if (error) throw error;
      if (!data || !data.progress) return false;

      // å¦‚æœä½ æœªå­˜æœ¬æ©Ÿæˆ–é›²ç«¯è¼ƒæ–° â†’ è¦†è“‹æœ¬æ©Ÿ
      const local = safeParse(localStorage.getItem(LS_KEY));
      const cloudNewer = newer(data.updated_at, local?.updated_at);
      if (!local || cloudNewer) {
        localStorage.setItem(LS_KEY, JSON.stringify(data.progress));
        // é€šçŸ¥ç¾æœ‰ UI é‡ç®—/é‡ç•«ï¼ˆä½ åŸæœ¬ç¨‹å¼æœ‰åœ¨è½é€™å€‹äº‹ä»¶ï¼‰
        try {
          window.dispatchEvent(new CustomEvent("cr:progress-updated", { detail: data.progress }));
        } catch {}
      }
      return true;
    } catch (e) {
      console.warn("è®€å–é›²ç«¯é€²åº¦å¤±æ•—ï¼š", e);
      return false;
    }
  }

  function newer(cloudTs, localTs){
    if (!cloudTs) return false;
    if (!localTs) return true;
    return new Date(cloudTs).getTime() > new Date(localTs).getTime();
  }

  function safeParse(s){ try { return JSON.parse(s || ""); } catch { return null; } }

  async function upsertProgress(user, progress){
    try {
      // ä½ æœ¬æ©Ÿ JSON è‹¥æ²’æœ‰ updated_atï¼Œæˆ‘å€‘åœ¨é€™è£¡è£œä¸€å€‹æ™‚é–“æˆ³
      if (typeof progress === "object" && progress) {
        if (!progress.updated_at) progress.updated_at = new Date().toISOString();
      }
      const { error } = await sb.from("cr_progress").upsert({
        user_id: user.id,
        progress,
        updated_at: new Date().toISOString()
      });
      if (error) throw error;
      // console.log("âœ… å·²åŒæ­¥é›²ç«¯");
    } catch (e) {
      console.warn("åŒæ­¥é›²ç«¯å¤±æ•—ï¼š", e);
    }
  }

  function attachCloudSync(user){
    // ä½ çš„ cr-achievements.js æ¯æ¬¡å„²å­˜å¾Œæœƒä¸Ÿå‡ºé€™å€‹äº‹ä»¶
    window.addEventListener("cr:progress-updated", async (ev) => {
      const progress = ev?.detail || safeParse(localStorage.getItem(LS_KEY)) || {};
      await upsertProgress(user, progress);
    });
  }
</script>

<script>
  // è‹¥å‰é¢å·²æœ‰ sbã€getUser()ï¼Œå¯åˆªé€™å…©å€‹é‡è¤‡çš„å¯¦ä½œ
  // const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  async function getUser(){ return (await sb.auth.getUser()).data.user || null; }

  // æ™‚é–“å·¥å…·ï¼šå­—ä¸²<->åˆ†é˜
  function toMin(hhmm){ const [h,m]=hhmm.split(":").map(Number); return h*60 + (m||0); }
  function toHHMM(min){ const h=Math.floor(min/60), m=min%60; return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`; }
  function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }

  // CRUD å°è£
  async function addSchedule({ date, startHHMM, endHHMM, title }){
    const u = await getUser(); if(!u) throw new Error("å°šæœªç™»å…¥");
    const start_min = toMin(startHHMM), end_min = toMin(endHHMM);
    if (end_min <= start_min) throw new Error("çµæŸæ™‚é–“éœ€å¤§æ–¼é–‹å§‹æ™‚é–“");
    const { data, error } = await sb.from("schedules").insert([{
      user_id: u.id, date, start_min, end_min, title
    }]).select().single();
    if (error) throw error;
    return data;
  }

  async function loadSchedulesByDate(date){
    const u = await getUser(); if(!u) throw new Error("å°šæœªç™»å…¥");
    const { data, error } = await sb.from("schedules")
      .select("*")
      .eq("user_id", u.id)
      .eq("date", date)
      .order("start_min", { ascending: true });
    if (error) throw error;
    return data;
  }

  async function updateSchedule(id, patch){ // patch: { startHHMM?, endHHMM?, title? }
    const upd = {};
    if (patch.startHHMM) upd.start_min = toMin(patch.startHHMM);
    if (patch.endHHMM)   upd.end_min   = toMin(patch.endHHMM);
    if (patch.title != null) upd.title = patch.title;
    upd.updated_at = new Date().toISOString();
    const { data, error } = await sb.from("schedules").update(upd).eq("id", id).select().single();
    if (error) throw error;
    return data;
  }

  async function deleteSchedule(id){
    const { error } = await sb.from("schedules").delete().eq("id", id);
    if (error) throw error;
  }

  // è‡¨æ™‚é¢æ¿çš„ UI ç¶å®šï¼ˆé©—è­‰ç”¨ï¼‰
  document.addEventListener("DOMContentLoaded", async () => {
    const user = await getUser();
    if (!user) return; // ä½ å‰é¢çš„ç™»å…¥æª¢æŸ¥æœƒå°å›ç™»å…¥é 

    const $date = document.querySelector("#sch-date");
    const $start = document.querySelector("#sch-start");
    const $end = document.querySelector("#sch-end");
    const $title = document.querySelector("#sch-title");
    const $add = document.querySelector("#sch-add");
    const $reload = document.querySelector("#sch-reload");
    const $list = document.querySelector("#sch-list");

    if ($date) $date.value = todayStr();

    async function render(){
      if (!$date) return;
      const rows = await loadSchedulesByDate($date.value);
      $list.innerHTML = rows.map(r => `
        <li style="display:flex;gap:8px;align-items:center;border:1px solid #eee;border-radius:8px;padding:8px 12px">
          <b>${r.title}</b>
          <span style="color:#666">${toHHMM(r.start_min)}â€“${toHHMM(r.end_min)}</span>
          <span style="margin-left:auto;display:flex;gap:6px">
            <button data-id="${r.id}" class="sch-edit">ç·¨è¼¯</button>
            <button data-id="${r.id}" class="sch-del">åˆªé™¤</button>
          </span>
        </li>
      `).join(rows.length ? "" : "<li style='color:#666'>é€™å¤©é‚„æ²’æœ‰æ’ç¨‹</li>");
    }

    if ($add) $add.addEventListener("click", async () => {
      try{
        const row = await addSchedule({
          date: $date.value,
          startHHMM: $start.value,
          endHHMM: $end.value,
          title: $title.value.trim() || "æœªå‘½å"
        });
        $title.value = "";
        await render();
      }catch(e){ alert(e.message || e); }
    });

    if ($reload) $reload.addEventListener("click", render);

    // åˆªé™¤ / ç·¨è¼¯ï¼ˆç°¡å–®ç¤ºä¾‹ï¼‰
    if ($list) $list.addEventListener("click", async (ev) => {
      const id = ev.target?.dataset?.id;
      if (!id) return;
      if (ev.target.classList.contains("sch-del")) {
        if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await deleteSchedule(id); await render(); }
      } else if (ev.target.classList.contains("sch-edit")) {
        const newTitle = prompt("æ–°æ¨™é¡Œï¼Ÿï¼ˆç•™ç©ºä¸æ”¹ï¼‰");
        const newStart = prompt("æ–°é–‹å§‹æ™‚é–“ï¼Ÿ(HH:MMï¼Œç•™ç©ºä¸æ”¹)");
        const newEnd   = prompt("æ–°çµæŸæ™‚é–“ï¼Ÿ(HH:MMï¼Œç•™ç©ºä¸æ”¹)");
        try{
          await updateSchedule(id, {
            title: newTitle === "" ? undefined : newTitle,
            startHHMM: newStart || undefined,
            endHHMM: newEnd || undefined
          });
          await render();
        }catch(e){ alert(e.message || e); }
      }
    });

    // åˆæ¬¡è¼‰å…¥
    await render();

    // ï¼ˆå¯é¸ï¼‰Realtimeï¼šå¤šäºº/å¤šè£ç½®æ™‚è‡ªå‹•åˆ·æ–°
    sb.channel('schedules-rt')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'schedules' }, async () => {
        if (document.hasFocus()) await render();
      })
      .subscribe();
  });
</script>


<!-- è‡¨æ™‚ï¼šæ’ç¨‹é¢æ¿ï¼ˆå…ˆé©—è­‰åŠŸèƒ½ï¼Œä¹‹å¾Œå¯ç§»é™¤æˆ–æ›æˆä½ çš„æ™‚é–“æ ¼ UIï¼‰ -->
<section id="sched-dev-panel" style="margin:24px 0;padding:12px;border:1px solid #eee;border-radius:8px">
  <iframe src="cloud-sync-widget.html" style="width:100%;height:720px;border:0;border-radius:12px;overflow:hidden;"></iframe>

</section>

<iframe src="cloud-progress-achievements.html" style="width:100%;height:720px;border:0;border-radius:12px;overflow:hidden"></iframe>





<script>
  /* ====== Supabase åˆå§‹åŒ–ï¼ˆè‹¥ä½ é é¢å·²ç¶“æœ‰ï¼Œå°±åˆªæ‰é€™æ®µé‡è¤‡çš„ constï¼Œæ”¹ç”¨ window.sbï¼‰ ====== */
  
  window.sb = window.sb || supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
  /* ====== å°å·¥å…· ====== */
  async function __getUser(){ const { data } = await sb.auth.getUser(); return data?.user || null; }
  function __today(){ return new Date().toISOString().slice(0,10); }
  function __toMin(hhmm){ const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
  function __fmt(min){ return String(Math.floor(min/60)).padStart(2,'0')+':'+String(min%60).padStart(2,'0'); }
  
  /* ====== 1) æŠŠã€Œæ™‚é–“å€å¡Šã€åŒæ­¥åˆ° cloud_tasks ======
     è¦å‰‡ï¼š
     - åªåŒæ­¥ .time-cell.activeï¼ˆæœ‰ä½ ç›®å‰è¼¸å…¥çš„é‚£äº›æ ¼ï¼‰
     - start = è©²æ ¼ data-time
     - end = ä¸‹ä¸€æ ¼ data-timeï¼›è‹¥æ²’æœ‰ä¸‹ä¸€æ ¼å°± +30 åˆ†
  */
  async function syncTimeGridToCloud(){
    const u = await __getUser(); if(!u){ alert("è«‹å…ˆç™»å…¥å¸³è™Ÿ"); return 0; }
    const dateStr = __today();
    const cells = Array.from(document.querySelectorAll(".time-cell.active"));
    const rows = [];
    for (let i=0;i<cells.length;i++){
      const c = cells[i];
      const txt = (c.textContent || "").trim();
      if(!txt) continue;
      const startHH = c.dataset.time || c.getAttribute("data-time");
      if(!startHH) continue;
      let endMin = __toMin(startHH) + 30;
      const next = c.nextElementSibling;
      if(next && next.classList.contains("time-cell")){
        const endHH = next.dataset.time || next.getAttribute("data-time");
        if(endHH) endMin = __toMin(endHH);
      }
      rows.push({ user_id: u.id, date: dateStr, start_min: __toMin(startHH), end_min: endMin, title: txt, done: false });
    }
    // å…ˆæ¸…ä»Šå¤©å†å¯«å…¥ï¼Œé¿å…é‡è¤‡
    await sb.from("cloud_tasks").delete().eq("user_id", u.id).eq("date", dateStr);
    if(rows.length) await sb.from("cloud_tasks").insert(rows);
    return rows.length;
  }
  
  /* ====== 2) è¨ˆç®—ä»Šæ—¥å®Œæˆç‡ï¼ˆå¾ cloud_tasks çš„ done å‹¾é¸ï¼‰ ====== */
  async function calcTodayRate(){
    const u = await __getUser(); if(!u) return { total:0, done:0, rate:0 };
    const { data, error } = await sb.from("cloud_tasks").select("done").eq("user_id", u.id).eq("date", __today());
    if(error){ console.warn(error); return { total:0, done:0, rate:0 }; }
    const total = data?.length || 0;
    const done  = (data||[]).filter(x=>x.done).length;
    const rate  = total ? Math.round(done*100/total) : 0;
    return { total, done, rate };
  }
  
  /* ====== 3) æŠŠä»Šæ—¥è¦†è“‹å­˜åˆ° cloud_tasks_archive ====== */
  async function archiveToday(){
    const u = await __getUser(); if(!u) return 0;
    const dateStr = __today();
    const { data } = await sb.from("cloud_tasks").select("*").eq("user_id", u.id).eq("date", dateStr);
    const rows = data || [];
    await sb.from("cloud_tasks_archive").delete().eq("user_id", u.id).eq("date", dateStr);
    if(rows.length){
      const payload = rows.map(r=>({ user_id:u.id, date:r.date, start_min:r.start_min, end_min:r.end_min, title:r.title, done:r.done }));
      await sb.from("cloud_tasks_archive").insert(payload);
    }
    return rows.length;
  }
  
  /* ====== 4) è¨ˆç®—æˆå°± ======
     è¦å‰‡ï¼ˆå¯å†æ“´å……ï¼‰ï¼š
     - ğŸŒ… æ—©èµ·é”æˆï¼šä»Šæ—¥ç¬¬ä¸€ç­† start_min < 08:00
     - ğŸ’ª ä»Šæ—¥å…¨å‹¤ï¼šä»Šæ—¥ä»»å‹™æ•¸ â‰¥ 3 ä¸” å®Œæˆç‡ â‰¥ 80%
     - ğŸ”¥ é€£çºŒæŒ‘æˆ°è€…ï¼šé€£çºŒ â‰¥3 å¤©çš„æ—¥å®Œæˆç‡ â‰¥ 60%
     - ğŸŒ• è‡ªå¾‹ä¹‹æœˆï¼šç•¶æœˆå¹³å‡å®Œæˆç‡ â‰¥ 70%
  */
  async function computeAchievements(){
    const u = await __getUser(); if(!u) return [];
    const today = __today();
    const mStart = new Date(); mStart.setDate(1);
    const monthStart = mStart.toISOString().slice(0,10);
  
    // æ’ˆæœ¬æœˆçš„ archive è³‡æ–™ï¼ˆåªçœ‹å·²å­˜æª”çš„ï¼‰
    const { data, error } = await sb
      .from("cloud_tasks_archive")
      .select("date, start_min, done")
      .eq("user_id", u.id).gte("date", monthStart).lte("date", today);
    if(error || !data?.length) return [];
  
    // èšåˆæ¯æ—¥
    const daily = {};
    for(const r of data){
      daily[r.date] ??= { total:0, done:0, firstStart:1440 };
      daily[r.date].total++;
      if(r.done) daily[r.date].done++;
      if(r.start_min < daily[r.date].firstStart) daily[r.date].firstStart = r.start_min;
    }
  
    // å¹³å‡å®Œæˆç‡
    const rates = Object.values(daily).map(v => v.done / v.total);
    const avg = rates.length ? (rates.reduce((a,b)=>a+b,0) / rates.length) : 0;
  
    // é€£çºŒ >=60%
    const days = Object.keys(daily).sort(); // yyyy-mm-dd
    let best = 0, cur = 0;
    for(const d of days){
      const v = daily[d];
      if(v.total && (v.done/v.total)>=0.6){ cur++; best = Math.max(best, cur); }
      else cur = 0;
    }
  
    const ach = [];
    const td = daily[today];
    if (td && td.firstStart < 8*60) ach.push("ğŸŒ… æ—©èµ·é”æˆ");
    if (td && td.total>=3 && (td.done/td.total)>=0.8) ach.push("ğŸ’ª ä»Šæ—¥å…¨å‹¤");
    if (best >= 3) ach.push("ğŸ”¥ é€£çºŒæŒ‘æˆ°è€…");
    if (avg >= 0.7) ach.push("ğŸŒ• è‡ªå¾‹ä¹‹æœˆ");
  
    return ach;
  }
  
  /* ====== 5) ç•«é¢é¡¯ç¤ºæˆå°±ï¼ˆæ”¾åœ¨ä½ é é¢åˆé©çš„ä½ç½®ï¼‰ ====== */
  function renderAchievements(list){
    let box = document.querySelector("#achievementsBox");
    if(!box){
      box = document.createElement("section");
      box.id = "achievementsBox";
      box.className = "container";
      box.style.margin = "16px auto";
      box.innerHTML = `
        <div style="border:1px solid #e6e7eb;border-radius:12px;padding:12px;background:#f8f9fb;">
          <div style="font-weight:700;margin-bottom:6px;">ğŸ† æˆå°±</div>
          <div id="achList" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        </div>`;
      const target = document.querySelector(".container") || document.body;
      target.appendChild(box);
    }
    const listEl = box.querySelector("#achList");
    listEl.innerHTML = list.length
      ? list.map(s => `<span style="padding:4px 8px;border:1px solid #ddd;border-radius:999px;background:#fff;">${s}</span>`).join("")
      : `<span style="color:#666">ç›®å‰æ²’æœ‰å¯å±•ç¤ºçš„æˆå°±ï¼Œå…ˆæŠŠä»Šå¤©ã€Œå­˜å…¥æ­·å²ã€å§ã€‚</span>`;
  }
  
  /* ====== 6) æ•´åˆï¼šçµ¦ã€Œå„²å­˜ã€æŒ‰éˆ•å‘¼å«çš„ä¸»æµç¨‹ ====== */
  async function Save_Cloud_Archive_Achievements(){
    try{
      const synced = await syncTimeGridToCloud(); // å…ˆæŠŠä»Šå¤©æ™‚é–“æ ¼å¯«å…¥ cloud_tasks
      const rate = await calcTodayRate();         // ç®—å®Œæˆç‡ï¼ˆçœ‹ cloud_tasks çš„å‹¾é¸ç‹€æ…‹ï¼‰
      const archived = await archiveToday();      // è¦†è“‹å­˜åˆ° cloud_tasks_archive
      const ach = await computeAchievements();    // ç®—æˆå°±ï¼ˆæœ¬æœˆ+ä»Šæ—¥ï¼‰
      renderAchievements(ach);                    // é¡¯ç¤ºæˆå°±
      alert(`å·²å„²å­˜ï¼šä»Šæ—¥ ${rate.done}/${rate.total}ï¼ˆ${rate.rate}%ï¼‰ï¼Œæ­·å²å¯«å…¥ ${archived} ç­†ã€‚`);
    }catch(e){
      console.error(e);
      alert("å„²å­˜æµç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š"+(e.message||e));
    }
  }
  </script>
  
  </body>
</html>



