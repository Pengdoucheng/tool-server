<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI æ™‚é–“æ’ç¨‹èˆ‡æˆæœ¬åˆ†æ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f2f4f7;
      font-family: 'Noto Sans TC', sans-serif;
      color: #333;
    }
    .container {
      max-width: 960px;
      margin: auto;
    }
    .card-ui {
      background-color: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      padding: 24px;
      margin-bottom: 24px;
      transition: all 0.2s ease-in-out;
    }
    .card-ui:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }
    .time-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 4px;
    }
    .time-row {
      display: flex;
      gap: 4px;
    }
    .time-label {
      width: 80px;
      text-align: right;
      padding-right: 8px;
      color: #555;
    }
    .time-cell {
      flex: 1;
      background-color: #fff;
      border: 1px solid #ccc;
      min-height: 40px;
      cursor: pointer;
      position: relative;
      border-radius: 6px;
      transition: all 0.2s ease-in-out;
    }
    .time-cell.active {
      background-color: #e6f0ff;
      border-left: 4px solid #4a90e2;
    }
    .cell-label {
      position: absolute;
      top: 4px;
      left: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      color: #333;
    }
  </style>
  <link rel="stylesheet" href="cr-achievements.css"></head>
<body>
  <!-- å·¦å´ç´€éŒ„é¢æ¿æŒ‰éˆ• -->


<!-- å·¦å´ç´€éŒ„é¢æ¿ -->
<div id="history-panel" class="history-panel">
  <div class="history-header">
    <h3>ä»»å‹™å®Œæˆç´€éŒ„</h3>
    <button id="close-history">âœ–</button>
  </div>

  <div class="history-mode">
    <button data-mode="week">æœ¬é€±</button>
    <button data-mode="month">æœ¬æœˆ</button>
  </div>

  <div id="history-summary" class="history-summary">
    <p>å®Œæˆç‡ï¼š<span id="history-rate">0%</span></p>
  </div>

  <div id="history-days" class="history-days">
    <!-- å‹•æ…‹æ’å…¥æ¯å¤©çš„ç´€éŒ„ -->
  </div>
</div>

  <!-- ===== ä½¿ç”¨è€…æ•™å­¸å°å¡ ===== -->
<div id="crOnboarding" class="cr-onboard">
  <div class="cr-onboard-card">
    <h2>ğŸ¯ æ­¡è¿ä¾†åˆ°è‡ªå¾‹æ§è‚‰é£¯ï¼</h2>
    <p>é€™è£¡æœ‰ä¸‰å€‹å°æŠ€å·§ï¼Œå¹«åŠ©ä½ æ›´è‡ªå¾‹ï¼š</p>
    <ol>
      <li>âœ… <b>å®Œæˆä»»å‹™</b> â†’ è‡ªå‹•æ›´æ–°å®Œæˆç‡</li>
      <li>ğŸ† <b>é€£çºŒå®Œæˆ</b> â†’ è§£é–æˆå°±å¾½ç« </li>
      <li>ğŸ“… <b>è¨­å®šé€±ç›®æ¨™</b> â†’ å¹«åŠ©é¤Šæˆå¥½ç¿’æ…£</li>
    </ol>
    <button id="crOnboardBtn">é–‹å§‹æŒ‘æˆ° ğŸš€</button>
  </div>
</div>

  <nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h4">ğŸ§  è‡ªå¾‹æ§è‚‰é£¯ Â· æ™‚é–“ç®¡å®¶</span>
    </div>
  </nav>

  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <div class="card-ui">
          <h5>ğŸ“… ä»Šæ—¥ä»»å‹™æ’ç¨‹</h5>
          <div id="timeGrid" class="time-grid"></div>
        </div>
       
        <button class="btn btn-success w-100 mb-2" onclick="analyzeByAI()">ğŸ” åˆ†æç›®å‰æ’ç¨‹</button>
        <button class="btn btn-outline-secondary w-100 mb-2" onclick="reviewDay()">ğŸ“Œ å¡«å¯«å®Œæˆæƒ…æ³</button>
        <button class="btn btn-primary w-100" onclick="submitReviewAndAnalyzeCost()">ğŸ“Š åˆ†ææœªå®Œæˆæˆæœ¬</button>
      </div>
      <div class="col-md-6">
        <div class="card-ui">
          <h5>ğŸ¤– AI æ™‚é–“å»ºè­°</h5>
          <div id="aiResult" style="white-space: pre-wrap; min-height: 120px;"></div>
        </div>
        <div class="card-ui">
          <h5>ğŸ“Œ ä»Šæ—¥å®Œæˆæƒ…æ³</h5>
          <div id="reviewArea" class="mb-2"></div>
        </div>
        <div class="card-ui">
          <h5>ğŸ’¸ æˆæœ¬åˆ†æå›é¥‹</h5>
          <div id="costResult" class="text-danger" style="white-space: pre-wrap; min-height: 100px;"></div>
        </div>
        <div class="card-ui">
          <h5>ğŸ“ˆ ä»»å‹™å®Œæˆç‡çµ±è¨ˆ</h5>
          <canvas id="statChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const timeGrid = document.getElementById("timeGrid");
    const timeStart = 8 * 60, timeEnd = 22 * 60, interval = 30;

    for (let t = timeStart; t < timeEnd; t += interval) {
      const row = document.createElement("div");
      row.className = "time-row";
      const h = Math.floor(t / 60).toString().padStart(2, '0');
      const m = (t % 60).toString().padStart(2, '0');

      const label = document.createElement("div");
      label.className = "time-label align-self-center";
      label.textContent = `${h}:${m}`;

      const cell = document.createElement("div");
      cell.className = "time-cell";
      cell.dataset.time = `${h}:${m}`;
      cell.onclick = () => {
        if (cell.classList.contains("active")) {
          cell.classList.remove("active");
          cell.textContent = "";
        } else {
          const activity = prompt("è«‹è¼¸å…¥æ´»å‹•å…§å®¹ï¼š");
          if (activity) {
            cell.classList.add("active");
            const span = document.createElement("span");
            span.className = "cell-label";
            span.textContent = activity;
            cell.textContent = "";
            cell.appendChild(span);
            
          }
        }
      };
      

      row.appendChild(label);
      row.appendChild(cell);
      timeGrid.appendChild(row);
    }

    function reviewDay() {
      const reviewArea = document.getElementById("reviewArea");
      const activeCells = Array.from(document.querySelectorAll(".time-cell.active"));
      if (activeCells.length === 0) {
        alert("âš ï¸ å°šæœªå¡«å¯«ä»»ä½•ä»»å‹™ï¼");
        return;
      }
      reviewArea.innerHTML = activeCells.map((cell, i) => {
        const time = cell.dataset.time;
        const content = cell.textContent.trim();
        return `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="review${i}" data-time="${time}" data-content="${content}" checked>
          <label class="form-check-label" for="review${i}">${time} - ${content}</label>
        </div>`;
      }).join("");
    }

    async function analyzeByAI() {
      const resultBox = document.getElementById("aiResult");
      const activeCells = Array.from(document.querySelectorAll(".time-cell.active"));
      if (activeCells.length === 0) {
        resultBox.textContent = "âš ï¸ è«‹å…ˆå¡«å…¥ä¸€äº›è¡Œç¨‹å…§å®¹å†åˆ†æå–”ï¼";
        return;
      }
      const summary = activeCells.map(cell => `- ${cell.dataset.time} ${cell.textContent.trim()}`).join("\n");
      const prompt = `ä»¥ä¸‹æ˜¯æˆ‘çš„ä»Šæ—¥æ’ç¨‹ï¼š\n${summary}\n\nè«‹ä½ æª¢æŸ¥é€™æ¨£çš„æ™‚é–“åˆ†é…æ˜¯å¦åˆç†ï¼Œæœ‰æ²’æœ‰å®‰æ’éåº¦å¯†é›†ã€ç©ºæª”éé•·ã€ç¼ºä¹ä¼‘æ¯ç­‰å•é¡Œï¼Œä¸¦æä¾›å„ªåŒ–å»ºè­°ã€‚`;
      resultBox.textContent = "AI åˆ†æä¸­...";
      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        resultBox.textContent = data.result || "âš ï¸ æ²’æœ‰æ”¶åˆ° AI å›è¦†ï¼Œè«‹é‡è©¦ã€‚";

      } catch (err) {
        resultBox.textContent = "âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼ŒAI ç„¡æ³•å›è¦†ã€‚";
      }
    }

    async function submitReviewAndAnalyzeCost() {
      const checkboxes = Array.from(document.querySelectorAll('#reviewArea input[type="checkbox"]'));
      const incomplete = checkboxes.filter(cb => !cb.checked);
      const costBox = document.getElementById("costResult");

      if (incomplete.length === 0) {
        costBox.textContent = "âœ… ä»Šå¤©ä»»å‹™å…¨éƒ¨å®Œæˆï¼Œè®šè®šï¼";
        updateChart(checkboxes.length, 0);
        return;
      }

      const incompleteList = incomplete.map(cb => `- ${cb.dataset.time} ${cb.dataset.content}`);
      const prompt = `ä»¥ä¸‹æ˜¯æˆ‘ä»Šå¤©æ²’æœ‰å®Œæˆçš„ä»»å‹™ï¼š\n${incompleteList.join("\n")}\n\nè«‹ä½ æ¨ä¼°é€™äº›æœªå®Œæˆé …ç›®å¯èƒ½é€ æˆçš„æ™‚é–“èˆ‡é‡‘éŒ¢æˆæœ¬ï¼Œä»¥åŠå¦‚ä½•æ”¹å–„ï¼Œä¸¦çµ¦æˆ‘ä¸€é»äººæ€§åŒ–çš„é¼“å‹µæˆ–å»ºè­°ã€‚`;

      costBox.textContent = "AI åˆ†æä¸­...";

      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });
        const data = await res.json();
        costBox.textContent = data.result || "âš ï¸ æ²’æœ‰æ”¶åˆ° AI å›è¦†ã€‚";

      } catch (err) {
        costBox.textContent = "âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼ŒAI ç„¡æ³•å›è¦†ã€‚";
      }

      updateChart(checkboxes.length, incomplete.length);
    }

    function updateChart(total, uncompleted) {
      const completed = total - uncompleted;
      const ctx = document.getElementById('statChart').getContext('2d');
      if (window.taskChart) window.taskChart.destroy();
      window.taskChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['å®Œæˆ', 'æœªå®Œæˆ'],
          datasets: [{
            data: [completed, uncompleted],
            backgroundColor: ['#198754', '#dc3545']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
  </script>

   
          </div>
        </div>
      </div>
    </section>
    <script src="cr-achievements.js"></script><script src="cr-bootstrap.js"></script>
  <!-- âŒ› æ™‚é–“å·¥å…·ï¼šæµ®å‹•æŒ‰éˆ• -->
<div id="tools-toggle" class="tools-btn">âŒ› æ™‚é–“å·¥å…·</div>

<!-- âŒ› æ™‚é–“å·¥å…·ï¼šå·¦å´é¢æ¿ -->
<aside id="tools-panel" class="tools-panel">
  <div class="tools-head">
    <div class="tools-title">æ™‚é–“å·¥å…·</div>
    <button id="tools-close" class="tools-close">âœ•</button>
  </div>

  <div class="tools-tabs">
    <button class="tools-tab is-active" data-tab="pomodoro">è•ƒèŒ„æ™‚é˜</button>
    <button class="tools-tab" data-tab="countdown">å€’æ•¸</button>
    <button class="tools-tab" data-tab="stopwatch">ç¢¼éŒ¶</button>
  </div>

  <!-- è•ƒèŒ„æ™‚é˜ -->
  <section class="tools-pane" id="pane-pomodoro" style="display:block;">
    <div class="tools-row">
      <label>å°ˆæ³¨(åˆ†)</label><input id="pomo-focus" type="number" min="1" value="25">
      <label>ä¼‘æ¯(åˆ†)</label><input id="pomo-break" type="number" min="1" value="5">
      <label>é•·ä¼‘(åˆ†)</label><input id="pomo-long" type="number" min="1" value="15">
      <label>å¾ªç’°</label><input id="pomo-rounds" type="number" min="1" value="4">
    </div>
    <div class="tools-timer" id="pomo-display">25:00</div>
    <div class="tools-actions">
      <button id="pomo-start" class="tools-btn-primary">é–‹å§‹</button>
      <button id="pomo-pause">æš«åœ</button>
      <button id="pomo-reset">é‡è¨­</button>
      <button id="pomo-skip">è·³ééšæ®µ</button>
      <label class="tools-inline"><input id="pomo-autonext" type="checkbox" checked> è‡ªå‹•é€²ä¸‹ä¸€éšæ®µ</label>
    </div>
    <div class="tools-sub">æ¨¡å¼ï¼š<span id="pomo-mode">å°ˆæ³¨</span>ï½œå®Œæˆå¾ªç’°ï¼š<span id="pomo-done">0</span></div>
    <div class="tools-sub">ä»Šæ—¥å®Œæˆç•ªèŒ„æ•¸ï¼š<span id="pomo-today">0</span></div>
  </section>

  <!-- å€’æ•¸ -->
  <section class="tools-pane" id="pane-countdown">
    <div class="tools-row">
      <label>å€’æ•¸åˆ†é˜</label><input id="cd-min" type="number" min="0" value="10">
      <label>ç§’</label><input id="cd-sec" type="number" min="0" max="59" value="0">
    </div>
    <div class="tools-timer" id="cd-display">10:00</div>
    <div class="tools-actions">
      <button id="cd-start" class="tools-btn-primary">é–‹å§‹</button>
      <button id="cd-pause">æš«åœ</button>
      <button id="cd-reset">é‡è¨­</button>
    </div>
  </section>

  <!-- ç¢¼éŒ¶ -->
  <section class="tools-pane" id="pane-stopwatch">
    <div class="tools-timer" id="sw-display">00:00.0</div>
    <div class="tools-actions">
      <button id="sw-start" class="tools-btn-primary">é–‹å§‹</button>
      <button id="sw-lap">åœˆæ•¸</button>
      <button id="sw-pause">æš«åœ</button>
      <button id="sw-reset">é‡è¨­</button>
    </div>
    <ol id="sw-laps" class="tools-laps"></ol>
  </section>
</aside>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // âœ… å’Œç™»å…¥é åŒä¸€çµ„å°ˆæ¡ˆåƒæ•¸ï¼ˆä½ å¯ä»¥ç›´æ¥æ²¿ç”¨é€™å…©å€‹ï¼‰
  const SUPABASE_URL = "https://rbtevdmunkjjevoeooli.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJidGV2ZG11bmtqamV2b2Vvb2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNzMxMjIsImV4cCI6MjA3NTg0OTEyMn0.XjWId9AynP3TrJJEKIXZcsvmAW4kHLgH4dGDGqBH9dw";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ä½ ç›®å‰æœ¬æ©Ÿé€²åº¦ç”¨çš„ keyï¼ˆcr-achievements.js å·²åœ¨ç”¨ï¼‰
  const LS_KEY = "crProgressV1";

  // æ²’ç™»å…¥å°±å°å›ç™»å…¥é ï¼ˆæ”¾ä½ çš„ GitHub Pages ç™»å…¥æª”ç¶²å€ï¼‰
  const LOGIN_PAGE = "https://pengdoucheng.github.io/supabase-test.html";

  // --- å•Ÿå‹•ï¼šæª¢æŸ¥ç™»å…¥ï¼ŒçŒé›²ç«¯è³‡æ–™ï¼Œç¶å®šåŒæ­¥ ---
  document.addEventListener("DOMContentLoaded", async () => {
    const { data } = await sb.auth.getUser();
    const user = data.user;
    if (!user) {
      alert("è«‹å…ˆç™»å…¥");
      window.location.href = LOGIN_PAGE;
      return;
    }

    // 1) å…ˆæŠŠé›²ç«¯çš„é€²åº¦çŒå›æœ¬æ©Ÿï¼ˆè‹¥æœ‰ï¼‰
    const hadCloud = await hydrateFromCloud(user);

    // 2) å¦‚æœé›²ç«¯æ²’æœ‰ï¼Œè€Œæœ¬æ©Ÿæœ‰èˆŠè³‡æ–™ â†’ ä¸»å‹•ä¸Šå‚³ä¸€æ¬¡ï¼Œå»ºç«‹ç¬¬ä¸€ä»½é›²ç«¯å‚™ä»½
    if (!hadCloud) {
      const local = safeParse(localStorage.getItem(LS_KEY));
      if (local) {
        await upsertProgress(user, local);
      }
    }

    // 3) ç›£è½ä½ åŸæœ¬ç¨‹å¼æ¯æ¬¡æ›´æ–°é€²åº¦æ™‚æ‹‹å‡ºçš„äº‹ä»¶ â†’ ä¸Šå‚³åˆ°é›²ç«¯
    attachCloudSync(user);
  });

  // ä¸‹è¼‰é›²ç«¯ â†’ çŒæœ¬æ©Ÿï¼ˆæˆåŠŸå›å‚³ trueï¼Œå¦å‰‡ falseï¼‰
  async function hydrateFromCloud(user){
    try {
      const { data, error } = await sb.from("cr_progress")
        .select("progress, updated_at")
        .eq("user_id", user.id)
        .maybeSingle();
      if (error) throw error;
      if (!data || !data.progress) return false;

      // å¦‚æœä½ æœªå­˜æœ¬æ©Ÿæˆ–é›²ç«¯è¼ƒæ–° â†’ è¦†è“‹æœ¬æ©Ÿ
      const local = safeParse(localStorage.getItem(LS_KEY));
      const cloudNewer = newer(data.updated_at, local?.updated_at);
      if (!local || cloudNewer) {
        localStorage.setItem(LS_KEY, JSON.stringify(data.progress));
        // é€šçŸ¥ç¾æœ‰ UI é‡ç®—/é‡ç•«ï¼ˆä½ åŸæœ¬ç¨‹å¼æœ‰åœ¨è½é€™å€‹äº‹ä»¶ï¼‰
        try {
          window.dispatchEvent(new CustomEvent("cr:progress-updated", { detail: data.progress }));
        } catch {}
      }
      return true;
    } catch (e) {
      console.warn("è®€å–é›²ç«¯é€²åº¦å¤±æ•—ï¼š", e);
      return false;
    }
  }

  function newer(cloudTs, localTs){
    if (!cloudTs) return false;
    if (!localTs) return true;
    return new Date(cloudTs).getTime() > new Date(localTs).getTime();
  }

  function safeParse(s){ try { return JSON.parse(s || ""); } catch { return null; } }

  async function upsertProgress(user, progress){
    try {
      // ä½ æœ¬æ©Ÿ JSON è‹¥æ²’æœ‰ updated_atï¼Œæˆ‘å€‘åœ¨é€™è£¡è£œä¸€å€‹æ™‚é–“æˆ³
      if (typeof progress === "object" && progress) {
        if (!progress.updated_at) progress.updated_at = new Date().toISOString();
      }
      const { error } = await sb.from("cr_progress").upsert({
        user_id: user.id,
        progress,
        updated_at: new Date().toISOString()
      });
      if (error) throw error;
      // console.log("âœ… å·²åŒæ­¥é›²ç«¯");
    } catch (e) {
      console.warn("åŒæ­¥é›²ç«¯å¤±æ•—ï¼š", e);
    }
  }

  function attachCloudSync(user){
    // ä½ çš„ cr-achievements.js æ¯æ¬¡å„²å­˜å¾Œæœƒä¸Ÿå‡ºé€™å€‹äº‹ä»¶
    window.addEventListener("cr:progress-updated", async (ev) => {
      const progress = ev?.detail || safeParse(localStorage.getItem(LS_KEY)) || {};
      await upsertProgress(user, progress);
    });
  }
</script>

<script>
  // è‹¥å‰é¢å·²æœ‰ sbã€getUser()ï¼Œå¯åˆªé€™å…©å€‹é‡è¤‡çš„å¯¦ä½œ
  // const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  async function getUser(){ return (await sb.auth.getUser()).data.user || null; }

  // æ™‚é–“å·¥å…·ï¼šå­—ä¸²<->åˆ†é˜
  function toMin(hhmm){ const [h,m]=hhmm.split(":").map(Number); return h*60 + (m||0); }
  function toHHMM(min){ const h=Math.floor(min/60), m=min%60; return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`; }
  function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }

  // CRUD å°è£
  async function addSchedule({ date, startHHMM, endHHMM, title }){
    const u = await getUser(); if(!u) throw new Error("å°šæœªç™»å…¥");
    const start_min = toMin(startHHMM), end_min = toMin(endHHMM);
    if (end_min <= start_min) throw new Error("çµæŸæ™‚é–“éœ€å¤§æ–¼é–‹å§‹æ™‚é–“");
    const { data, error } = await sb.from("schedules").insert([{
      user_id: u.id, date, start_min, end_min, title
    }]).select().single();
    if (error) throw error;
    return data;
  }

  async function loadSchedulesByDate(date){
    const u = await getUser(); if(!u) throw new Error("å°šæœªç™»å…¥");
    const { data, error } = await sb.from("schedules")
      .select("*")
      .eq("user_id", u.id)
      .eq("date", date)
      .order("start_min", { ascending: true });
    if (error) throw error;
    return data;
  }

  async function updateSchedule(id, patch){ // patch: { startHHMM?, endHHMM?, title? }
    const upd = {};
    if (patch.startHHMM) upd.start_min = toMin(patch.startHHMM);
    if (patch.endHHMM)   upd.end_min   = toMin(patch.endHHMM);
    if (patch.title != null) upd.title = patch.title;
    upd.updated_at = new Date().toISOString();
    const { data, error } = await sb.from("schedules").update(upd).eq("id", id).select().single();
    if (error) throw error;
    return data;
  }

  async function deleteSchedule(id){
    const { error } = await sb.from("schedules").delete().eq("id", id);
    if (error) throw error;
  }

  // è‡¨æ™‚é¢æ¿çš„ UI ç¶å®šï¼ˆé©—è­‰ç”¨ï¼‰
  document.addEventListener("DOMContentLoaded", async () => {
    const user = await getUser();
    if (!user) return; // ä½ å‰é¢çš„ç™»å…¥æª¢æŸ¥æœƒå°å›ç™»å…¥é 

    const $date = document.querySelector("#sch-date");
    const $start = document.querySelector("#sch-start");
    const $end = document.querySelector("#sch-end");
    const $title = document.querySelector("#sch-title");
    const $add = document.querySelector("#sch-add");
    const $reload = document.querySelector("#sch-reload");
    const $list = document.querySelector("#sch-list");

    if ($date) $date.value = todayStr();

    async function render(){
      if (!$date) return;
      const rows = await loadSchedulesByDate($date.value);
      $list.innerHTML = rows.map(r => `
        <li style="display:flex;gap:8px;align-items:center;border:1px solid #eee;border-radius:8px;padding:8px 12px">
          <b>${r.title}</b>
          <span style="color:#666">${toHHMM(r.start_min)}â€“${toHHMM(r.end_min)}</span>
          <span style="margin-left:auto;display:flex;gap:6px">
            <button data-id="${r.id}" class="sch-edit">ç·¨è¼¯</button>
            <button data-id="${r.id}" class="sch-del">åˆªé™¤</button>
          </span>
        </li>
      `).join(rows.length ? "" : "<li style='color:#666'>é€™å¤©é‚„æ²’æœ‰æ’ç¨‹</li>");
    }

    if ($add) $add.addEventListener("click", async () => {
      try{
        const row = await addSchedule({
          date: $date.value,
          startHHMM: $start.value,
          endHHMM: $end.value,
          title: $title.value.trim() || "æœªå‘½å"
        });
        $title.value = "";
        await render();
      }catch(e){ alert(e.message || e); }
    });

    if ($reload) $reload.addEventListener("click", render);

    // åˆªé™¤ / ç·¨è¼¯ï¼ˆç°¡å–®ç¤ºä¾‹ï¼‰
    if ($list) $list.addEventListener("click", async (ev) => {
      const id = ev.target?.dataset?.id;
      if (!id) return;
      if (ev.target.classList.contains("sch-del")) {
        if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { await deleteSchedule(id); await render(); }
      } else if (ev.target.classList.contains("sch-edit")) {
        const newTitle = prompt("æ–°æ¨™é¡Œï¼Ÿï¼ˆç•™ç©ºä¸æ”¹ï¼‰");
        const newStart = prompt("æ–°é–‹å§‹æ™‚é–“ï¼Ÿ(HH:MMï¼Œç•™ç©ºä¸æ”¹)");
        const newEnd   = prompt("æ–°çµæŸæ™‚é–“ï¼Ÿ(HH:MMï¼Œç•™ç©ºä¸æ”¹)");
        try{
          await updateSchedule(id, {
            title: newTitle === "" ? undefined : newTitle,
            startHHMM: newStart || undefined,
            endHHMM: newEnd || undefined
          });
          await render();
        }catch(e){ alert(e.message || e); }
      }
    });

    // åˆæ¬¡è¼‰å…¥
    await render();

    // ï¼ˆå¯é¸ï¼‰Realtimeï¼šå¤šäºº/å¤šè£ç½®æ™‚è‡ªå‹•åˆ·æ–°
    sb.channel('schedules-rt')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'schedules' }, async () => {
        if (document.hasFocus()) await render();
      })
      .subscribe();
  });
</script>


<!-- è‡¨æ™‚ï¼šæ’ç¨‹é¢æ¿ï¼ˆå…ˆé©—è­‰åŠŸèƒ½ï¼Œä¹‹å¾Œå¯ç§»é™¤æˆ–æ›æˆä½ çš„æ™‚é–“æ ¼ UIï¼‰ -->
<section id="sched-dev-panel" style="margin:24px 0;padding:12px;border:1px solid #eee;border-radius:8px">
  <iframe src="cloud-sync-widget.html" style="width:100%;height:720px;border:0;border-radius:12px;overflow:hidden;"></iframe>

</section>
<style>
  /* ä½ çš„å·¥å…·åˆ—ï¼šæŠŠé¸æ“‡å™¨æ›æˆå¯¦éš›çš„é‚£å€‹ï¼ˆæ“‡ä¸€æˆ–éƒ½ä¿ç•™ï¼‰ */
  #tools-bar, .tools-toggle, .tools-tabs {
    position: sticky;      /* æˆ–æ”¹ fixedï¼›sticky é€šå¸¸é«”é©—è¼ƒä½³ */
    top: 0;
    z-index: 40;           /* ç¢ºä¿åœ¨ panes ä¹‹ä¸Š */
    background: var(--bg, #fff);
    border-bottom: 1px solid var(--line, #e6e7eb);
  }

  /* è®“æ¯å€‹ pane è‡ªå‹•é¿é–‹å·¥å…·åˆ—é«˜åº¦ */
  .tools-pane {
    position: relative;
    z-index: 1;
    margin-top: var(--tools-offset, 12px); /* ç”± JS å‹•æ…‹è¨­å®šé«˜åº¦ */
    scroll-margin-top: var(--tools-offset, 12px); /* æ»‘åˆ°éŒ¨é»æ™‚ä¹Ÿä¸è¢«è“‹ä½ */
  }

  /* æ©Ÿèƒ½åˆ—æ’ç‰ˆæ›´ç©©å®šï¼Œé¿å…æ“ æˆä¸€è¡Œé‡ç–Š */
  .tools-row,
  .tools-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;       /* å°è¢å¹•è‡ªå‹•æ›è¡Œ */
  }

  /* è¨ˆæ™‚å­—æ¨£å¤§å°èˆ‡é–“è·ï¼Œé¿å…ç¢°åˆ°ä¸Šç·£ */
  .tools-timer {
    font-variant-numeric: tabular-nums;
    letter-spacing: .5px;
    font-size: clamp(28px, 4vw, 40px);
    line-height: 1;
    margin: 8px 0 10px;
  }

  /* æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†çš„æœ€å°å°ºå¯¸ï¼Œé¿å…æ“ å£“ */
  .tools-actions button,
  .tools-row input[type="number"],
  .tools-row input[type="time"] {
    min-height: 36px;
  }
</style>

<script>
  (function () {
    // æ‰¾åˆ°ä½ çš„å·¥å…·åˆ—ï¼ˆæ“‡ä¸€å°±å¥½ï¼›ä¿ç•™å¤šå€‹é¸æ“‡å™¨ä»¥å¢åŠ ç›¸å®¹æ€§ï¼‰
    const bar = document.querySelector('#tools-bar, .tools-toggle, .tools-tabs');
    if (!bar) return;

    const setOffset = () => {
      // +12 æ˜¯å‘ä¸‹ç•™é»ç©ºç™½ï¼Œé¿å…è²¼å¾—å¤ªç·Š
      const h = bar.offsetHeight + 12;
      document.documentElement.style.setProperty('--tools-offset', h + 'px');
    };

    setOffset();
    // è¦–çª—æ”¹è®Šå°ºå¯¸ã€å­—é«”è¼‰å…¥ã€å·¥å…·åˆ—è¡Œæ•¸è®Šå‹•æ™‚æ›´æ–°
    window.addEventListener('resize', setOffset);
    // å¦‚æœå·¥å…·åˆ—å…§å®¹å‹•æ…‹å±•é–‹/æ”¶åˆï¼Œç›£è½é«˜åº¦è®ŠåŒ–
    const ro = new ResizeObserver(setOffset);
    ro.observe(bar);
  })();
</script>









  </body>
</html>



