<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>AI æ™‚é–“æ’ç¨‹èˆ‡æˆæœ¬åˆ†æ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body {
      background-color: #f2f4f7;
      font-family: 'Noto Sans TC', sans-serif;
      color: #333;
    }
    .container {
      max-width: 960px;
      margin: auto;
    }
    .card-ui {
      background-color: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      padding: 24px;
      margin-bottom: 24px;
      transition: all 0.2s ease-in-out;
    }
    .card-ui:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }
    .time-grid {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 4px;
    }
    .time-row {
      display: flex;
      gap: 4px;
    }
    .time-label {
      width: 80px;
      text-align: right;
      padding-right: 8px;
      color: #555;
    }
    .time-cell {
      flex: 1;
      background-color: #fff;
      border: 1px solid #ccc;
      min-height: 40px;
      cursor: pointer;
      position: relative;
      border-radius: 6px;
      transition: all 0.2s ease-in-out;
    }
    .time-cell.active {
      background-color: #e6f0ff;
      border-left: 4px solid #4a90e2;
    }
    .cell-label {
      position: absolute;
      top: 4px;
      left: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      color: #333;
    }
  </style>
<link href="cr-achievements.css" rel="stylesheet"/>\n<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><script>
// Supabase config (åŒç™»å…¥é )
const SUPABASE_URL = "https://rbtevdmunkjjevoeooli.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJidGV2ZG11bmtqamV2b2Vvb2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNzMxMjIsImV4cCI6MjA3NTg0OTEyMn0.XjWId9AynP3TrJJEKIXZcsvmAW4kHLgH4dGDGqBH9dw";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const LOGIN_PAGE = "https://pengdoucheng.github.io/supabase-test.html";

document.addEventListener("DOMContentLoaded", async () => {
  try{
    const { data } = await sb.auth.getUser();
    if (!data.user) {
      alert("è«‹å…ˆç™»å…¥");
      location.href = LOGIN_PAGE;
    } else {
      // å°‡ä½¿ç”¨è€… email é¡¯ç¤ºæ–¼ console æ–¹ä¾¿æª¢æŸ¥
      console.log("Signed in as:", data.user.email);
    }
  }catch(e){ console.warn(e); }
});
</script></head>
<body>
<!-- å·¦å´ç´€éŒ„é¢æ¿æŒ‰éˆ• -->
<div class="history-btn" id="history-toggle">ğŸ“… ç´€éŒ„</div>
<!-- å·¦å´ç´€éŒ„é¢æ¿ -->
<div class="history-panel" id="history-panel">
<div class="history-header">
<h3>ä»»å‹™å®Œæˆç´€éŒ„</h3>
<button id="close-history">âœ–</button>
</div>
<div class="history-mode">
<button data-mode="week">æœ¬é€±</button>
<button data-mode="month">æœ¬æœˆ</button>
</div>
<div class="history-summary" id="history-summary">
<p>å®Œæˆç‡ï¼š<span id="history-rate">0%</span></p>
</div>
<div class="history-days" id="history-days">
<!-- å‹•æ…‹æ’å…¥æ¯å¤©çš„ç´€éŒ„ -->
</div>
</div>
<!-- ===== ä½¿ç”¨è€…æ•™å­¸å°å¡ ===== -->
<div class="cr-onboard" id="crOnboarding">
<div class="cr-onboard-card">
<h2>ğŸ¯ æ­¡è¿ä¾†åˆ°è‡ªå¾‹æ§è‚‰é£¯ï¼</h2>
<p>é€™è£¡æœ‰ä¸‰å€‹å°æŠ€å·§ï¼Œå¹«åŠ©ä½ æ›´è‡ªå¾‹ï¼š</p>
<ol>
<li>âœ… <b>å®Œæˆä»»å‹™</b> â†’ è‡ªå‹•æ›´æ–°å®Œæˆç‡</li>
<li>ğŸ† <b>é€£çºŒå®Œæˆ</b> â†’ è§£é–æˆå°±å¾½ç« </li>
<li>ğŸ“… <b>è¨­å®šé€±ç›®æ¨™</b> â†’ å¹«åŠ©é¤Šæˆå¥½ç¿’æ…£</li>
</ol>
<button id="crOnboardBtn">é–‹å§‹æŒ‘æˆ° ğŸš€</button>
</div>
</div>
<nav class="navbar navbar-light bg-white shadow-sm mb-4">
<div class="container-fluid">
<span class="navbar-brand mb-0 h4">ğŸ§  è‡ªå¾‹æ§è‚‰é£¯ Â· æ™‚é–“ç®¡å®¶</span>
</div>
</nav>
<div class="container">
<div class="row">
<div class="col-md-6">
<div class="card-ui">
<h5>ğŸ“… ä»Šæ—¥ä»»å‹™æ’ç¨‹</h5>
<div class="time-grid" id="timeGrid"></div>
</div>
<div class="card-ui">
<h5>ğŸ¯ æœ¬é€±ç›®æ¨™è¨­å®š</h5>
<textarea class="form-control" id="goalInput" placeholder="è¼¸å…¥ä½ çš„æœ¬é€±ç›®æ¨™ï¼Œä¾‹å¦‚ï¼šé‹å‹•3æ¬¡ã€å®Œæˆå ±å‘Šã€é–±è®€ä¸€æœ¬æ›¸..." rows="4"></textarea>
</div>
<button class="btn btn-success w-100 mb-2" onclick="analyzeByAI()">ğŸ” åˆ†æç›®å‰æ’ç¨‹</button>
<button class="btn btn-outline-secondary w-100 mb-2" onclick="reviewDay()">ğŸ“Œ å¡«å¯«å®Œæˆæƒ…æ³</button>
<button class="btn btn-primary w-100" onclick="submitReviewAndAnalyzeCost()">ğŸ“Š åˆ†ææœªå®Œæˆæˆæœ¬</button>
</div>
<div class="col-md-6">
<div class="card-ui">
<h5>ğŸ¤– AI æ™‚é–“å»ºè­°</h5>
<div id="aiResult" style="white-space: pre-wrap; min-height: 120px;"></div>
</div>
<div class="card-ui">
<h5>ğŸ“Œ ä»Šæ—¥å®Œæˆæƒ…æ³</h5>
<div class="mb-2" id="reviewArea"></div>
</div>
<div class="card-ui">
<h5>ğŸ’¸ æˆæœ¬åˆ†æå›é¥‹</h5>
<div class="text-danger" id="costResult" style="white-space: pre-wrap; min-height: 100px;"></div>
</div>
<div class="card-ui">
<h5>ğŸ“ˆ ä»»å‹™å®Œæˆç‡çµ±è¨ˆ</h5>
<canvas height="200" id="statChart" width="400"></canvas>
</div>
</div>
</div>
</div>
<script>
// ======= æ™‚é–“æ ¼ + Supabase åŒæ­¥ =======
const timeGrid = document.getElementById("timeGrid");
const timeStart = 8 * 60, timeEnd = 22 * 60, interval = 30;
const todayStr = () => new Date().toISOString().slice(0,10);
let currentDate = todayStr();

function toHHMM(min){ const h=String(Math.floor(min/60)).padStart(2,'0'); const m=String(min%60).padStart(2,'0'); return `${h}:${m}`; }

async function getUser(){ return (await sb.auth.getUser()).data.user; }

async function addSchedule({ date, start_min, end_min, title }){
  const u = await getUser(); if(!u) throw new Error("æœªç™»å…¥");
  const { data, error } = await sb.from("schedules").insert([{ user_id:u.id, date, start_min, end_min, title }]).select("*").single();
  if (error) throw error;
  return data;
}
async function loadSchedulesByDate(dateStr){
  const u = await getUser(); if(!u) return [];
  const { data, error } = await sb.from("schedules").select("*").eq("user_id", u.id).eq("date", dateStr).order("start_min", { ascending:true });
  if (error) throw error;
  return data || [];
}
async function updateSchedule(id, patch){
  const { error } = await sb.from("schedules").update(patch).eq("id", id);
  if (error) throw error;
}
async function deleteSchedule(id){
  const { error } = await sb.from("schedules").delete().eq("id", id);
  if (error) throw error;
}

// Build grid
function buildGrid(){
  timeGrid.innerHTML = "";
  for (let t = timeStart; t < timeEnd; t += interval){
    const row = document.createElement("div"); row.className="time-row";
    const label = document.createElement("div"); label.className="time-label align-self-center"; label.textContent=toHHMM(t);
    const cell  = document.createElement("div"); cell.className="time-cell"; cell.dataset.startMin=t; cell.dataset.endMin=t+interval;

    cell.onclick = async () => {
      try{
        if (cell.classList.contains("active") && cell.dataset.id){
          await deleteSchedule(cell.dataset.id);
          cell.classList.remove("active"); cell.textContent=""; delete cell.dataset.id;
          await updateChecksum();
          return;
        }
        const activity = prompt("è«‹è¼¸å…¥æ´»å‹•å…§å®¹ï¼š");
        if (!activity) return;
        const row = await addSchedule({ date: currentDate, start_min: Number(cell.dataset.startMin), end_min: Number(cell.dataset.endMin), title: activity });
        cell.classList.add("active"); cell.dataset.id=row.id; cell.textContent=""; const span=document.createElement("span"); span.className="cell-label"; span.textContent=activity; cell.appendChild(span);
        await updateChecksum();
      }catch(e){ alert(e.message||"æ“ä½œå¤±æ•—"); console.error(e); }
    };

    row.appendChild(label); row.appendChild(cell); timeGrid.appendChild(row);
  }
}

// Render a date
async function renderDay(dateStr){
  currentDate = dateStr;
  buildGrid();
  const rows = await loadSchedulesByDate(dateStr);
  const cells = Array.from(document.querySelectorAll(".time-cell"));

  rows.forEach(r => {
    const cell = cells.find(c => Number(c.dataset.startMin)===r.start_min && Number(c.dataset.endMin)===r.end_min);
    if (!cell) return;
    cell.classList.add("active"); cell.dataset.id=r.id; cell.textContent=""; const span=document.createElement("span"); span.className="cell-label"; span.textContent=r.title; cell.appendChild(span);
  });
  await updateChecksum(rows);
}

// ä»Šæ—¥æ’ç¨‹ checksumï¼Œé¡¯ç¤ºåœ¨å³ä¸‹è§’ï¼Œä¹ŸåŒæ­¥åˆ° cr_progress æ–¹ä¾¿è·¨è£ç½®æ¯”å°
async function updateChecksum(preloadedRows){
  try {
    const rows = preloadedRows || await loadSchedulesByDate(todayStr());
    const keyRows = rows
      .filter(r => r.date === todayStr())
      .map(r => ({s:r.start_min,e:r.end_min,t:r.title}))
      .sort((a,b)=> a.s-b.s || a.e-b.e || a.t.localeCompare(b.t));
    const json = JSON.stringify(keyRows);
    const digest = await sha1(json);
    localStorage.setItem("schedTodayChecksum", digest);
    const badge = document.getElementById("syncBadge");
    badge.textContent = `ä»Šæ—¥æ’ç¨‹ç°½ç« ï¼š${digest.slice(0,8)}ï¼ˆ${keyRows.length} ç­†ï¼‰`;

    // upsert åˆ° cr_progress.progress.sched_today_checksum
    const u = await getUser(); if (!u) return;
    const { error } = await sb.from("cr_progress").upsert({
      user_id: u.id,
      progress: { sched_today_checksum: digest },
      updated_at: new Date().toISOString()
    });
    if (error) console.warn("upsert checksum failed", error);
  } catch (e) {
    console.warn("checksum error", e);
  }
}

// å°å·¥å…·ï¼šSHA-1ï¼ˆç€è¦½å™¨ç‰ˆï¼‰
async function sha1(message){
  const msgUint8 = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-1', msgUint8);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return hashHex;
}

document.addEventListener("DOMContentLoaded", () => {
  renderDay(todayStr());
});
</script>
<section class="cr-card" style="margin:24px 0;">
<div class="cr-title">æœ¬æœˆå®Œæˆç‡</div>
<div class="cr-sub">ä»¥æœ¬æœˆå·²å»ºç«‹çš„ä»»å‹™ç‚ºåŸºç¤è¨ˆç®—ï¼Œå®Œæˆè¶Šå¤šè¶Šäº®çœ¼ã€‚</div>
<div class="cr-progress">
<div class="cr-progress-bar cr-gradient" data-cr-progress-bar=""></div>
</div>
<div class="cr-sub" style="margin-top:8px;">ç›®å‰ï¼š<span data-cr-progress-label="">0%</span>ï½œé€£çºŒå®Œæˆï¼š<span data-cr-streak="">0 å¤©</span></div>
<div class="cr-grid" style="margin-top:16px;">
<div>
<div class="cr-title" style="font-size:16px;">æˆå°±å¾½ç« </div>
<div class="cr-badges" data-cr-badges=""></div>
</div>
<div>
<div class="cr-title" style="font-size:16px;">æœ¬é€±ç›®æ¨™</div>
<ul class="cr-goals" data-cr-goals=""></ul>
<div class="cr-actions" style="margin-top:10px;">
<button class="cr-btn" id="crSetWeeklyGoals">è¨­å®šæœ¬é€±ç›®æ¨™</button>
<button class="cr-btn" id="crQuickDone">å¿«é€Ÿ+1ï¼ˆæ¸¬è©¦ï¼‰</button>
</div>
</div>
</div>
</section>
    \n<script src="cr-achievements.js"></script>\n<script src="cr-bootstrap.js"></script>\n
  <!-- âŒ› æ™‚é–“å·¥å…·ï¼šæµ®å‹•æŒ‰éˆ• -->
<div class="tools-btn" id="tools-toggle">âŒ› æ™‚é–“å·¥å…·</div>
<!-- âŒ› æ™‚é–“å·¥å…·ï¼šå·¦å´é¢æ¿ -->
<aside class="tools-panel" id="tools-panel">
<div class="tools-head">
<div class="tools-title">æ™‚é–“å·¥å…·</div>
<button class="tools-close" id="tools-close">âœ•</button>
</div>
<div class="tools-tabs">
<button class="tools-tab is-active" data-tab="pomodoro">è•ƒèŒ„æ™‚é˜</button>
<button class="tools-tab" data-tab="countdown">å€’æ•¸</button>
<button class="tools-tab" data-tab="stopwatch">ç¢¼éŒ¶</button>
</div>
<!-- è•ƒèŒ„æ™‚é˜ -->
<section class="tools-pane" id="pane-pomodoro" style="display:block;">
<div class="tools-row">
<label>å°ˆæ³¨(åˆ†)</label><input id="pomo-focus" min="1" type="number" value="25"/>
<label>ä¼‘æ¯(åˆ†)</label><input id="pomo-break" min="1" type="number" value="5"/>
<label>é•·ä¼‘(åˆ†)</label><input id="pomo-long" min="1" type="number" value="15"/>
<label>å¾ªç’°</label><input id="pomo-rounds" min="1" type="number" value="4"/>
</div>
<div class="tools-timer" id="pomo-display">25:00</div>
<div class="tools-actions">
<button class="tools-btn-primary" id="pomo-start">é–‹å§‹</button>
<button id="pomo-pause">æš«åœ</button>
<button id="pomo-reset">é‡è¨­</button>
<button id="pomo-skip">è·³ééšæ®µ</button>
<label class="tools-inline"><input checked="" id="pomo-autonext" type="checkbox"/> è‡ªå‹•é€²ä¸‹ä¸€éšæ®µ</label>
</div>
<div class="tools-sub">æ¨¡å¼ï¼š<span id="pomo-mode">å°ˆæ³¨</span>ï½œå®Œæˆå¾ªç’°ï¼š<span id="pomo-done">0</span></div>
<div class="tools-sub">ä»Šæ—¥å®Œæˆç•ªèŒ„æ•¸ï¼š<span id="pomo-today">0</span></div>
</section>
<!-- å€’æ•¸ -->
<section class="tools-pane" id="pane-countdown">
<div class="tools-row">
<label>å€’æ•¸åˆ†é˜</label><input id="cd-min" min="0" type="number" value="10"/>
<label>ç§’</label><input id="cd-sec" max="59" min="0" type="number" value="0"/>
</div>
<div class="tools-timer" id="cd-display">10:00</div>
<div class="tools-actions">
<button class="tools-btn-primary" id="cd-start">é–‹å§‹</button>
<button id="cd-pause">æš«åœ</button>
<button id="cd-reset">é‡è¨­</button>
</div>
</section>
<!-- ç¢¼éŒ¶ -->
<section class="tools-pane" id="pane-stopwatch">
<div class="tools-timer" id="sw-display">00:00.0</div>
<div class="tools-actions">
<button class="tools-btn-primary" id="sw-start">é–‹å§‹</button>
<button id="sw-lap">åœˆæ•¸</button>
<button id="sw-pause">æš«åœ</button>
<button id="sw-reset">é‡è¨­</button>
</div>
<ol class="tools-laps" id="sw-laps"></ol>
</section>
</aside>
<div id="syncBadge" style="position:fixed; right:12px; bottom:12px; background:#f8f9fa; border:1px solid #e5e7eb; padding:6px 10px; border-radius:8px; font:12px/1.2 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#111827; z-index:9999; box-shadow:0 2px 6px rgba(0,0,0,.05);">é›²ç«¯åŒæ­¥ç‹€æ…‹ï¼šè¼‰å…¥ä¸­â€¦</div></body>
</html>



