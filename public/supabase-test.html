<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>自律控肉飯 · 帳號登入</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#ffffff;
      --bg-soft:#fdf2f2;
      --card:#ffffff;
      --text:#111111;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#e31b23;
      --accent-dark:#b91c1c;
      --border-strong:#111111;
      --radius:16px;
      --shadow:0 16px 40px rgba(15,23,42,.12);
      --font: system-ui, -apple-system, "SF Pro TC", "PingFang TC",
              "Noto Sans TC", "Microsoft JhengHei", Inter, sans-serif;
    }

    *{ box-sizing:border-box; }

    html, body{ height:100%; }

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:var(--bg);
      display:grid;
      place-items:center;
      padding:24px;
    }

    .wrap{
      width:min(100%, 980px);
      background:var(--bg-soft);
      border-radius:24px;
      box-shadow:var(--shadow);
      border:2px solid #111111;
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      overflow:hidden;
    }
    @media (max-width: 900px){
      .wrap{
        grid-template-columns:1fr;
        border-radius:18px;
      }
    }

    /* 左側：品牌＋敘述 */
    .hero{
      position:relative;
      padding:28px 28px 22px;
      background:var(--bg-soft);
      border-right:2px solid #111111;
    }
    @media (max-width: 900px){
      .hero{
        border-right:none;
        border-bottom:2px solid #111111;
      }
    }

    /* 左側紅黑線條裝飾 */
    .hero::before,
    .hero::after{
      content:"";
      position:absolute;
      left:22px;
      right:22px;
      height:2px;
      background:#111111;
      opacity:.16;
    }
    .hero::before{ top:18px; }
    .hero::after{ bottom:18px; }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size:12px;
    }
    .mark{
      width:34px;
      height:34px;
      border-radius:999px;
      border:2px solid #111111;
      background:
        radial-gradient(circle at 30% 30%, #ffffff 0, #ffffff 36%, transparent 38%),
        linear-gradient(135deg, #111111, var(--accent));
      box-shadow:0 0 0 4px #fee2e2;
    }
    .brand-sub{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:none;
    }

    h1{
      margin:16px 0 6px;
      font-size: clamp(22px, 3vw, 28px);
      line-height:1.25;
    }
    .hero-em{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #111111;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      margin-bottom:6px;
    }
    .muted{
      color:var(--muted);
      font-size:14px;
      max-width:340px;
      line-height:1.7;
    }

    .bullets{
      margin:18px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:10px;
    }
    .bullets li{
      display:flex;
      gap:10px;
      align-items:flex-start;
      font-size:13px;
      color:#374151;
    }
    .dot{
      width:9px;
      height:9px;
      border-radius:50%;
      border:2px solid #111111;
      background:var(--accent);
      margin-top:.4em;
    }

    .hero-footer{
      margin-top:22px;
      font-size:11px;
      color:#6b7280;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .hero-pill{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #111111;
      background:#111111;
      color:#fff;
      font-size:10px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    /* 右側：登入卡片 */
    .card{
      background:var(--card);
      padding:26px 26px 22px;
      position:relative;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:18px 22px auto 22px;
      border-top:1px solid #fee2e2;
      pointer-events:none;
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    .h2{
      margin:0 0 4px;
      font-size:18px;
      font-weight:800;
    }
    .desc{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    .badge-env{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #111111;
      background:#fee2e2;
      color:#991b1b;
      font-weight:600;
    }

    label{
      display:block;
      font-size:13px;
      color:#374151;
      margin:10px 0 6px;
    }
    .ctl{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:12px;
      padding:11px 13px;
      display:flex;
      align-items:center;
      gap:8px;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .ctl:focus-within{
      border-color:#fecaca;
      box-shadow:0 0 0 2px rgba(248,113,113,.25);
    }
    input[type="email"],
    input[type="password"]{
      width:100%;
      border:0;
      outline:0;
      font-size:15px;
      background:transparent;
      color:var(--text);
    }

    .row{ display:grid; gap:12px; }

    .actions{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
    .stack{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .stack{ grid-template-columns:1fr; }
    }

    .btn{
      appearance:none;
      border-radius:999px;
      padding:11px 14px;
      font-size:14px;
      font-weight:800;
      cursor:pointer;
      border:1px solid transparent;
      display:inline-flex;
      justify-content:center;
      align-items:center;
      gap:6px;
      transition:background .15s ease, color .15s ease,
                 border-color .15s ease, transform .02s ease;
    }
    .btn:active{ transform:translateY(1px); }

    .btn-primary{
      background:var(--accent);
      color:#fff;
      border-color:#111111;
      box-shadow:0 10px 30px rgba(220,38,38,.45);
    }
    .btn-primary:hover{
      background:var(--accent-dark);
    }

    .btn-outline{
      background:#fff;
      color:#111111;
      border-color:#111111;
    }
    .btn-outline:hover{
      background:#111111;
      color:#fff;
    }

    .btn-ghost{
      background:#fff;
      color:#111111;
      border-color:#e5e7eb;
    }
    .btn-ghost:hover{
      border-color:#111111;
    }

    .hint{
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .who{
      color:var(--muted);
      font-size:13px;
    }

    .bar{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .ipt{ flex:1; }
    .list{
      list-style:none;
      padding:0;
      margin:12px 0 0;
      display:grid;
      gap:8px;
    }
    .item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:9px 11px;
      background:#fff;
    }
    .item label{
      margin:0;
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
    }
    .item .del{
      border-color:#e5e7eb;
      background:#fff;
      color:#991b1b;
    }
    .item .del:hover{
      border-color:#fecaca;
      background:#fef2f2;
    }

    .empty{
      color:var(--muted);
      font-size:13px;
      margin-top:6px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 左側：說明區 -->
    <aside class="hero">
      <div class="hero-em">ZILV · ACCOUNT</div>
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <div>自律控肉飯</div>
          <div class="brand-sub">TIME · DISCIPLINE · DASHBOARD</div>
        </div>
      </div>

      <h1>登入你的自律帳號，<br>把時間交給你自己。</h1>
      <p class="muted">
        一組帳號，串起時間工具、AI 排程、社群牆和任務紀錄。從今天開始，讓你的每一小時都有去處。
      </p>

      <ul class="bullets">
        <li><span class="dot"></span><span>記錄一個月的行程與專注時數，追蹤自己的節奏。</span></li>
        <li><span class="dot"></span><span>用 AI 排程工具，把雜亂代辦變成真的做得完的時間表。</span></li>
        <li><span class="dot"></span><span>在社群牆分享心得、按讚、留言，讓自律不只是一個人。</span></li>
      </ul>

      <div class="hero-footer">
        <span class="hero-pill">BETA</span>
        <span>目前為測試版，資料會儲存在 Supabase 雲端。</span>
      </div>
    </aside>

    <!-- 右側：登入區 -->
    <main class="card">
      <div class="card-header">
        <div>
          <h2 class="h2">登入 / 建立帳號</h2>
          <p class="desc">輸入 Email + 密碼 或使用 Google，登入後會回到你剛剛的頁面。</p>
        </div>
        <span class="badge-env">SUPABASE · AUTH</span>
      </div>

      <!-- Auth 表單 -->
      <section id="auth" style="display:block">
        <div class="row">
          <div>
            <label for="email">電子郵件</label>
            <div class="ctl">
              <input id="email" type="email" placeholder="you@example.com" autocomplete="email">
            </div>
          </div>
          <div>
            <label for="password">密碼</label>
            <div class="ctl">
              <input id="password" type="password" placeholder="至少 6 碼" autocomplete="current-password">
            </div>
          </div>
        </div>

        <div class="actions">
          <div class="stack">
            <button class="btn btn-outline" onclick="register()">註冊新帳號</button>
            <button class="btn btn-primary" onclick="login()">登入</button>
          </div>
          <button class="btn btn-ghost" onclick="loginWithGoogle()">
            使用 Google 一鍵登入
          </button>
          <p class="hint">提醒：學校 / 工作的 Gmail，建議直接用 Google 登入，比較不容易忘記密碼。</p>
        </div>
      </section>

      <!-- (選擇性) 任務清單區：目前基本上不會用到，先保留 -->
      <section id="app" style="display:none">
        <div class="topbar">
          <h3 style="margin:0">任務清單（測試用）</h3>
          <div>
            <span class="who" id="who"></span>
            <button class="btn btn-outline" onclick="logout()">登出</button>
          </div>
        </div>

        <div class="bar">
          <div class="ctl ipt"><input id="newTitle" placeholder="輸入任務..." /></div>
          <button class="btn btn-primary" onclick="addTask()">新增</button>
        </div>

        <ul id="list" class="list"></ul>
        <p id="empty" class="empty"></p>
      </section>
    </main>
  </div>

  <script>
    // ------- Supabase 初始化 -------
    const SUPABASE_URL = "https://rbtevdmunkjjevoeooli.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJidGV2ZG11bmtqamV2b2Vvb2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNzMxMjIsImV4cCI6MjA3NTg0OTEyMn0.XjWId9AynP3TrJJEKIXZcsvmAW4kHLgH4dGDGqBH9dw";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 讀取 redirect 參數（例如 ?redirect=/community.html）
    const params   = new URLSearchParams(window.location.search);
    const redirect = params.get("redirect") || "/home.html";

    function resolveRedirect(urlPath){
      // 如果 redirect 已經是完整網址，就直接用
      if (/^https?:\/\//i.test(urlPath)) return urlPath;
      return window.location.origin + urlPath;
    }

    // ------- Auth 流程 -------
    async function register(){
      const email = emailInput().value.trim();
      const password = pwdInput().value.trim();
      if (!email || !password) return alert("請先輸入 Email 和密碼");

      const { error } = await sb.auth.signUp({ email, password });
      if (error) return alert(error.message);
      alert("註冊成功！請至信箱點擊驗證連結後再登入。");
    }

    async function login(){
      const email = emailInput().value.trim();
      const password = pwdInput().value.trim();
      if (!email || !password) return alert("請先輸入 Email 和密碼");

      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);

      // ✅ 登入成功 → 回到 redirect 指定頁面
      window.location.href = resolveRedirect(redirect);
    }

    async function logout(){
      await sb.auth.signOut();
      render();
    }

    async function user(){
      const { data } = await sb.auth.getUser();
      return data.user || null;
    }

    // ------- 任務 CRUD（原本就有，先保留） -------
    async function addTask(){
      const u = await user(); if(!u) return alert("請先登入");
      const title = document.querySelector("#newTitle").value.trim(); if(!title) return;
      const { error } = await sb.from("task").insert([{ user_id: u.id, title }]);
      if (error) return alert(error.message);
      document.querySelector("#newTitle").value = "";
      load();
    }

    async function toggle(id, done){
      const { error } = await sb.from("task").update({ done }).eq("id", id);
      if (error) return alert(error.message);
      load();
    }

    async function removeTask(id){
      const { error } = await sb.from("task").delete().eq("id", id);
      if (error) return alert(error.message);
      load();
    }

    async function load(){
      const u = await user(); if(!u) return;
      const { data, error } = await sb.from("task")
        .select("*").eq("user_id", u.id)
        .order("created_at", { ascending:false });

      if (error) return alert(error.message);
      const list  = document.querySelector("#list");
      const empty = document.querySelector("#empty");

      if (!data.length){
        list.innerHTML = "";
        empty.textContent = "目前沒有任務";
        return;
      }

      empty.textContent = "";
      list.innerHTML = data.map(t => `
        <li class="item">
          <label>
            <input type="checkbox" ${t.done ? "checked" : ""} onchange="toggle('${t.id}', this.checked)" />
            <span style="${t.done ? 'text-decoration:line-through;opacity:.6' : ''}">
              ${escapeHTML(t.title)}
            </span>
          </label>
          <button class="btn btn-outline del" onclick="removeTask('${t.id}')">刪除</button>
        </li>
      `).join("");
    }

    // ------- UI 狀態 & 自動導回 -------
    async function render(){
      const u = await user();

      // 如果已登入，而且有 redirect，就直接送回去，不留在登入頁
      if (u){
        window.location.href = resolveRedirect(redirect);
        return;
      }

      document.querySelector("#auth").style.display = "block";
      document.querySelector("#app").style.display  = "none";
    }

    sb.auth.onAuthStateChange(() => render());
    document.addEventListener("DOMContentLoaded", render);

    // ------- 小工具 -------
    function emailInput(){ return document.querySelector("#email"); }
    function pwdInput(){ return document.querySelector("#password"); }
    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, m =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
      ));
    }
  </script>

  <!-- Google OAuth 登入：也用 redirect 決定要回哪一頁 -->
  <script>
    async function loginWithGoogle(){
      const { error } = await sb.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: resolveRedirect(redirect)
        }
      });
      if (error) alert(error.message);
    }
  </script>
</body>
</html>

